\documentclass[12pt,a4paper,twoside,openright,BCOR10mm,headsepline,titlepage,abstracton,chapterprefix,final]{scrreprt}

\usepackage{ae}
\usepackage[ngerman, english]{babel}
%\usepackage{SIunits}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{xcolor}
\usepackage{setspace}
\usepackage{dsfont}

% load hyperref as the last package to avoid redefinitions of e.g. footnotes after hyperref invokation

\RequirePackage{ifpdf}  % flag for pdf or dvi backend
\ifpdf
  \usepackage[pdftex]{graphicx}
  \usepackage[pdftitle={RTFM on Imaging Theory and Basics of Optical Raytracing},%
              pdfsubject={},%
              pdfauthor={M. Esslinger, J. Hartung, U. Lippmann},%
              pdfkeywords={},%
              bookmarks=true,%
%              colorlinks=true,%
              urlcolor=blue,%
              pdfpagelayout=TwoColumnRight,%
              pdfpagemode=UseNone,%
              pdfstartview=Fit,%
	      pdfpagelabels,
              pdftex]{hyperref}
\else
  \usepackage[dvips]{graphicx}
  \usepackage[colorlinks=false,dvips]{hyperref}
\fi
%\DeclareGraphicsRule{.jpg}{eps}{.jpg}{`convert #1 eps:-}

\usepackage{ae}
%\usepackage[ngerman, english]{babel}

%\usepackage{SIunits}
\newcommand\elementarycharge{\textrm{e}}
\newcommand\sccm{\textrm{sccm}}
\newcommand\mbar{\milli\textrm{bar}}


\usepackage{amsmath}
%\usepackage{amssymb}
\usepackage{setspace}

%\widowpenalty = 1000


\newcommand*{\doi}[1]{\href{https://doi.org/\detokenize{#1}}{doi: \detokenize{#1}}}

\newcommand\Vector[1]{{\mathbf{#1}}}
%\newcommand\Vector[1]{{\vec{#1}}}

\newcommand\vacuum{0}

\newcommand\location{r}
\newcommand\Location{\Vector{r}}


\newcommand\wavenumber{k}
\newcommand\vacuumWavenumber{\wavenumber_{\vacuum}}
\newcommand\Wavevector{\Vector{\wavenumber}}

\newcommand\Nabla{\Vector{\nabla}}
\newcommand\Laplace{\Delta}
\newcommand\timederivative[1]{\dot{{#1}}}
\newcommand\Tensor[1]{\hat{#1}}
\newcommand\conjugate[1]{\overline{#1}}
\newcommand\transpose[1]{#1^{T}}
\newcommand\Norm[1]{\left| #1 \right|}
\newcommand{\ket}[1]{\left\vert{#1}\right\rangle}
\newcommand{\bra}[1]{\left\langle{#1}\right\vert}
\newcommand{\braket}[2]{\left\langle{#1}\vert{#2}\right\rangle}
\newcommand{\bracket}[1]{\left\langle{#1}\right\rangle}

\newcommand{\scpm}[2]{(#1\,\cdot\,#2)}

\newcommand\unittensor{\mathds{1}}

\newcommand\Greenfunction{\Tensor{G}}

\newcommand\scalarEfield{E}
\newcommand\scalarBfield{B}
\newcommand\scalarHfield{H}
\newcommand\scalarDfield{D}
\newcommand\Efield{\Vector{\scalarEfield}}
\newcommand\Bfield{\Vector{\scalarBfield}}
\newcommand\Hfield{\Vector{\scalarHfield}}
\newcommand\Dfield{\Vector{\scalarDfield}}

\newcommand\permeability{\Tensor{\scalarpermeability}}
\newcommand\vacuumpermeability{\scalarpermeability_{\vacuum}}
\newcommand\scalarpermeability{\mu}
\newcommand\scalarrelativepermeability{\mu_{rel}}
\newcommand\relativepermeability{\Tensor{\mu}_{rel}}

\newcommand\permittivity{\Tensor{\scalarpermittivity}}
\newcommand\vacuumpermittivity{\scalarpermittivity_{\vacuum}}
\newcommand\scalarrelativepermittivity{\epsilon}
\newcommand\relativepermittivity{\Tensor{\scalarrelativepermittivity}}
\newcommand\scalarpermittivity{\varepsilon}

\newcommand\conductivity{\Tensor{\sigma}}
\newcommand\susceptibility{\Tensor{\chi}}
\newcommand\currentdensity{\Vector{j}}
\newcommand\chargedensity{\rho}
\newcommand\PoyntingVector{\Vector{S}}

\newcommand\ordi{\text{ord}}
\newcommand\eo{\text{eo}}

\newcommand\materialone{I}
\newcommand\materialtwo{{II}}

\newcommand{\kpa}[1]{{\wavenumber_{\parallel#1}}}
\newcommand\tr{\text{tr}}

\newcommand{\timeavg}[1]{{\langle\,#1\,\rangle}}

\newcommand{\remark}[1]{{\color{red}$\blacksquare$}\footnote{{\color{red}#1}}}
\newcommand{\chk}[1]{\color{green}{$\checkmark$#1}}

\newcommand{\orderof}[1]{\mathcal{O}(#1)}

\newcommand\ppol{p}
\newcommand\spol{s}
\newcommand\normconst{N}

\newcommand\kilogram{\textrm{kg}}
\newcommand\meter{\textrm{m}}
\newcommand\second{\textrm{s}}
\newcommand\ampere{\textrm{A}}
\newcommand\volt{\textrm{V}}
\newcommand\watt{\textrm{W}}
\newcommand\tesla{\textrm{T}}

\newcommand\totald{\textrm{d}}
\newcommand\pilot{\textrm{pilot}}

\newcommand\im{\textrm{im}}
\newcommand\obj{\textrm{obj}}
\newcommand\tot{\textrm{tot}}


\begin{document}

\pagenumbering{roman}

\titlehead{ }
\subject{Pyrate -- Optical raytracing based on Python}
\title{Read This Fundamental Manual \\ on Imaging Theory and Basics of Optical Raytracing}
\author{M. Esslinger, J. Hartung, U. Lippmann}
\date{2014 - 2019}
\publishers{}
\maketitle

\onehalfspacing

\tableofcontents

\cleardoublepage

\pagenumbering{arabic}

\singlespacing

\section{Disclaimer}

This manual is licensed under the
Creative Commons Attribution-ShareAlike 4.0 International Public License
\textbf{(CC-BY-SA 4.0)}.
You should have received a \href{rtfm_license.html}{copy} of this license along with this manual.

You receive the manual ``\emph{as is}'', without warranty of any kind, either expressed or implied, 
including, but not limited to, the implied warranties of merchantability and fitness for a particular purpose.
There is no warranty for accuracy, absence of errors, or any relation between real world objects and simulations made 
using this manual or program code based on it.
Using this manual does not replace your own investigations and analyses using proper (non-pyrate) sources. 
The copyright holders warn you that on-screen and/or printed versions of this manual may emit bosonic particles at speeds of 299792458\,m/s.

\chapter{Optics from Maxwell Equations}
\section{Unit Systems}
Historically, nearly all unit systems are based on defining a unit for length, time and mass.
As long as the unit system is consistent in itself, 
it is easy to convert from one unit system to another, and formulas do not depend on the choice of the unit system.
As electricity was discovered, this changed.
For a better understanding, we recapitulate some laws of electricity.
\paragraph{Coulomb} 
discovered that charged particles attract or repel each other.
\begin{eqnarray}
 F &=& a_1 \frac{q_1 q_2}{r^2}
\end{eqnarray}
\paragraph{Amp\`{e}re} 
discovered that wires carrying electric currents attract or repel each other.
\begin{eqnarray}
 F &=& a_2 \frac{2 I_1 I_2 l}{d}
\end{eqnarray}
\paragraph{Faraday}
discovered that a change of magnetic flux induces voltages in conductors.
\begin{eqnarray}
 \Nabla \times \Efield + a_3 \dot{\Bfield} = 0
\end{eqnarray}
\paragraph{Maxwell} 
unified the laws of electricity, magnetics and electrodynamics to the famous set of equations
\begin{eqnarray}
 \Nabla \Efield &=& 4 \pi a_1 \chargedensity \\
 \Nabla \times \Bfield &=& 4 \pi \frac{a_2}{a_3} \currentdensity + \frac{a_2}{a_1 a_3} \dot{\Efield} \\
 \Nabla \times \Efield &=& - a_3 \dot{\Bfield} \\
 \Nabla \Bfield &=& 0
\end{eqnarray}
which holds in vacuum in this form.
All these proportionalities are experimentally proven.
The proportionality factors, however, cannot be defined by a purely mechanical unit system and may be freely chosen, 
as long as $a_1 = a_2 c_0^2$.
The most common choices are

\begin{tabular}{l|lll}
                       & $a_1$\qquad\qquad                    & $a_2$\qquad\qquad                  & $a_3$ \\
 \hline
 electrostatic (esu)   & 1                                    & $\frac{1}{c_0^2}$                  & 1 \\
 electromagnetic (emu) & $c_0^2$                              & 1                                  & 1 \\
 Gau\ss (cgs)          & 1                                    & $\frac{1}{c_0^2}$                  & $\frac{1}{c_0}$ \\
 Heavyside-Lorentz     & $\frac{1}{4\pi}$                     & $\frac{1}{4\pi c_0^2}$             & $\frac{1}{c_0}$ \\
 SI                    & $\frac{1}{4\pi \vacuumpermittivity}$ & $\frac{\vacuumpermeability}{4\pi}$ & 1 
\end{tabular}\\[2ex]

Each of these choices has its advantages when calculating in certain domains.
The downside of the multitude of unit systems is that formulas differ by 
a ratio of their corresponding $a_{1,2,3}$ factors when formulated in different unit systems.
In the following, we use SI units only.

\section{Maxwell Equations in SI units}
The content of this chapter is well known from textbooks \cite{Jackson, BornWolf}. Still, we repeat some of the equations to have a consistent 
nomenclature throughout this manual and the pyrate program as well as a gain in clarity which aproximations are made.
We start from the Maxwell equations in SI units
\begin{subequations}\label{eq:Maxwell}
\begin{eqnarray}
  \Nabla \Dfield &=& \chargedensity\,, 							\label{eq:MaxwellNablaD}\\
  \Nabla \times \Hfield -\timederivative{\Dfield} &=&  \currentdensity\,,  		\label{eq:MaxwellNablaCrossH} \\
  \Nabla \Bfield &=& 0\,,  									\label{eq:MaxwellNablaB} \\
  \Nabla \times \Efield + \timederivative{\Bfield} &=& 0\,,   					\label{eq:MaxwellNablaCrossE}
\end{eqnarray}
\end{subequations}
with the constitutive equations
\begin{subequations}\label{eq:Material}
\begin{eqnarray}
  \Dfield &=& \permittivity \Efield\,, 								\label{eq:ConstitutiveEpsilon}\\
  \Bfield &=& \permeability \Hfield\,, 								\label{eq:ConstitutiveMu}\\
  \currentdensity &=& \conductivity \Efield\,,						\label{eq:ConstitutiveSigma}
\end{eqnarray}
\end{subequations}
and the continuity equation, that follows directly from the Maxwell equations.
\begin{eqnarray}
  \Nabla \currentdensity + \timederivative{\chargedensity} &=& 0		\label{eq:continuity}
\end{eqnarray}
All quantities are real valued. $\permittivity$ is the  electric  permittivity, 
$\permeability$ the magnetic permeability, 
and $\conductivity$ the conductivity.
The unit bearing quantities $\permeability, \permittivity$ 
are linked to the relative properties $\relativepermeability, \relativepermittivity$ via
the vacuum values
\begin{eqnarray}
 \permeability &=& \vacuumpermeability \relativepermeability \\
 \permittivity &=& \vacuumpermittivity \relativepermittivity
\end{eqnarray}
We restrict ourselves to linear constitutive equations, that is, ($\permittivity$, $\permeability$ , $\conductivity$) do not depend on the field strength.
This limitation excludes treatment of effects like higher harmonic generation, frequency conversion, or wave mixing.
The Maxwell equations require media in which the constitutive bulk quantities can be assigned to all positions in space.
Single atoms, molecules or nanoscopic structures must be treated quantum-mechanically and are beyond the scope of this manual.

We assume the strictly monochromatic case $\Efield,\Dfield,\Hfield,\Bfield, \currentdensity \propto \sin(\omega t + \varphi_0)$ for electrodynamic scenarios only, $\omega \neq 0$.
We introduce the following constants:
\begin{align}
 c_\vacuum &= \frac{1}{\sqrt{\vacuumpermeability\vacuumpermittivity}} & \textrm{vacuum speed of light} \\
 \wavenumber_\vacuum &= \omega \sqrt{\vacuumpermeability\vacuumpermittivity} = \frac{\omega}{c_\vacuum}& \textrm{vacuum wavenumber} \\
 \lambda_\vacuum &= \frac{2\pi}{\wavenumber_\vacuum} & \textrm{vacuum wavelength}
\end{align}

\section{Energy Conservation}
We focus on the term
\begin{eqnarray}
   \Nabla ( \Efield \times \Hfield )
\end{eqnarray}
We apply the product rule for derivatives and rewrite the triple products, leading to
\begin{eqnarray}
   \Nabla ( \Efield \times \Hfield ) &=& \Hfield ( \Nabla \times \Efield ) - \Efield ( \Nabla \times \Hfield ) \\
   &=& - \Hfield \timederivative{\Bfield} - \Efield  \timederivative{\Dfield} - \Efield \currentdensity
\end{eqnarray}

We consider
\begin{eqnarray}
 \partial_t (\Efield \Dfield) &=& \Efield  \timederivative{\Dfield} +  \timederivative{\Efield} \Dfield \\
                              &=& \Efield ( \permittivity + \permittivity^T ) \timederivative{\Efield} 
\end{eqnarray}
In the monochromatic case, as assumed above, we can commutate $\partial_t$ and $\permittivity$.
We split up the permittivity into its symmetric and antisymmetric part $\permittivity =  \permittivity^S +  \permittivity^{AS}$ with
$(\permittivity^S)^T = \permittivity^S$ and $(\permittivity^{AS})^T = - \permittivity^{AS}$. 

\begin{eqnarray}
 \partial_t (\Efield \Dfield)                                                                  &=& 2 \Efield \permittivity^S \timederivative{\Efield} \\
 \frac{1}{2} \partial_t (\Efield \Dfield)+ \Efield \permittivity^{AS} \timederivative{\Efield} &=&   \Efield  \permittivity \timederivative{\Efield} \\
 \frac{1}{2} \partial_t (\Efield \Dfield)                                                      &=&   \Efield  \permittivity \timederivative{\Efield}
\end{eqnarray}

We derive an analogous equation for the magnetic field and insert both
\begin{eqnarray}
   \Nabla ( \Efield \times \Hfield ) + \frac{1}{2} \partial_t (\Hfield \Bfield) + \frac{1}{2} \partial_t (\Efield \Dfield) + \Efield \currentdensity &=& 0
\end{eqnarray}
leading to a continuity equation. 
We associate $\Efield \currentdensity$ with ohmic losses, that is, the volume density of energy losses from optical energy into other forms, for example heat.
Thus, the equation is a continuity equation of energy.
$\frac{1}{2} \Hfield \Bfield + \frac{1}{2} \Efield \Dfield$ is the energy density stored in a system, 
and $\Efield \times \Hfield$, which we call Poynting vector $\Vector{S}$, is the areal density of energy flow.
\begin{eqnarray}
 \Vector{S} &=& \Efield \times \Hfield
 \label{eq:definitionOfPoynting}
\end{eqnarray}
We discuss the Poynting vector in more detail in section \ref{sec:Poynting}, after introducing complex valued notation.

\section{Complex Notation, Non-Magnetic Materials and Source-Free Maxwell Equations}
\label{sec:sourcefreemaxwell}
For ease of calculation, we introduce complex valued time harmonic dependence.
\begin{eqnarray}
 \Vector{F}(\Vector{r},t) &=& \Vector{F}_0(\Vector{r}) \exp(-i \omega t)
\end{eqnarray}
with $\Vector{F} \in \{ \Efield, \Dfield, \Hfield, \Bfield, \currentdensity \}$.
We associate the real part of $F$ with physically measureable quantities. 
Via the time harmonic factor $\exp(-i \omega t)$, the imaginary part of the fields will become real at other instances in time.
Complex valued amplitudes $\Vector{F}_0$ express magnitude and phase retardation of the fields.
All equations linear in $\Efield,\Dfield,\Hfield,\Bfield$ remain valid also for the newly introduced complex valued fields.
Care has to be taken with quadratic terms like $\Efield \times \Hfield$, $\Hfield \Bfield$, or $\Efield \Dfield$,
as the square of a real number differs from that of a complex one -- e.g. it may become negative.

We assume all materials are non-magnetic at the optical frequency $\omega$, that is $\permeability(\omega) = \vacuumpermeability$. 
Effects like the Magneto-Optical Kerr Effect (MOKE) stem from the deflection of oscillating electrons in a static (DC) magnetic field and are typically modeled by off-diagonal elements in the permittivity tensor, not the permeability.
Some metamaterials, however, require an non-vacuum permeability to approximate their response with homogeneous material properties. 
\begin{subequations}
\begin{eqnarray}
  \Nabla \Dfield &=& \chargedensity 					\\
  \Nabla \times \Efield &=& i \omega \vacuumpermeability \Hfield	\\
  \Nabla \Hfield &=& 0  					\\
  \Nabla \times \Hfield &=& - i \omega \Dfield + \currentdensity  		
\end{eqnarray}
\end{subequations}

The physically measurable fields are $\Efield$ and $\Bfield$, defined by forces on test charges. All other fields are fictional fields introduced in the Maxwell model for ease of calculation.
To obtain the so-called source-free Maxwell equations, we replace some of them by newly defined quantities.
We introduce a \emph{new} permittivity
\begin{eqnarray}
  \permittivity_{new} = \permittivity - \frac{\conductivity}{i \omega}
\end{eqnarray}
This newly defined permittivity is complex valued, where the imaginary part denotes electric conductivity and thus ohmic losses.
We introduce a corresponding \emph{new} $\Dfield$-field
\begin{eqnarray}
  \Dfield_{new} &=& \permittivity_{new} \Efield \\
  \Dfield &=& \Dfield_{new} + \frac{\conductivity}{i \omega} \Efield
\end{eqnarray}

In the Maxwell equations, we substitute the $\Dfield$-field by our newly defined field $\Dfield_{new}$.
With the conductivity equation \ref{eq:ConstitutiveSigma} and the continuity equation \ref{eq:continuity}, we find the so called source-free Maxwell equations
\begin{subequations}
\begin{eqnarray}
  \Nabla \Dfield_{new} &=& 0 					\label{eq:divDsourcefree}\\
  \Nabla \times \Efield &=& i \omega \vacuumpermeability \Hfield	\\
  \Nabla \Hfield &=& 0  					\\
  \Nabla \times \Hfield &=& - i \omega \Dfield_{new}  		
\end{eqnarray}
\end{subequations}
There are neither electric nor magnetic monopolar sources.
The equations are nearly symmetric in $\Dfield$ and $\Hfield$.
From now on, every time we write $\Dfield$, we mean the complex valued $\Dfield_{new}$ without explicitly writing the index \emph{new} (call us lazy, we don't care).
\begin{subequations}
\begin{eqnarray}
  \Nabla \Dfield &=& 0 					 	 \label{eq:sourcefreemaxwell_divD} \\
  \Nabla \times \Efield &=& i \omega \vacuumpermeability \Hfield \label{eq:sourcefreemaxwell_rotE}	\\
  \Nabla \Bfield &=& 0  					 \label{eq:sourcefreemaxwell_divB} \\
  \Nabla \times \Hfield &=& - i \omega \Dfield  		 \label{eq:sourcefreemaxwell_rotH}
\end{eqnarray}
\label{eq:sourcefreemaxwell}
\end{subequations}

\section{Poynting Vector}\label{sec:Poynting}
The Poynting vector is the areal density of energy flow. 
We want the Poynting vector to be real and stay numerically identical to the quantity derived above 
for the real valued Maxwell equations in equation \ref{eq:definitionOfPoynting}.

\begin{eqnarray}
 \Vector{S} &=& \Re \Efield \times \Re \Hfield \nonumber \\
            &=& \frac{1}{2} \Re ( \Efield \times \Hfield + \overline{\Efield} \times \Hfield ) \nonumber \\
            &=& \frac{1}{2} \Re ( \Efield_0 \times \Hfield_0 \exp(-2i\omega t) )
	      + \frac{1}{2} \Re ( \overline{\Efield}_0 \times \Hfield_0 ) \label{eq:SconjEH}\,,
\end{eqnarray}
for the decomposition $\Efield = \Efield_0 \exp(-i\omega t)$ and $\Hfield = \Hfield_0 \exp(-i\omega t)$.
The fast oscillation of the Poynting vector at $2 \omega$ is not directly measurable at optical frequencies, only its time average $\timeavg{\Vector{S}}$,
\begin{eqnarray}
 \timeavg{\Vector{S}}  &:=& \frac{\omega}{2\pi} \int_{0}^{2\pi / \omega} dt \, \Vector{S} \label{eq:timeaverageS}\,.
\end{eqnarray}
From \eqref{eq:SconjEH} and \eqref{eq:timeaverageS} we get
\begin{eqnarray}
  \timeavg{\Vector{S}}   &=& \underbrace{\left\langle \frac{1}{2} \Re ( \Efield_0 \times \Hfield_0 \exp(-2i\omega t) )\right\rangle}_{\approx0} + \frac{1}{2} \Re ( \overline{\Efield} \times \Hfield )\,.
\end{eqnarray}
We insert the Maxwell equation \eqref{eq:sourcefreemaxwell_rotE} and obtain
\begin{eqnarray}
 \timeavg{\Vector{S}}   &=& \frac{1}{2} \Re \left( \overline{\Efield} \times \frac{\Nabla \times \Efield}{i \omega \vacuumpermeability} \right)
\end{eqnarray}
and via the Gra\ss mann identity 
\begin{eqnarray}
  \timeavg{\Vector{S}}_j &=&  \Re \frac{ \overline{\scalarEfield}_i \partial_j \scalarEfield_i - \overline{\scalarEfield}_j \partial_i \scalarEfield_i }{2 i \omega \vacuumpermeability}
\end{eqnarray}
The term $\partial_i \scalarEfield_i$ -- the divergence of the elctric field -- vanishes in isotropic, homogeneous media.
Assuming a plane wave expansion of $\Efield = \Vector{A} \exp(i \scpm{\Vector{k}}{\Location})$, we find
\begin{eqnarray}
  \partial_j E_i &=& i\,k_j E_i\,,
\end{eqnarray}
and
\begin{eqnarray}
 \timeavg{\Vector{S}}_j &=&  
    \frac{1}{2 \omega \vacuumpermeability}\Re( 
	\overline{\scalarEfield}_i \scalarEfield_i \delta_{j\ell}  
	- \overline{\scalarEfield}_j \scalarEfield_\ell 
      ) k_\ell\,.\label{eq:poyntingvector}
\end{eqnarray}
In general, the direction of the Poynting vector is the real projection of a weighted sum of the directions of $\Wavevector$ and $\Efield$.


\section{Plane Wave Solutions and Dispersion}
\subsection{The general anisotropic homgeneous case}
We consider a homogeneous material $\permittivity(\Location) = const.$ We apply the Nabla curl operatur on the Maxwell curl equation for the electric field
\begin{eqnarray}
  \Nabla \times ( \Nabla \times \Efield ) &=& \Nabla \times ( i \omega \vacuumpermeability \Hfield ) 
  \\
  \partial_i \partial_i \scalarEfield_j - \partial_j \partial_i \scalarEfield_i &=& - \omega^2 \vacuumpermeability \permittivity_{jk} \scalarEfield_{k}
\end{eqnarray}
This is a differential equation with constant coefficients, so we use the ansatz
\begin{eqnarray}
 \Efield(\Location,\omega) &=& \Efield_0(\omega) \exp(i \Wavevector \Location)
\end{eqnarray}
where the $\Efield_0$ contains polarisation, electric field amplitude and harmonic time dependence.
With this monochromatic time dependence, $\permittivity_{ij}$ becomes a constant factor 
and we can replace $\partial_j \to i k_j$. We yield
\begin{eqnarray}
\begin{pmatrix}
 \wavenumber_y^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{xx} 
 &
 - \wavenumber_x \wavenumber_y - \omega^2 \vacuumpermeability \scalarpermittivity_{xy}
 &
 - \wavenumber_x \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{xz}
 \\
 - \wavenumber_x \wavenumber_y - \omega^2 \vacuumpermeability \scalarpermittivity_{yx}
 &
 \wavenumber_x^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{yy} 
 &
 - \wavenumber_y \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{yz}
 \\
 - \wavenumber_x \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{zx}
 &
 - \wavenumber_y \wavenumber_z - \omega^2 \vacuumpermeability \scalarpermittivity_{zy}
 &
 \wavenumber_x^2 + \wavenumber_y^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{zz}  
\end{pmatrix}
\Efield_0
&=& 0 \label{eq:generalDispersionEigenEquation}
\end{eqnarray}
In component notation, that is
\begin{align}
 A_{ij} E_{j\,0} &= 0 \label{eq:generalDispersionEigenEquationindex}\\
 A_{ij}          &= \left(-\Vector{k}^2 \delta_{ij} + k_i k_j + \omega^2 \vacuumpermeability \permittivity_{ij} \right)
 \end{align}
Nontrivial solutions can be found if the determinant of $\hat{A}$ is zero.
We call wavevectors $\Wavevector$ for which the deterimant vanishes a solution of the dispersion relation.
In general, each solution $\Wavevector$ is associated with a certain eigenvector direction $\Efield_0$,
that is, a propagation wavector is only valid for a certain polarisation.

We regard the determinant as a polynomial form of $\wavenumber_i$.
\begin{eqnarray}
 \det \hat{A} &=& P(\Wavevector) = 0
\end{eqnarray}
The characteristic polynomial $P$ reads
\begin{align}
 P &= k_0^2 \left( -\alpha k_0^4 +  (\beta \tr\relativepermittivity - \gamma) k_0^2 - \Vector{k}^2 \beta \right)\,,\label{eq:dispersion_determinant_invariant}
\end{align}
where 
$\alpha = \det(\relativepermittivity)$,
$\beta = \scalarrelativepermittivity_{\,ij} k_i k_j$, 
and
$\gamma = k_i \scalarrelativepermittivity_{\,i\ell} \scalarrelativepermittivity_{\,\ell j} k_j$.
$\relativepermittivity$ is the  relative permittivity.
The characteristic polynomial is a quartic equation in the components $\wavenumber_i$.

The wavevector is a three dimensional vector of complex components, having 6 real valued degrees of freedom.
The dispersion relation $P=0+0i$ eliminates two of these degrees of freedom,
forcing the solution to lie on a 4-dimensional surface in 6-dimensional $\Wavevector$ space.
In raytracing, one often faces problems where additional information about the wavevector is given and the
degrees of freedom are further reduced. In the following, we present some of these problems and their solutions:

\subsubsection{Problem 0: Poynting Vector is known}
The Poynting vector is a real valued, 3-dimensional vector.
It does not provide enough information for the 4 remaining degrees of freedom in the wavevector.
Thus, it is impossible to find a unique solution without further knowledge about $\Wavevector$.

\subsubsection{Problem 1: Two components are known}

We assume two of the three cartesian components of $\Wavevector$ are known.
We decompose $\Wavevector$ into a plane of known components $\Wavevector_\parallel$ and the unknown component $\wavenumber_\perp$. 
A detailed discussion how to calculate the unknown component from the dispersion relation
is given in section \ref{subsubsec:general_anisotropic_refraction}.

\subsubsection{Problem 2: Direction of $\Wavevector$ is known}
We assume the solution $\Wavevector$ is proportional to a given direction $\Vector{e}_\wavenumber$.
The remaining unknown is the length of the wavevector. This ansatz is inspired by \cite{Doering:1957, wiki:Kristalloptik}.
\begin{eqnarray}
 \Wavevector &=& \wavenumber \Vector{e}_\wavenumber
\end{eqnarray}
A real valued $\Vector{e}_\wavenumber$ could not represent wavevectors with different ratios of retardation and evanescence in different directions.
In general, we must assume the direction vector is complex valued.
The direction vector shall be of unit length, $\Vector{e}_\wavenumber \overline{\Vector{e}_\wavenumber} = 1$.
We insert this ansatz in the dispersion relation and yield

\begin{align}
 P &= a_4 \wavenumber^4 + a_2 \wavenumber^2 + a_0
 \\
 a_4 &= - k_0^2 (e_{k\,i} e_{k\,i}) (\scalarrelativepermittivity_{\,ij} e_{k\,i} e_{k\,j})
 \\
 a_2 &=   k_0^4 \left[ (\scalarrelativepermittivity_{\,ij} e_{k\,i} e_{k\,j}) (\tr\relativepermittivity) - (e_{k\,i} \scalarrelativepermittivity_{\,i\ell} \scalarrelativepermittivity_{\,\ell j} e_{k\,j}) \right]
 \\
 a_0 &= - k_0^6 \det \relativepermittivity
\end{align}
The solution to this bi-quadratic equation is easily found as
\begin{eqnarray}
 \wavenumber^2 &=& - \frac{a_2}{2 a_4} \pm \sqrt{\frac{a_2^2}{4 a_4^2} - \frac{a_0}{a_4}} 
\end{eqnarray}

To address all four solutions, we introduce two sign prefactors $\varsigma, \tau \in \{ -1,1\}$
\begin{eqnarray}
 \wavenumber &=& \tau \sqrt{ - \frac{a_2}{2 a_4} + \varsigma \sqrt{\frac{a_2^2}{4 a_4^2} - \frac{a_0}{a_4}} } \label{eq:dispersion_for_known_direction}
\end{eqnarray}

There are two solutions for $\wavenumber^2$, depending on the choice of $\varsigma$.
In general, they may be complex valued.
In isotropic media, the term under the inner square root always vanishes, and both mode polarisations have degenerate wavevectors.
Anisotropic media may achieve degeneracy for certain directions, 
for example along the optical axis of uniaxial anisotropic crystals.
Calculating the two roots $\tau \sqrt{\wavenumber^2}$, we find that with each solution
also the opposite wavevector is a solution.
This result holds for general non-magnetic media and shows a direct link to the reciprocity theorem.

The complex phase of the solutions $\wavenumber$ has to be interpreted
in conjunction with the phase of the unit vector $\Vector{e}_\wavenumber$.
Real and imaginary part of their product, $\Wavevector = \wavenumber \Vector{e}_\wavenumber$, 
denote the physically relevant quantities retardation and evanescence, respectively.
This also holds the other way round: When specifying the unit direction $\Vector{e}_\wavenumber$, 
one does not know the phase of the resulting wavevector $\Wavevector$ beforehand.
This makes the whole ansatz somewhat counter-intuitive.
\remark{to do: find more intuitive ansatz}

\subsubsection{Wavevector Perturbation}

Assume we found a solution to the dispersion relation $\Wavevector$ and its sign prefactors $\varsigma, \tau$ according to equation \eqref{eq:dispersion_for_known_direction}.
We want to perturb the wavevector. 
The perturbed quantities are marked with a tilde, like $\tilde{\Wavevector}$.
In analogy to the unperturbed solution $\Wavevector$, we also split the perturbed solution $\tilde{\Wavevector}$
in direction unit vector and complex amplitude.
\begin{eqnarray}
 \tilde{\Wavevector} &=& \tilde{\wavenumber} \tilde{\Vector{e}}_{\wavenumber}
\end{eqnarray}
We assume the perturbed direction changes infinitessimally from the unperturbed one.
\begin{eqnarray}
 \tilde{\Vector{e}}_\wavenumber &=& \Vector{e}_\wavenumber + \totald\Vector{e} 
\end{eqnarray}
For small perturbations, the length of the direction vector shall stay normalized.
\begin{eqnarray}
 \tilde{\Vector{e}}_\wavenumber \overline{\tilde{\Vector{e}}}_\wavenumber &=& 1 \\
 \Re \left( \Vector{e}_\wavenumber \cdot \overline{\totald\Vector{e}} \right) &=& 0 \label{eq:perturbation_unit_orthogonality}
\end{eqnarray}
That is, unit direction and direction perturbation are orthogonal.
The change in direction may also lead to a change in wavevector length.
\begin{eqnarray}
 \tilde{\Wavevector} &=& 
     \left( 
         \wavenumber + \totald \wavenumber 
     \right)
     \tilde{\Vector{e}}_\wavenumber 
 \\
 \totald \Wavevector \approx \tilde{\Wavevector} - \Wavevector &=& \wavenumber \cdot \totald\Vector{e} + \totald \wavenumber \cdot \Vector{e}_\wavenumber
\end{eqnarray}
We form the derivative of the dispersion \ref{eq:dispersion_for_known_direction} and find
\begin{eqnarray}
 \totald \wavenumber &=&
     \frac{\tau}{4 \wavenumber a_4}
     \left(
         - \totald a_2 + \frac{a_2}{a_4} \totald a_4 
         +  \frac{\varsigma}{\sqrt{\frac{a_2^2}{4 a_4^2} - \frac{a_0}{a_4}}}
                \left( \frac{a_2}{2 a_4} \totald a_2 + \left( \frac{a_0}{a_4} - \frac{a_2^2}{2 a_4^2} \right) \totald a_4 \right)
     \right)
 \nonumber\\
\end{eqnarray}
\remark{to do: double check this formula}
\remark{to do: check whether sqrt may become zero}
with
\begin{eqnarray}
 \totald a_4 &=& - k_0^2 (e_{k\,\ell} e_{k\,\ell}) e_{k\,i} ( \scalarrelativepermittivity_{ij} + \scalarrelativepermittivity_{ji} ) \totald e_{j} - 2 k_0^2 (\scalarrelativepermittivity_{\,im} e_{k\,i} e_{k\,m}) e_{k\,j} \totald e_j\\
 \totald a_2 &=&    k_0^4 \text{tr} \relativepermittivity e_{k\,i} ( \scalarrelativepermittivity_{ij} + \scalarrelativepermittivity_{ji} ) \totald e_{j} - k_0^4 e_{ki} ( \scalarrelativepermittivity_{i\ell} \scalarrelativepermittivity_{\ell j} + \scalarrelativepermittivity_{j\ell} \scalarrelativepermittivity_{\ell i} ) \totald e_{j}
\end{eqnarray}
We can see the global complex phase of the direction change is proportional to the global complex phase of the wavevector change.
That is, if $\totald \Vector{e}$ leads to $\totald \Wavevector$, 
then $e^{i\varphi} \totald \Vector{e}$ leads to $e^{i\varphi}\totald \Wavevector$.

To find all possible direction changes, we start with the cartesian base $( \Vector{e}_x, \Vector{e}_y, \Vector{e}_z )$.
This base fulfills the orthogonality condition \eqref{eq:perturbation_unit_orthogonality}.
Next we apply a unitary rotation operator on all base vectors, such that $\Vector{e}_z$ is transformed to $\Vector{e}_\wavenumber$.
The explicit form of the operator is found in \ref{sec:ortho_vectors}.
\begin{eqnarray}
 \hat{R} \Vector{e}_x &=& \Vector{e}_u \\
 \hat{R} \Vector{e}_y &=& \Vector{e}_v \\
 \hat{R} \Vector{e}_z &=& \Vector{e}_\wavenumber 
\end{eqnarray}
We name the other two unit vectors after rotation $\Vector{e}_u$ and $\Vector{e}_v$.
Due to the unitarity of the rotation operator, the orthogonality between the three base vectors after rotation is conserved.
Next we determine the infinitessimal wavevector changes associated with direction changes in both directions,
$\totald \Vector{e}_u \rightarrow \totald \Wavevector_u$ and $\totald \Vector{e}_v \rightarrow \totald \Wavevector_v$.
We split up the wavevector perturbations in direction and perturbation strength
\begin{eqnarray}
 \tilde{\Wavevector} &=& \Wavevector + U \cdot \Vector{e}_U + V \cdot \Vector{e}_V \label{eq:perturbed_wavevector}
\end{eqnarray}
with $U,V \in \mathbb{C}$ and
\begin{eqnarray}
 \Vector{e}_U &=& \frac{\totald \Wavevector(\totald \Vector{e}_u)}{|\totald \Wavevector(\totald \Vector{e}_u)|} \\
 \Vector{e}_V &=& \frac{\totald \Wavevector(\totald \Vector{e}_v)}{|\totald \Wavevector(\totald \Vector{e}_v)|} 
\end{eqnarray}
$U$ and $V$ are unit-bearing coefficients with the dimension of a wavevector ($1/\meter$).

\subsection{Isotropic media}
We insert an isotropic permittivity $\scalarpermittivity_{ij} = \scalarpermittivity \delta_{ij}$ 
in the general dispersion relation \eqref{eq:dispersion_determinant_invariant}.
\begin{eqnarray}
 P &=& -\scalarpermittivity 
       \left( 
         \Wavevector^2 - \omega^2 \vacuumpermeability \scalarpermittivity\
       \right)^2
    = 0
\end{eqnarray}
The solution is degenerate for both polarisations,
\begin{eqnarray}
 \Wavevector^2 &=& \omega^2 \vacuumpermeability \scalarpermittivity\,, \\
 \scpm{\Wavevector}{\Efield} &=& 0\,.
\end{eqnarray}
where $\Wavevector^2$ is the scalar product of the wavevector with itself and may be complex.
Wavevector perturbations must fulfill
\begin{eqnarray}
 \totald\Wavevector \cdot \Wavevector &=& 0 + 0i
\end{eqnarray}

For plane waves in isotropic media, the Poynting vector becomes 
\begin{eqnarray}
 \timeavg{\Vector{S}}_\text{iso} = \frac{ |\Efield|^2 }{ 2\omega\vacuumpermeability } \Re \Wavevector
\end{eqnarray}

We introduce the refractive index $n$ as
\begin{eqnarray}
 \Wavevector^2 &=& k_0^2 n^2 \\
 n &=& \pm \sqrt{ \frac{\scalarpermittivity}{\vacuumpermittivity} }
\end{eqnarray}
In general, there are two roots. 
The choice of the root does not change anything in optics based on the Maxwell equations, as the permittivity is the only physically relevant quantity.

Some people indicate materials with a negative permittivity real part by a negative sign of the index.
Some people indicate materials with negative permeability and negative permittivity real part at the same time by a negative sign of the index.
This manual does not cover materials with non-vacuum permeabilities so far.
\remark{TODO: rewrite all formulas for non-vacuum permeabilities}
\remark{todo: subsection on k perturbation in this special case}


\subsection{Uniaxial anisotropic, homogeneous media}
\remark{todo: this section needs some updates to fit the rewrite of the general dispersion section: so far, it does not allow complex values in all k components. A starting point could be \ref{eq:uniaxialDispersion}.}
\remark{todo: subsection on k perturbation in this special case}
Uniaxial anisotropic media are media with one axis along which the permittivity takes an extraordinary value, 
and a degenerate permittivity along the other two directions in space.
The direction along which the extraordinary permittivity occurs is often called \emph{optical axis}. 
In this manual, we use the term \emph{extraordinary direction} $\Vector{e}_{eo}$, to avoid confusion with the symmetry axis of radially symmetric lens systems in technical optics.

Often, these materials have a crystalline structure with a degenerate rectangular or hexagonal plane in the unit cell, 
and a strongly deviating unit vector in the orthogonal direction. 

Without loss of generality, we choose our coordinate system so that the extraordinary direction is aligned with the cartesian $z$ axis.
\begin{eqnarray}
 \permittivity &=&
 \begin{pmatrix}
  \scalarpermittivity_{\ordi}  & 0 & 0 \\
  0 & \scalarpermittivity_{\ordi}  & 0 \\
  0 & 0 & \scalarpermittivity_{\eo}   \\
 \end{pmatrix}
\end{eqnarray}

We further rotate the coordinate system in the degenerate $xy$ plane so that $\wavenumber_y = 0$.
\remark{Can a rotation by a real valued angle set real and imaginary part of k zero ?}
The eigenvalue equation \ref{eq:generalDispersionEigenEquation} simplifies to

\begin{eqnarray}
\begin{pmatrix}
 \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} 
 &
 0
 &
 - \wavenumber_x \wavenumber_z 
 \\
 0
 &
 \wavenumber_x^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} 
 &
 0 
 \\
 - \wavenumber_x \wavenumber_z 
 &
 0 
 &
 \wavenumber_x^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\eo}  
\end{pmatrix}
\Efield_0
&=& 0
\end{eqnarray}

The equation system splits up into a coupled system of $\scalarEfield_x$ and $\scalarEfield_z$ , and an independent equation for $\scalarEfield_y$

\begin{subequations}
\begin{align}
\begin{pmatrix}
 \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} 
 &
 - \wavenumber_x \wavenumber_z 
 \\
 - \wavenumber_x \wavenumber_z 
 &
 \wavenumber_x^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\eo}  
\end{pmatrix} 
\begin{pmatrix}
 \scalarEfield_x 
 \\
 \scalarEfield_z
\end{pmatrix}
&= 0
\\
\begin{pmatrix} \wavenumber_x^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} \end{pmatrix} \scalarEfield_y &= 0\,.
\end{align}
\end{subequations}

We call the solutions of the equation for $\scalarEfield_y$ ordinary mode, and of the coupled system extraordinary mode.
We find the following eigenvalues and eigenvectors:
\subsubsection{Ordinary mode (ord)}

If the wavevector fulfills the equation
\begin{eqnarray}
  \wavenumber_x^2 + \wavenumber_z^2 - \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} &=& 0 
\end{eqnarray}
We have a nontrivial solution for the electric field in $y$-direction.

\begin{eqnarray}
 \Wavevector^2 &=& \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} 
 \\
 \Efield &\propto& \Vector{e}_{eo} \times \Wavevector
\end{eqnarray}
For the ordinary mode, $\Efield$ is orthogonal on both $\Wavevector$ and the extraordinary direction.
The Poynting vector points in the direction of the real part of $\Wavevector$,
\begin{eqnarray}
 \timeavg{\Vector{S}}_\ordi = \frac{ |\scalarEfield|^2 }{ 2\omega\vacuumpermeability } \Re \Wavevector\,.\label{eq:Suniaxialordi}
\end{eqnarray}


\subsubsection{Extraordinary mode (eo)}
\begin{eqnarray}
  \frac{\wavenumber_{x}^2 }{\scalarpermittivity_{\eo} } + \frac{\wavenumber_{z}^2 }{\scalarpermittivity_{\ordi} } &=& \omega^2 \vacuumpermeability 
  \label{eq:uniaxialAnisotropicDispersion}
  \\
  \scalarEfield_x \scalarpermittivity_{\ordi} \wavenumber_x &=& -  \scalarEfield_z \scalarpermittivity_{\eo} \wavenumber_z \label{eq:divDuniaxial}
\end{eqnarray}

The Poynting vector from \eqref{eq:poyntingvector} is given by
\begin{eqnarray}
 \timeavg{\Vector{S}}_j &=&  \Re\frac{1}{2 \omega \vacuumpermeability}\left[ (|\scalarEfield_x|^2 + |\scalarEfield_z|^2) \delta_{j\ell}  - \overline{\scalarEfield}_j \scalarEfield_\ell \right] k_\ell\,.
\end{eqnarray}
With \eqref{eq:divDuniaxial} we may derive an expression for the divergence appearing in the second term by inserting an ``intelligent zero''
\begin{eqnarray}
 0 &=& \scalarEfield_x \wavenumber_x + \frac{\scalarpermittivity_{\ordi}}{\scalarpermittivity_\eo} \scalarEfield_z \wavenumber_z\,,\nonumber\\
&\Rightarrow& \scalarEfield_x \wavenumber_x + \scalarEfield_z \wavenumber_z = \scalarEfield_z \wavenumber_z \left(1 - \frac{\scalarpermittivity_{\ordi}}{\scalarpermittivity_\eo}\right)\,. \label{eq:divEviolation}
\end{eqnarray}
Therefore the Poynting vector consists of two terms like in the general case
\begin{eqnarray}
  \timeavg{\Vector{S}} = \frac{ 1 }{ 2\omega\vacuumpermeability } \Re 
  \left[
      (|\scalarEfield_x|^2 + |\scalarEfield_z|^2)\Wavevector
      - \left(1 - \frac{\scalarpermittivity_{\ordi}}{\scalarpermittivity_\eo}\right)\scalarEfield_z \wavenumber_z \overline{\Efield}
  \right]\,.\label{eq:Suniaxialeo}
\end{eqnarray}
For general coordinate systems, where the extraordinary axis points in the direction $\Vector{e}_{eo}$, 
we replace $E_z \rightarrow E_i e_{\eo, i}$ and find
\begin{eqnarray}
  \timeavg{S}_j = \frac{ 1 }{ 2\omega\vacuumpermeability } \Re 
  \left[
      \scalarEfield_i \overline{\scalarEfield}_i \wavenumber_j
      + \left(\frac{\scalarpermittivity_{\ordi}}{\scalarpermittivity_\eo} - 1\right)
        (\scalarEfield_m e_{\eo,m}) (\wavenumber_n e_{\eo,n}) \overline{\scalarEfield}_j
  \right]
\end{eqnarray}



\section{Boundary Conditions}
Considering two media $\permittivity_\materialone$ and $\permittivity_\materialtwo$, we find the following conditions fulfilled on the boundary in both media \cite{Jackson}:
\begin{subequations}
\begin{eqnarray}
 ( \Dfield_\materialtwo - \Dfield_\materialone ) \Vector{n} &=& 0 \\
 ( \Bfield_\materialtwo - \Bfield_\materialone ) \Vector{n} &=& 0 \\
 \Vector{n} \times ( \Efield_\materialtwo - \Efield_\materialone ) &=& 0 \\
 \Vector{n} \times ( \Hfield_\materialtwo - \Hfield_\materialone ) &=& 0 
\end{eqnarray}
\label{eq:boundary_conditions} 
\end{subequations}
where $\Vector{n}$ is the surface normal unit vector.
These relations hold for a step-interface between two homogeneous media. 
In mesoscopically inhomogenous media like  diffractive optical elements and metamaterials, 
the boundary conditions hold at each interface between homogeneous materials of the mesoscopic sub-structure.


\section{Reflection and Refraction of Plane Waves at Planar Surfaces}

\subsection{Derivation}
We consider a plane wave incident on a planar boundary between two homogeneous materials.
The incident plane wave projects a grating on the boundary plane. 
The fields $\Dfield_{in}$ and $\Efield_{in}$ on the boundary in medium $\permittivity_\materialone$ are modulated with the in-plane component of the wavevector. 
\begin{eqnarray}
 \Dfield_{in}, \Efield_{in} &\propto& \exp( i \Wavevector_{in\parallel} \Location)|_{boundary} \\
 \Wavevector_{in\perp} &=& ( \Wavevector_{in} \Vector{n} ) \Vector{n} \\
 \Wavevector_{in\parallel} &=& \Wavevector_{in} - \Wavevector_{in\perp}
\end{eqnarray}
where $\Vector{n}$ is the surface normal unit vector.
From the boundary conditions \ref{eq:boundary_conditions} we conclude that with the incident light $\Dfield_{in}$ and $\Efield_{in}$, 
all reflected or refracted modes $M$ are to be modulated by the same in-plane wavevector component.
\begin{eqnarray}
  \Dfield_{M}, \Efield_{M} &\propto& \exp( i \Wavevector_{M\parallel} \Location)|_{boundary} \\
  \Wavevector_{M\parallel} &=& \Wavevector_{in\parallel}
\end{eqnarray}
The in-plane wave vector component is conserved.
To find the reflected and refracted modes, 
we fix the in-plane wavevector component and search for solutions of the material dispersion
(equation \ref{eq:generalDispersionEigenEquation}).
In general, the dispersion is quartic and allows for 4 solutions in each medium.
\begin{figure}
  \centering
   \includegraphics[width=0.5\columnwidth]{boundary_wavevectors}
  \caption{a) Wavevectors with the same in-plane component.
           b) Scenario of a single incident plane wave.}
  \label{fig:boundary_wavevectors}
\end{figure}
In each medium, there are 2 solutions transporting energy towards the boundary, 
and 2 solutions transporting energy from it (see figure \ref{fig:boundary_wavevectors}).
The modes can be distinguished by analyzing the direction of the Poynting vector relative to the surface normal,
$\Vector{S}\cdot\Vector{n}>0$ or $\Vector{S}\cdot\Vector{n}<0$.
In the scenario we consider, we have a single incident plane wave from medium $\materialone$, 
and we discard the 3 remaining solutions transporting energy towards the boundary.
This leaves 5 modes: One incident plane wave splits up into 2 reflected modes and 2 refracted modes.
We consider the electric fields $\Efield_{\materialone,\materialtwo}$ on both sides of the boundary
\begin{subequations}
\begin{eqnarray}
 \Efield_\materialone(\Location) &=& \Efield_{in,0} \exp(i \Wavevector_{in} \Location) + \Efield_{r1,0} \exp(i \Wavevector_{r1} \Location) + \Efield_{r2,0} \exp(i \Wavevector_{r2} \Location)  \\
 \Efield_\materialtwo(\Location) &=& \Efield_{t1,0} \exp(i \Wavevector_{t1} \Location) + \Efield_{t2,0} \exp(i \Wavevector_{t2} \Location)
\end{eqnarray}
\label{eq:modes_on_boundary} 
\end{subequations}

Each term on the right hand side stands for a mode, represented by its amplitude $\Efield_{0}$ and wavevector $\Wavevector$.
We consider the incident mode $\Wavevector_{in}$, 
the two reflected modes $\Wavevector_{r1,2}$,
and the two refracted or transmitted modes $\Wavevector_{t1,2}$.
For isotropic media $\materialone$, the wavevectors $\Wavevector_{r1,2}$ are degenerate. 
The same holds for $\Wavevector_{t1,2}$ in isotropic media $\materialtwo$.

\subsection{The Law of Refraction}
Our formulation of the law of refraction and the law of reflection is
\begin{eqnarray}
 \Wavevector_{M} &=& \Wavevector_{in\parallel} + \xi_M \Vector{n}\,.\label{eq:xieqn}
\end{eqnarray}
The wavevectors of each mode $\Wavevector_M$ consist of the conserved in-plane component $\wavenumber_{in\parallel}$ and the out-of-plane component $\xi_M$. 
Solving the material dispersion $\xi$, we find the directions of all refracted and reflected modes.
Compared to the law of Snellius, this formulation bears the following advantages:
\begin{itemize}
 \item It does not require the calculation of geometric angles in 3D space, and can be formulated with scalar products of vectors.
 \item The incident wavevector can be modelled as a property of the ray. When calculating the refracted wavevector, 
       the dispersion relation in material $\permittivity_\materialone$ is not required.
       This allows to isolate methods in object-oriented programming and a modular design.
 \item It is not required to implement a different law of refraction for each \emph{pair} of material classes interfacing 
       (isotropic, uniaxial anisotropic, biaxial anisotropic, magnetooptic, ...),
       where the number of implementations increases quadratically with the number of material classes.
       Instead, the implementation effort increases linearly.
 \item We can calculate with complex valued permittivities of lossy materials.
       The law of Snellius coincides with the Maxwell equations for real valued positive refractive indices only.
 \item We can handle anisotropic materials.
\end{itemize}
The formulation does not actually solve the problem of refraction, but forwards it to the problem of finding a solution $\xi$ of the material dispersion. 
This calculation can, for certain types of anisotropic materials, be complicated.

\subsubsection{isotropic media}
\begin{align}
 \xi = \pm \sqrt{\omega^2 \vacuumpermeability \scalarpermittivity_\materialtwo - \Wavevector_{\parallel}^2}
\end{align}

where $\Wavevector_{\parallel}^2$ is the scalar product of the in-plane wavevector projection with itself, 
not the absolute square of the wavevector component.
The sign of the solution is to be chosen depending on whether the mode shall transport energy towards or away from the interface.

\subsubsection{uniaxial anisotropic}
The ordinary mode behaves like the isotropic solution.
The material dispersion of the extraordinary mode, equation \ref{eq:uniaxialAnisotropicDispersion}, is

\begin{eqnarray}
 \Wavevector^2 \scalarpermittivity_{\ordi} 
 + \wavenumber_{z}^2 (\scalarpermittivity_{\eo} - \scalarpermittivity_{\ordi})
 &=& \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} \scalarpermittivity_{\eo} 
 \label{eq:uniaxialDispersion}
 \\
 (\Wavevector_{\parallel}^2 + \xi^2) \scalarpermittivity_{\ordi} 
 + (\Wavevector_{\parallel} \Vector{e}_{\eo} + \xi \Vector{n}\Vector{e}_{\eo})^2 (\scalarpermittivity_{\eo} - \scalarpermittivity_{\ordi})
 &=& \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} \scalarpermittivity_{\eo}  
\end{eqnarray}
This is a quadratic equation in $\xi$.
\begin{eqnarray}
 c_2 \xi^2 + c_1 \xi + c_0 &=& 0
 \\
 c_2 &=& \scalarpermittivity_{\ordi} + (\scalarpermittivity_{\eo} - \scalarpermittivity_{\ordi}) (\Vector{n}\Vector{e}_{\eo})^2
 \nonumber 
 \\
 c_1 &=& 2 (\scalarpermittivity_{\eo} - \scalarpermittivity_{\ordi}) (\Wavevector_{\parallel} \Vector{e}_{\eo}) (\Vector{n}\Vector{e}_{\eo})
 \nonumber 
 \\
 c_0 &=& \Wavevector_{\parallel}^2 \scalarpermittivity_{\ordi} + (\scalarpermittivity_{\eo} - \scalarpermittivity_{\ordi}) (\Wavevector_{\parallel} \Vector{e}_{\eo})^2 
       - \omega^2 \vacuumpermeability \scalarpermittivity_{\ordi} \scalarpermittivity_{\eo} 
 \nonumber
\end{eqnarray}

\subsubsection{general anisotropic}\label{subsubsec:general_anisotropic_refraction}
We start from the general dispersion relation \eqref{eq:dispersion_determinant_invariant} and decompose $\Wavevector$ into in-plane and off-plane part
$\Wavevector = \Wavevector_\parallel + \xi \Vector{n}$.
We divide the equation by $\omega^2 \vacuumpermeability$ and yield
\begin{align}
0 &= c_4 \xi ^4 + c_3 \xi ^3 + c_2 \xi ^2 + c_1 \xi + c_0\label{eq:detequalszeroanisotropic}
\end{align}
with
\begin{align}
 c_4 &= \scalarpermittivity_{ij} n_i n_j \\
 c_3 &=  \kpa{i} (\scalarpermittivity_{ij}+\scalarpermittivity_{ji}) n_j \\
 c_2 &= \omega^2 \vacuumpermeability (a_{13}-a_1 c_4)+ a_4 c_4+a_5 \\
 c_1 &= \omega^2 \vacuumpermeability (-a_1 c_3 + a_{11}+a_{12})+a_4 c_3 \\
 c_0 &= \omega^4 \vacuumpermeability^2 \det\permittivity +\omega^2 \vacuumpermeability (a_6-a_1 a_5)+a_4 a_5
\end{align}
with
\begin{subequations}
\begin{align}
 a_1 &= \scalarpermittivity_{ii} \\
 a_4 &= \kpa{i}\kpa{i} \\
 a_5 &= \scalarpermittivity_{ij} \kpa{i} \kpa{j} \\
 a_6 &= \scalarpermittivity_{ij} \scalarpermittivity_{jm} \kpa{i}\kpa{m} \\
 a_{11} &= \scalarpermittivity_{ij} \scalarpermittivity_{jm} \kpa{m} n_i \\
 a_{12} &= \scalarpermittivity_{ij} \scalarpermittivity_{jm} \kpa{i} n_m \\
 a_{13} &= \scalarpermittivity_{ij} \scalarpermittivity_{jm} n_i n_m 
\end{align}
\end{subequations}



\subsection{Fresnel Coefficients}
\subsubsection{general case}
Assume we solved the material dispersion and found the wavevectors of all modes as well as their corresponding eigen-polarization unit vectors $\Vector{e}$
\begin{subequations}
\begin{eqnarray}
(\Wavevector_{in}, \Wavevector_{r1}, \Wavevector_{r2}, \Wavevector_{t1}, \Wavevector_{t2}) \\
(\Vector{e}_{in}, \Vector{e}_{r1}, \Vector{e}_{r2}, \Vector{e}_{t1}, \Vector{e}_{t2})
\end{eqnarray}
\end{subequations}
The field of each mode $M \in \{ r1, r2, t1, t2 \}$
\begin{eqnarray}
\Efield_{M} &=& E_{M,0} \Vector{e}_{M} \exp{i \Wavevector_M \Location}
\end{eqnarray}
depends on the scalar amplitude $E_{M,0}$, containing mode strength and retardation.
We combine the boundary conditions \ref{eq:boundary_conditions} and \ref{eq:modes_on_boundary} with this ansatz and yield an equation system
\begingroup \small
\begin{subequations}
\begin{align}
   - ( \permittivity_\materialone \Vector{e}_{r1}) \Vector{n} E_{r1,0} &-& ( \permittivity_\materialone \Vector{e}_{r2}) \Vector{n} E_{r2,0} &+& ( \permittivity_\materialtwo \Vector{e}_{t1} ) \Vector{n} E_{t1,0} &+& ( \permittivity_\materialtwo \Vector{e}_{t2} ) \Vector{n} E_{t2,0} &=& \Dfield_{in} \Vector{n} \label{eq:fresneldn}\\
   - ( \Vector{e}_{r1} \times \Vector{n} )         E_{r1,0} &-& ( \Vector{e}_{r2} \times \Vector{n} )         E_{r2,0} &+& ( \Vector{e}_{t1} \times \Vector{n} )          E_{t1,0} &+& ( \Vector{e}_{t2} \times \Vector{n} )          E_{t2,0} &=& \Efield_{in} \times \Vector{n} \label{eq:fresnelEcrossn} \\
   - ( \Wavevector_{r1} \times \Vector{e}_{r1} )   E_{r1,0} &-& ( \Wavevector_{r2} \times \Vector{e}_{r2} )   E_{r2,0} &+& ( \Wavevector_{t1} \times \Vector{e}_{t1} )    E_{t1,0} &+& ( \Wavevector_{t2} \times \Vector{e}_{t2} )    E_{t2,0} &=& \Wavevector_{in} \times \Efield_{in} \label{eq:fresnelkE}
\end{align}
\end{subequations}
\endgroup
All prefactors $\permittivity, \Vector{e}, \Wavevector, \Vector{n}$ are known, 
as well as the incident wave properties on the right hand side of the equations.
Our goal is to solve this linear equation system for the amplitudes $E_{M,0}$.
We have 7 scalar equations, and only 4 unknowns.
The system, however, is not of full rank.
Before solving the system, we need to reduce the number of equations.

First, we split up the mode label $M$ into two indices $\alpha=1,2$ and $\beta=r,t$.
This allows us to abbreviate the equation system to
\begin{subequations}
  \begin{align}
    \sum_{\alpha=1,2\;\beta=r,t} \varsigma_\beta (\permittivity_\beta \Vector{e}_{\beta\alpha})\Vector{n} E_{\beta\alpha,0} &= \Dfield_{in} \Vector{n}                   \label{eq:FresnelSystemEq1} \\
    \sum_{\alpha=1,2\;\beta=r,t} \varsigma_\beta (\Vector{e}_{\beta\alpha} \times \Vector{n} ) E_{\beta\alpha,0} &= \Efield_{in} \times \Vector{n}                        \label{eq:FresnelSystemEq2} \\
    \sum_{\alpha=1,2\;\beta=r,t} \varsigma_\beta ( \Wavevector_{\beta\alpha} \times \Vector{e}_{\beta\alpha} ) E_{\beta\alpha,0} &=  \Wavevector_{in} \times \Efield_{in} \label{eq:FresnelSystemEq3}
  \end{align}
\end{subequations}
where $\varsigma$ represents the sign of each term.
$\varsigma_t=1$ for transmitted terms and $\varsigma_r=-1$ for reflected ones.
\remark{todo: check nomenclature consistency with mode sign prefactors introduced in plane wave section}
We introduce a cartesian base, 
consisting of the directions of the normal direction $\Vector{n}$, 
and two in-plane directions $\Vector{e}_X$ and $\Vector{e}_Y$.
We decompose both vectorial equation in this base and obtain
\begin{subequations}
  \begin{align}
    \varsigma_\beta (\permittivity_\beta \Vector{e}_{\beta\alpha})\Vector{n} E_{\beta\alpha,0} &= \Dfield_{in} \Vector{n} \\
    0 &= 0 \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \times \Vector{n} ) \Vector{e}_X E_{\beta\alpha,0} &= (\Efield_{in} \times \Vector{n}) \Vector{e}_X \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \times \Vector{n} ) \Vector{e}_Y E_{\beta\alpha,0} &= (\Efield_{in} \times \Vector{n}) \Vector{e}_Y \\
    \varsigma_\beta ( \Wavevector_{\beta\alpha} \times \Vector{e}_{\beta\alpha} ) \Vector{n} E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in})\Vector{n} \label{eq:fresnelTripleProductSubEq}\\
    \varsigma_\beta ( \Wavevector_{\beta\alpha} \times \Vector{e}_{\beta\alpha} ) \Vector{e}_X E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X \\
    \varsigma_\beta ( \Wavevector_{\beta\alpha} \times \Vector{e}_{\beta\alpha} ) \Vector{e}_Y E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y
  \end{align}
\end{subequations}
We represent wavevectors as 
$\Wavevector_{\beta\alpha} = \wavenumber_{X} \Vector{e}_X + \wavenumber_{Y} \Vector{e}_Y + \xi_{\beta\alpha} \Vector{n}$
and permute the triple product in \eqref{eq:fresnelTripleProductSubEq}, yielding
\begin{subequations}
  \begin{align}
    \varsigma_\beta (\permittivity_\beta \Vector{e}_{\beta\alpha})\Vector{n} E_{\beta\alpha,0} &= \Dfield_{in} \Vector{n} \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \times \Vector{n} ) \Vector{e}_X E_{\beta\alpha,0} &= (\Efield_{in} \times \Vector{n}) \Vector{e}_X \label{eq:fresnelXEq}\\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \times \Vector{n} ) \Vector{e}_Y E_{\beta\alpha,0} &= (\Efield_{in} \times \Vector{n}) \Vector{e}_Y \label{eq:fresnelYEq}\\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \times \Vector{n} ) \Wavevector_{\parallel} E_{\beta\alpha,0} &= (\Efield_{in} \times \Vector{n}) \Wavevector_{\parallel} \label{eq:fresnelParallelEq}\\
    \varsigma_\beta \left( \wavenumber_Y ( \Vector{e}_Y \times \Vector{e}_{\beta\alpha} ) \Vector{e}_X  + \xi_{\beta\alpha} ( \Vector{n} \times \Vector{e}_{\beta\alpha} ) \Vector{e}_X) \right) E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X \\
    \varsigma_\beta \left( \wavenumber_X ( \Vector{e}_X \times \Vector{e}_{\beta\alpha} ) \Vector{e}_Y  + \xi_{\beta\alpha} ( \Vector{n} \times \Vector{e}_{\beta\alpha} ) \Vector{e}_Y) \right) E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y
  \end{align}
\end{subequations}
One can see that \eqref{eq:fresnelParallelEq} is a linear combination of \eqref{eq:fresnelXEq} and \eqref{eq:fresnelYEq},
so we remove this redundant equation.
Our coordinate system is cartesian, so we employ $\Vector{e}_X \times \Vector{e}_Y = \Vector{n}$ and get rid of the cross products
\begin{subequations}
  \begin{align}
    \varsigma_\beta (\permittivity_\beta \Vector{e}_{\beta\alpha})\Vector{n} E_{\beta\alpha,0} &= \Dfield_{in} \Vector{n} \label{eq:fresnelLastToSkip}\\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_Y) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_Y \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_X) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_X \\
    \varsigma_\beta \left( \wavenumber_Y ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_Y) \right) E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X \\
    \varsigma_\beta \left(-\wavenumber_X ( \Vector{e}_{\beta\alpha} \Vector{n} )  + \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_X) \right) E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y
  \end{align}
\end{subequations}
We use the Helmholtz equation \eqref{eq:generalDispersionEigenEquationindex}
\begin{eqnarray}
 \forall \alpha, \beta : \omega^2 \vacuumpermeability \scalarpermittivity_{\beta ij} \Vector{e}_{\beta \alpha j} 
 &=&
 \left(
   \wavenumber_m \wavenumber_m \delta_{ni}
   -
   \wavenumber_i \wavenumber_n
 \right)
 \Vector{e}_{\beta \alpha n} 
\end{eqnarray}
on the first equation \eqref{eq:fresnelLastToSkip} and multiply the last two equations 
with $\wavenumber_Y$ and $-\wavenumber_X$, respectively.
%\begin{subequations}
%  \begin{align}
%    \varsigma_\beta  \left(   \wavenumber_m \wavenumber_m \delta_{ij} - \wavenumber_i \wavenumber_j   \right) e_{\beta\alpha j} n_i E_{\beta\alpha,0} &= \omega^2 \vacuumpermeability \Dfield_{in} \Vector{n} \\
%    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_Y) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_Y \\
%    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_X) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_X \\
%    \varsigma_\beta \left( \wavenumber_Y^2 ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \wavenumber_Y \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_Y) \right) E_{\beta\alpha,0} &=  \wavenumber_Y (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X \\
%    \varsigma_\beta \left( \wavenumber_X^2 ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \wavenumber_X \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_X) \right) E_{\beta\alpha,0} &= -\wavenumber_X (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y
%  \end{align}
%\end{subequations}
\begin{subequations}
  \begin{align*}
    \varsigma_\beta \left( ( \wavenumber_X^2 + \wavenumber_Y^2 ) (\Vector{e}_{\beta\alpha} \Vector{n}) - \xi_{\beta\alpha} \wavenumber_X (\Vector{e}_{\beta\alpha} \Vector{e}_X) - \xi_{\beta\alpha} \wavenumber_Y (\Vector{e}_{\beta\alpha} \Vector{e}_Y  \right) E_{\beta\alpha,0} &= \omega^2 \vacuumpermeability \Dfield_{in} \Vector{n} \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_Y) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_Y \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_X) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_X \\
    \varsigma_\beta \left( \wavenumber_Y^2 ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \wavenumber_Y \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_Y) \right) E_{\beta\alpha,0} &=  \wavenumber_Y (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X \\
    \varsigma_\beta \left( \wavenumber_X^2 ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \wavenumber_X \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_X) \right) E_{\beta\alpha,0} &= -\wavenumber_X (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y 
  \end{align*}
\end{subequations}
The first equation is the sum of the last two, so we may remove any of these three from our system of equations.
But which one is best to choose ?

We consider the first equation, \eqref{eq:fresnelLastToSkip}, in the special case of isotropic materials and normal incidence,
$\Wavevector_{in} \propto \Vector{n}$.
In this case, both (conserved) in-plane components $\wavenumber_X, \wavenumber_Y$ are zero for all modes.
Applying the Gau\ss\,law \eqref{eq:MaxwellNablaD} to isotropic materials, $\scalarpermittivity \Nabla \Efield = 0$, we conclude that 
all modes $\Vector{e}_{\beta\alpha}$ are orthogonal to the wavevector and thus to the surface normal,
$\Vector{e}_{\beta\alpha} \Vector{n} = 0$.
In this special case, equation \eqref{eq:fresnelLastToSkip} reduces to
\begin{eqnarray*}
 0 &=& 0
\end{eqnarray*}
which is of limited help in solving the system. 
The special case we chose is quite common, for example as on-axis ray in all centro-symmetric systems made of glass.
Thus we decide to remove equation \eqref{eq:fresnelLastToSkip} and yield our final system
\begin{subequations} \label{eq:fresnel_equation_system_general}
  \begin{align}
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_X) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_X \\
    \varsigma_\beta (\Vector{e}_{\beta\alpha} \Vector{e}_Y) E_{\beta\alpha,0} &= \Efield_{in} \Vector{e}_Y \\
    \varsigma_\beta \left( \wavenumber_X ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_X) \right) E_{\beta\alpha,0} &= -(\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y \\
    \varsigma_\beta \left( \wavenumber_Y ( \Vector{e}_{\beta\alpha} \Vector{n} )  - \xi_{\beta\alpha} ( \Vector{e}_{\beta\alpha} \Vector{e}_Y) \right) E_{\beta\alpha,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X 
  \end{align} 
\end{subequations}

The square or absolute square of the field amplitude $E_{\beta\alpha}$ 
is \emph{not} always proportional to the energy flow $\Vector{S}$.
Waves of equal electric field amplitude in dense flint and light crown glasses have a different Poynting vector magnitude.


\subsubsection{isotropic media}
We assume the boundary between two isotropic media.
Without loss of generality, we rotate our coordinate system so that $\wavenumber_Y = 0$.
\remark{can we assume ky=0 without loss out generality for complex k?}
In isotropic media, the modes are orthogonal to the wavevectors $\Vector{e}_{\beta\alpha} \perp \Wavevector_{\beta\alpha}$.
Both solutions $\alpha$ have a degenerate wavevector.
We choose the modes $\alpha \in \{ \spol, \ppol \}$
\begin{eqnarray}
 \Vector{e}_{\spol} &=& \Vector{e}_Y \\
 \Vector{e}_{\beta\,\ppol} &=& \frac{\xi_\beta \Vector{e}_X - \wavenumber_X \Vector{n}}{\normconst_\beta} 
\end{eqnarray}
where $\normconst_\beta = \sqrt{ \xi_\beta \overline{\xi_\beta} + \wavenumber_X \overline{\wavenumber_X}}$ is a normalization constant, ensuring $|\Vector{e}_{\beta\,\ppol}|=1$.
In lossless media, the normalization constant $\normconst$ is equal to the refractive index times the vacuum wavenumber
$\wavenumber_0 n = \sqrt{ \xi_\beta^2 + \wavenumber_X^2}$.
The equation system \eqref{eq:fresnel_equation_system_general} simplifies to
%\begin{subequations}
%  \begin{align}
%    \varsigma_\beta (\Vector{e}_{\beta \ppol} \Vector{e}_X) E_{\beta \ppol,0} &= \Efield_{in} \Vector{e}_X \\
%    \varsigma_\beta E_{\beta \spol,0} &= \Efield_{in} \Vector{e}_Y \\
%    \varsigma_\beta \left( \wavenumber_X ( \Vector{e}_{\beta \ppol} \Vector{n} ) - \xi_{\beta} ( \Vector{e}_{\beta \ppol} \Vector{e}_X) \right) E_{\beta\ppol,0} &= -(\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y  \\
%    \varsigma_\beta \left(  - \xi_{\beta} E_{\beta \spol,0} \right) &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X 
%  \end{align}
%\end{subequations}
\begin{subequations}
  \begin{align}
    \varsigma_\beta \frac{\xi_\beta}{\normconst_\beta}  E_{\beta \ppol,0} &= \Efield_{in} \Vector{e}_X \\
    \varsigma_\beta E_{\beta \spol,0} &= \Efield_{in} \Vector{e}_Y \\
    - \varsigma_\beta \frac{\xi_\beta^2 + \wavenumber_X^2}{\normconst_\beta} E_{\beta\ppol,0} &= -(\Wavevector_{in} \times \Efield_{in}) \Vector{e}_Y  \\
    - \varsigma_\beta \xi_{\beta} E_{\beta \spol,0} &= (\Wavevector_{in} \times \Efield_{in}) \Vector{e}_X 
  \end{align}
\end{subequations}



\paragraph{s-polarized incidence.}
We choose s-polarized incident light 
\begin{eqnarray}
\Efield_{in} &=& E_{in} \Vector{e}_Y 
\end{eqnarray}
and yield
%\begin{subequations}
%  \begin{align}
%    \varsigma_\beta \frac{\xi_\beta}{\wavenumber_0 n_\beta}  E_{\beta \ppol,0} &= 0 \\
%    \varsigma_\beta E_{\beta \spol,0} &= E_{in} \\
%    \varsigma_\beta \wavenumber_0 n_\beta E_{\beta\ppol,0} &= 0  \\
%    \varsigma_\beta \xi_{\beta} E_{\beta \spol,0} &= \xi_{in} E_{in}
%  \end{align}
%\end{subequations}
%\begin{subequations}
%  \begin{align}
%    \frac{\xi_t}{\wavenumber_0 n_\materialtwo}  E_{t \ppol,0} 
%  - \frac{\xi_r}{\wavenumber_0 n_\materialone}  E_{r \ppol,0} &= 0 
%  \\
%    E_{t \spol,0} - E_{r \spol,0} &= E_{in} 
%  \\    
%    \wavenumber_0 n_\materialtwo E_{t \ppol,0} 
%  - \wavenumber_0 n_\materialone E_{r \ppol,0} &= 0  
%  \\
%    \xi_{t} E_{t \spol,0} 
%  - \xi_{r} E_{r \spol,0} &= \xi_{in} E_{in}
%  \end{align}
%\end{subequations}
\begin{subequations}
  \begin{eqnarray}
    E_{t \ppol,0} &=& 0 \\
    E_{r \ppol,0} &=& 0 \\ 
    E_{t \spol,0} &=& \frac{ 2 \xi_{in}        }{\xi_{in} + \xi_t} E_{in} \\
    E_{r \spol,0} &=& \frac{ \xi_{in} - \xi{t} }{\xi_{in} + \xi_t} E_{in} 
  \end{eqnarray}
\end{subequations}
For lossless media, and the choice of the root $n_\beta > 0$, 
we replace $\xi_\beta = \wavenumber_0 n_\beta \cos \theta_\beta$, where $\theta$ is the ray direction
and yield the textbook Fresnel formulas \cite{Jackson, BornWolf}
\begin{subequations}
  \begin{eqnarray}
    E_{t \spol,0} &=& \frac{ 2 n_\materialone \cos \theta_{in} }
                           { n_\materialone \cos \theta_{in} + n_\materialtwo \cos \theta_t } E_{in}  
    \\[2ex]
    E_{r \spol,0} &=& \frac{ n_\materialone \cos \theta_{in} - n_\materialtwo \cos \theta_t }
                           { n_\materialone \cos \theta_{in} + n_\materialtwo \cos \theta_t } E_{in} 
  \end{eqnarray}
\end{subequations}



\paragraph{p-polarized incidence.}
We choose p-polarized incident light 
\begin{eqnarray}
\Efield_{in} &=& \frac{\xi_{in} \Vector{e}_X - \wavenumber_X \Vector{n}}{\normconst_{in}} E_{in} 
\end{eqnarray}
and yield

\begin{subequations}
\begin{eqnarray}
    E_{r \spol,0} &=& 0 \\ 
    E_{t \spol,0} &=& 0 \\
    E_{r \ppol,0} 
    &=&
    \frac{
      \scalarpermittivity_\materialtwo \xi_{in} 
      -
      \scalarpermittivity_\materialone \xi_t
    }
    {
      \scalarpermittivity_\materialtwo \xi_{in}
      +
      \scalarpermittivity_\materialone \xi_t 
    }
    E_{in} 
  \\
    E_{t \ppol,0} 
    &=& 
    \frac{\normconst_t}{\normconst_{in}}
    \cdot
    \frac{
      2 \scalarpermittivity_\materialone \xi_{in}
    }
    {
      \scalarpermittivity_\materialtwo \xi_{in}
      +
      \scalarpermittivity_\materialone \xi_t 
    }
    E_{in} 
\end{eqnarray}
\end{subequations}


For lossless media, and the choice of the root $n_\beta > 0$, 
we replace $\xi_\beta = \wavenumber_0 n_\beta \cos \theta_\beta$, where $\theta$ is the ray direction
and yield the textbook Fresnel formulas \cite{Jackson, BornWolf}
\begin{subequations}
  \begin{align}
    E_{r \ppol,0} &= \frac{ n_\materialtwo \cos \theta_{in} - n_\materialone \cos \theta_t }
                          { n_\materialtwo \cos \theta_{in} + n_\materialone \cos \theta_t } E_{in}
  \\
    E_{t \ppol,0} &= \frac{ 2 n_\materialone \cos \theta_{in} }
                          {   n_\materialtwo \cos \theta_{in} + n_\materialone \cos \theta_t } E_{in}
  \end{align}
\end{subequations}


\subsection{Summary}
We can calculate reflection and refraction wavevectors and their Fresnel coefficients the following way:
\begin{enumerate}
 \item Intersect ray with surface, determine local surface normal $\Vector{n}$ and incident in-plane wavevector component $\Wavevector_\parallel$
 \item Calculate all 4 wavevector solutions $\xi$ for the conserved in-plane wavevector component $\Wavevector_\parallel$ 
       according to material dispersion \eqref{eq:generalDispersionEigenEquationindex} in each material
 \item For each solution $\xi$, calculate the eigen-polarisation $\Vector{e}_{\beta\alpha}$.
       The eigen-polarisations are the eigenvectors of the dispersion relation \eqref{eq:generalDispersionEigenEquationindex}.
 \item Construct refracted and reflected wavevectors $\Wavevector_{\beta\alpha} = \Wavevector_\parallel + \xi_{\beta\alpha} \Vector{n}$
 \item Choose the 2 solutions in each material $\alpha$ carrying energy away from the surface
       \remark{todo: check validity in the case of gain media}
 \item From $\xi$s, eigen vectors and incident ray properties calculate the Fresnel coefficients \eqref{eq:fresnel_equation_system_general}.
       The Fresnel coefficients determine the amplitude of each mode $\beta\alpha$ 
       and allow to calculate the amount of energy transferred into each mode.
\end{enumerate}


\chapter{Geometrical Optics}
In geometrical optics, we assume that radiation is propagated in rays. Rays are thin, collimated beams. 
We assume that the rims of these beams are negligible compared to the central area. 
Further we assume that all rays are much thinner than the characteristic length of surface curvatures and 
all surfaces are locally approximated planar on the cross-section area of a ray.
Rays act on surfaces like plane waves, and we neglect diffraction effects at the rims of the finite sized beams.
Even in cases where the assumptions are not completely fulfilled, its accuracy compared to experiments is 
astonishing and lead to the great success of technical optics.
However, the optical designer has to check for each calculation whether the ray approximation is justified.

\section{Definitions}

\subsection{General Definitions}
In rotationally symmetric optical systems, we call the axis of symmetry \emph{optical axis}. 
In systems without an axis of symmetry, we try to avoid the the term \emph{optical axis}
and introduce a \emph{pilot ray} (see \ref{sec:ParabasalOptics}).

For imaging systems, we consider an object plane and a image plane with our optical system in between. 
The optical system shall focus all rays originating from a certain point in the object plane into a point or small spot in the image plane.
We call the points in the object and image plane field points.

\begin{figure}
  \centering
   \includegraphics[width=0.5\columnwidth]{pupil}
  \caption{a) In an imaging system without vignetting, the stop acts as aperture for rays from all field points. The rays displayed are on-axis ray (blue), marginal rays (violet), chief ray (red), and coma rays (orange).
  b) In the system shown here, the lens creates a virtual image of the stop, the pupil (green).
  c) The imaging relation between pupil and stop causes rays aimed at the pupil border to be refracted onto the stop border.
  }
  \label{fig:pupil}
\end{figure}

The optical system is capable of transmitting only a certain angular spectrum of the light emitted by each object field point.
We call the component which limits the object sided solid angle of light transmitted to the image for the on-axis field point \emph{stop}.
The stop can be, for example, the clear aperture of a finite sized lens or a metal ring aperture.
If at field points far from the axis also other elements start to clip rays, we call this additional clipping \emph{vignetting}.

The rays emitted by the central (on-axis) field point that hit the border of the stop are called \emph{marginal rays}.
The rays emitted by any non-zero field point that hit the border of the stop are called \emph{coma rays}.
A ray emitted by any non-zero field point that hits the center of the stop is called \emph{chief ray}.
The chief ray is often approximated as the central ray in the transmitted ray bundle emitted by a field point.

We call the plane containing the optical axis (or pilot ray) and the chief ray \emph{meridional} or \emph{tangential plane}, 
and the plane that contains the chief ray and is orthogonal to the meridional plane \emph{sagittal plane}.

\subsection{Pupils}
We divide an optical system in two groups -- elements in front of and behind the stop. 
We consider both groups of optical elements as systems imaging the stop.
We call the image of the stop created by the object sided elements \emph{entrance pupil}, and the image created by the image sided elements \emph{exit pupil}.
Rays in the object and rays in the entrance pupil need to pass the same group of optical elements in order to reach the stop. 
We can regard the propagation of rays from the object to the stop as a free space propagation from the object to the entrance pupil and a subsequent imaging into the stop.
In close analogy, we can image rays from the stop to the exit pupil and perform a free-space propagation from the exit pupil to the image.
This property is often used to determine the marginal and coma angles: 
aiming from the object into the entrance pupil by free-space propagation is much easier than tracing rays from the object to the stop.
Care has to be taken if the front lens group imaging the stop to the pupil suffers from aberrations such as distortion.

\subsection{Cardinal Planes}
todo

\subsection{Principal Planes}
todo


\section{Direction of rays} \label{sec:raydir}
We assume rays propagate along the direction of energy transport.
We assign a unit direction vector $\Vector{d}$ to each ray.
The direction vector points in the direction of the time averaged Poynting vector.
\begin{eqnarray}
 \Vector{d} &=& \frac{\timeavg{\Vector{S}}}{|\timeavg{\Vector{S}}|}
\end{eqnarray}
In isotropic media, the ray direction is the direction of the real part of the wavevector.
In general, the direction of the ray $\Vector{d}$ and its corresponding plane wave phase retardation $\Vector{k}$ may differ.

\subsection{Perturbation}
Assume we have found a particular solution of the dispersion $( \Wavevector, \Efield )$.
Additionally, we have found a particular perturbed solution, 
which also fulfills the dispersion relation for infinitessimal changes 
in wavevector and electric field $( \Wavevector + \totald\Wavevector, \Efield + \totald\Efield)$.
We split the wavevector deviation in a unit direction vector and a real valued perturbation strength $\alpha$
\begin{eqnarray}
 \totald \Wavevector &=& \alpha \Wavevector_\alpha
 \\
 \totald \Efield &=& \alpha \Efield_\alpha
 \\
 \Wavevector_\alpha \overline{\Wavevector}_\alpha &=& 1
\end{eqnarray}
in the limit of infinitessimal perturbation, $\lim_{\alpha \rightarrow 0}$.
The electric field direction $\Efield_\alpha$ is not normalised.
Its amplitude reflects the change of field per change of wavevector.
In the next step, we are interested in the change of the time averaged Poynting vector and consecutively in the ray direction.
\begin{eqnarray}
 \timeavg{\totald S_j} =
  \frac{\alpha}{2\omega \vacuumpermeability} \Re 
  \bigg( &&
      (  \overline{\scalarEfield}_m \delta_{ij} - \overline{\scalarEfield}_j \delta_{im}  )
      \wavenumber_i \scalarEfield_{\alpha\,m}
  \nonumber \\
  &+& 
      (  \scalarEfield_m \delta_{ij} - \scalarEfield_i \delta_{jm}   )
      \wavenumber_i \overline{\scalarEfield}_{\alpha\,m}
  \nonumber \\
  &+& 
      (  \overline{\scalarEfield}_i \scalarEfield_i \delta_{j\ell} - \overline{\scalarEfield}_j \scalarEfield_\ell  )
      \wavenumber_{\alpha\,\ell}
  \qquad \bigg)
\end{eqnarray}





\begin{eqnarray}
 \totald d_i &=& \frac{ \timeavg{S_i} \timeavg{S_j}}{|\timeavg{S}|^3} ( \delta_{ij} - 1 )  \timeavg{\totald S_j}
 \label{eq:ray_direction_perturbation}
\end{eqnarray}
\remark{todo: double check}


\section{Surface Normal}
Assume the surface of a material boundary is given in the form
\begin{eqnarray}
 z &=& z(x,y)
\end{eqnarray}
Two (infinitessimal) local in-plane vectors are 
\begin{eqnarray}
\totald\Vector{e}_1 = \begin{pmatrix}
                 \totald x \\ 0 \\ \frac{\partial z}{\partial x} \totald x
                \end{pmatrix}
\\
\totald\Vector{e}_2 = \begin{pmatrix}
                 0 \\ \totald y \\ \frac{\partial z}{\partial y} \totald y
                \end{pmatrix}
\end{eqnarray}
We normalize these local vectors and form the surface normal, perpendicular to both
\begin{eqnarray}
 \Vector{n} &=& \Vector{e}_1 \times \Vector{e}_2 \\
 &=& 
   \frac{1}{\sqrt{ 1 + \left( \frac{\partial z}{\partial x} \right)^2 + \left( \frac{\partial z}{\partial y} \right)^2 }}
   \begin{pmatrix}
    - \frac{\partial z}{\partial x} \\ - \frac{\partial z}{\partial y} \\ 1
   \end{pmatrix}
\end{eqnarray}

\section{Optical path length}
We define the optical path length as the time of travel of a near-monochromatic wavepacket times the vacuum speed of light.

In the special case of materials that can be described by an isotropic, real valued refractive index, the optical path length functional is given according to the Fermat principle,
\begin{align}
 L &= \int_{s_1}^{s_2} \underbrace{n(\Vector{r}(s)) |\Vector{r}'(s)|}_{=\mathcal{L}} \totald s\,.\label{eq:fermatiso}
\end{align}
with the corresponding ``Lagrangian'' $\mathcal{L}$.
$s$ is the arc length and therefore the derivative $\Vector{r}'(s)$ is a unit vector. (For the Euler Lagrange
equations we may not set it to $1$ at the moment.)

\remark{todo: all other cases; restriction to linear optics}

\section{Lagrange formalism}
\remark{todo: derive Fermat from Maxwell}
\remark{todo: derive Lagrange from Fermat}
\remark{Lagrange and Hamilton work so far only for isotropic media}

Euler-Lagrange-Equations are given by
\begin{align}
 \frac{\totald}{\totald s} \frac{\partial \mathcal{L}}{\partial \Vector{r}'} &= \frac{\partial \mathcal{L}}{\partial \Vector{r}}\,.
\end{align}
The sloppy notation with vector derivatives means a differentiation by components.
\begin{align}
 \frac{\partial \mathcal{L}}{\partial \Vector{r}'} &= n(\Vector{r}(s)) \frac{\Vector{r}'(s)}{|\Vector{r}'(s)|} \stackrel{|\Vector{r}'(s)|=1}{=} n(\Vector{r}(s))\Vector{r}'(s)\,.
\end{align}
Therefore the appropriate differential equation (the so-called equation of motion, EOM) is given by
\begin{align}
 \frac{\totald}{\totald s} \left(n(\Vector{r}(s)) \frac{\totald\Vector{r}}{\totald s}\right) &= (\Vector{\nabla} n)(\Vector{r}(s)) \label{eq:ODEGRIN}\,.
\end{align}
( For a piecewise homogeneous medium the ODE system reduces to a system of algebraic equations 
[btw. this corresponds to a reduction of the
first variation of the integral to a first derivative of the corresponding sum].) 
For our later raytracing the initial conditions are given by:
\begin{subequations}
\label{eq:ODEGRINic}
\begin{align}
 \Vector{r}(s=0) &= (x,y,z)\,,\\
 \Vector{r}'(s=0) &= (d_x, d_y, \sqrt{1-d_x^2-d_y^2})\,,
\end{align}
\end{subequations}
where $\Vector{d}$ is the direction unit vector of some certain ray and $(x,y,z)$ is the starting position.
Now we may integrate \eqref{eq:ODEGRIN} for every set of initial conditions \eqref{eq:ODEGRINic}
and obtain after a (in general numerical) integration a set of values $\Vector{r}(s)$ and $\Vector{r}'(s)$
which correspond to the final position and direction of the ray.

\section{Hamilton formalism}
There are two distinct parametrisations. The first one parametrizes the theory with respect to the
arc length $s$ in 3D space where (one possible choice of) the Hamiltonian is given by
\begin{align}
 H &= \Vector{p}^2 - n^2 = 0\,.
\end{align}
The canonical momentum $\Vector{p}$ is given by $\Vector{p} = n \Vector{d}$. (From this consideration the constraint on
the Hamiltonian becomes clear, since $|\Vector{d}| = 1$.) The canonical equations are given by
\begin{subequations}
\label{eq:H3Deom}
\begin{align}
 \frac{\totald\Vector{q}}{\totald s} &= \frac{\partial H}{\partial \Vector{p}} = 2 \Vector{p}\,,\\
 \frac{\totald\Vector{p}}{\totald s} &= -\frac{\partial H}{\partial \Vector{q}} = 2 n (\Vector{\nabla} n)\,, 
\end{align}
\end{subequations}
The second parametrisation is given by the $z$ position with respect to the optical axis. Here the Hamiltonian is
given by
\begin{align}
 H_{\text{2D}} &= -n(\Vector{Q}, z)\sqrt{1 - \frac{\Vector{P}^2}{n(\Vector{Q}, z)^2}}\label{eq:Hamiltonian2D}\,,
\end{align}
and is equal to the negative component of the 3D momentum.
This comes from the Legendre transformation of the Lagrangian
\begin{align}
 \mathcal{L} &= n(\Vector{Q}, z) \sqrt{1 + V^2}\,,
\end{align}
now parametrized by $z$ as independent variable, $\Vector{Q} = (x,y)$ and $\Vector{V} = (x'(z), y'(z))$.
The Legendre transformation involves first an inversion of the relation
\begin{align}
 \Vector{P} &= \frac{\partial \mathcal{L}}{\partial \Vector{V}} = n(\Vector{Q}, z) \frac{\Vector{V}}{\sqrt{1 + \Vector{V}^2}}\,,
\end{align}
with respect to $\Vector{V}$ and afterwards the calculation of
\begin{align}
 H_{\text{2D}}(\Vector{Q}, \Vector{P},z) &= \scpm{\Vector{P}}{\Vector{V}(\Vector{P})} - \mathcal{L}(\Vector{Q}, z, \Vector{P})\,,
\end{align}
which leads to \eqref{eq:Hamiltonian2D}. The equations of motion due to the canonical formalism 
are therefore given by [remember $\Vector{Q} = (x,y)$, $\Vector{P} = n (d_x, d_y)$]
\begin{subequations}
\label{eq:H2Deom}
\begin{align}
 \frac{\totald\Vector{Q}}{\totald z} &= \frac{\partial H_{\text{2D}}}{\partial \Vector{P}} = \frac{\Vector{P}}{n \sqrt{1 - \frac{\Vector{P}^2}{n^2}}}\,,\\
 \frac{\totald\Vector{P}}{\totald z} &= -\frac{\partial H_{\text{2D}}}{\partial \Vector{Q}} = \frac{\Vector{\nabla}_{\Vector{Q}} n}{\sqrt{1 - \frac{\Vector{P}^2}{n^2}}}\,.    
\end{align}
\end{subequations}
In general $n = n(\Vector{Q}, z)$ holds, so the Hamiltonian depends explicitly on the independent variable.
Therefore for $z$ dependent $n$ the Hamiltonian is no conserved quantity anymore and
\begin{align}
 \frac{\partial H_{\text{2D}}}{\partial z} &= -\frac{\frac{\partial n}{\partial z}}{\sqrt{1 - \frac{\Vector{P}^2}{n^2}}}\,.
\end{align}
(For constant $n$ this formulation is very similar to the Hamiltonian formulation of a 
massive particle in special relativity with imaginary linear momentum.
Therefore nearly all of the results there are applicable here. It is also very useful 
for the paraxial approximation which corresponds to a post-Newtonian expansion.)


\section{Numerical Integration for GRIN Media}
Let us start with the integration of the 3D formulation since it is separable $H = T + U$. Here we use a symplectic integration formalism
due to its symmetry preserving phase space integration structure. For the details we kindly refer the reader to the
literature. A symplectic integrator for a separable Hamiltonian is given by the following scheme with time step $h$:
\begin{align}
 \begin{pmatrix}
  \Vector{q} \\
  \Vector{p}
 \end{pmatrix} \mapsto
 \begin{pmatrix}
  \Vector{q} + c_i h \frac{\partial T}{\partial \Vector{p}} \\
  \Vector{p}
 \end{pmatrix}
\end{align}
and succesively
\begin{align}
 \begin{pmatrix}
  \Vector{q} \\
  \Vector{p}
 \end{pmatrix} \mapsto
 \begin{pmatrix}
  \Vector{q} \\
  \Vector{p} - d_i h \frac{\partial U}{\partial \Vector{q}}
 \end{pmatrix}\,.
\end{align}
For a fourth order scheme $i=1\dots4$ and the coefficients are given by
\begin{align}
 c_1 = c_4 = \frac{1}{2(2 - 2^{1/3})}\,,\\
 c_2 = c_3 = \frac{1 - 2^{1/3}}{2(2 - 2^{1/3})}\,,\\
 d_1 = d_3 = \frac{1}{2 - 2^{1/3}}\,,\\
 d_2 = -\frac{2^{1/3}}{2 - 2^{1/3}}\,\quad d_4 = 0\,.
\end{align}
For a further improvement it may be necessary to use adaptive ``time'' steps.
These can be implemented, e.g., by an extension of the phase space where
the time is an additional canonical coordinate. The extension is achieved by
a so-called Sundman transformation (which is in fact a Poincar{\'e} transformation)
of the ``time'' coordinate
$\totald s/\totald\sigma = g(\Vector{q}, \Vector{p})$.
By using a special form of this transformation $g$ the new Hamiltonian is separable and we
may use a symplectic scheme like the one mentioned above to integrate the new formulation.

\section{Paraxial Optics}
In paraxial optics, we consider centro-symmetric systems with rays close to the optical axis both in real and angular space. 
Parabasal optics decribes rays close to a base ray. 
We describe small fields around the base ray,
allowing for systems with decenter, tilts and freeshapes. 

\subsection{ABCD formalism}
We consider a centro-symmetric optical system. 
That is, all optical elements are symmetric around a common optical axis.
All meridional planes are equivalent.
Without loss of generality, we choose our $z$-axis along the optical axis and consider the meridional $yz$ plane only.
We describe our rays by a $y$ coordinate and its inclination $y^{\,\prime} = \partial y / \partial z$. 
We only consider rays with zero out of plane ($x$) coordinates and directions.
Disregarding sagittal rays, we cannot describe astigmatism in the ABCD formalism.

The ray on the optical axis, $y=0, y^{\,\prime}=0$, is not refracted in the centro-symmetric system.
The next leading order for rays with small height and angle is the linear order, so our model of an optical element in paraxial approximation is

\begin{eqnarray}
 \begin{pmatrix}
  y \\ y^{\,\prime}
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  A & B \\ C & D
 \end{pmatrix}
 \begin{pmatrix}
  y_0 \\ y_0^{\,\prime}
 \end{pmatrix}
\end{eqnarray}

Performing the Taylor expansion in linear order, we find the ABCD-Matrices of typical optical elements. 
\begin{eqnarray}
 \begin{pmatrix}
  1 & \Delta z \\ 0 & 1
 \end{pmatrix}
 && \textrm{propagation in homogeneous media}
 \\
 \begin{pmatrix}
  1 & 0 \\ \left( \frac{n_1}{n_2} - 1 \right) \frac{1}{R} & \frac{n_1}{n_2}
 \end{pmatrix}
 && \textrm{refraction of a thin surface, $n \in \mathbb{R}_{>0}$ }
 \\
 \begin{pmatrix}
  1 & 0 \\ -\frac{2}{R} & 1
 \end{pmatrix}
 && \textrm{thin mirror}
 \\
 \begin{pmatrix}
  1 & 0 \\ -\frac{1}{f} & 1
 \end{pmatrix}
 && \textrm{thin lens without immersion}
\end{eqnarray}
Propagation in homogeneous media does not change the ray direction, and refraction at thin surfaces (surfaces with negligible sag) does not change the ray position.

An optical system can be described as concatenation of its optical elements.

\begin{eqnarray}
 \begin{pmatrix}
  y_{im} \\ y_{im}^{\,\prime}
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  A_N & B_N \\ C_N & D_N
 \end{pmatrix}
 \cdot
 ...
 \cdot
 \begin{pmatrix}
  A_2 & B_2 \\ C_2 & D_2
 \end{pmatrix}
 \cdot
 \begin{pmatrix}
  A_1 & B_1 \\ C_1 & D_1
 \end{pmatrix}
 \cdot
 \begin{pmatrix}
  y_{obj} \\ y_{obj}^{\,\prime}
 \end{pmatrix}
\end{eqnarray}
Where the index $1$ describes the element closest to the object.
The elements can be air gaps, single surfaces, or complete lens assemblies.

\subsection{Interpretation of ABCD matrices}
Let's consider we have a given ABCD matrix of an optical system and want to know the system's first order optical properties.

\begin{eqnarray}
  y_{im} &=& A y_{obj} + B y_{obj}^{\,\prime}
  \\ 
  y_{im}^{\,\prime} &=& C y_{obj} + D y_{obj}^{\,\prime}
\end{eqnarray}

\subsubsection{Focal Length}
We consider a collimated ray bundle $y_{obj}^{\,\prime} = 0$.
We define the image sided paraxial focal length as the distance between image sided principal plane and image.
In the principal plane, the collimated marginal ray has the height $y_{obj}$ and inclination $y_{im}^{\,\prime}$, bending towards the focal point.
\begin{eqnarray}
 f_{im} &:=& - \frac{ y_{obj} }{ y_{im}^{\,\prime} } 
 \\
 f_{im} &=& - \frac{ 1 }{ C } \\ 
\end{eqnarray}

To determine the object sided focal length, we illuminate the system with a collimated beam from the image side $y_{im}^{\,\prime}=0$.
\begin{eqnarray}
 \begin{pmatrix}
  A & B \\ C & D
 \end{pmatrix}^{-1}
 \cdot
 \begin{pmatrix}
  y_{im} \\ y_{im}^{\,\prime}
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  y_{obj} \\ y_{obj}^{\,\prime}
 \end{pmatrix}
\\
  \begin{pmatrix}
  A & B \\ C & D
 \end{pmatrix}^{-1}
 &=&
 \frac{1}{AD-BC}
  \begin{pmatrix}
  D & - B \\ -C & A
 \end{pmatrix}
\end{eqnarray}
We obtain in close analogy to the image sided focal length
\begin{eqnarray}
 f_{obj} &=& - \frac{AD-BC}{C}
\end{eqnarray}
In systems with classical lens elements only and without immersion, 
we find equal focal lengths on object and image side. The determinant of the ABCD matrix is then equal to one.

\subsubsection{Finite Conjugate Systems}
In object sided finite conjugate systems, each point in object space $y_{obj}$ is a field point, 
emitting a cone of rays $y_{obj}^{\,\prime}$.

Imaging is achieved, if rays cast from an object sided field point are joined in an image sided point.
The image point is reached independently from the ray direction in the object plane.

\begin{eqnarray}
   y_{im} &=& A y_{obj} \\
   B &=& 0
\end{eqnarray}

We call $A = y_{im} / y_{obj}$ magnification of the system.
$A$ is unitless.
Once the imaging condition is fulfilled, all rays originating from an object field point are focused stigmatically to the corresponding image point. 
The ABCD formalism calculates first order properties only.
If the ABCD matrices are calculated with a corresponding dispersion model, lateral and transversal first order chromatic aberrations can be modeled.
Also, the paraxial ABCD ray trace may be the base for calculating the Seidel coefficients.

In case $B$ is nonzero, the imaging condition can often be achieved by changing an air gap size. Most often the image sided distance is refocused.
\begin{eqnarray}
 \begin{pmatrix}
  \tilde{A} & \tilde{B} \\ \tilde{C} & \tilde{D}
 \end{pmatrix}
 =
 \begin{pmatrix}
  1 & \Delta z_{im} \\ 0 & 1
 \end{pmatrix}
 \cdot
 \begin{pmatrix}
  A & B \\ C & D
 \end{pmatrix}
 &=&
  \begin{pmatrix}
  A + C \Delta z_{im} & B + D \Delta z_{im} \\ C & D
 \end{pmatrix}
 \label{eq:abcd_refocusing}
\end{eqnarray}
We choose $\Delta z_{im} = - B / D $. Note that $\tilde{A}$ is equal to the magnification \emph{only} if the imaging condition is met. 
Otherwise, the matrix element has no physical meaning.
In particular, it is unsuitable to deduct information about the telecentricity of an imaging system.
The magnifictaion $\tilde{A}$ after refocusing is
\begin{eqnarray}
 \tilde{A} &=& A - \frac{BC}{D}
\end{eqnarray}



\subsubsection{Infinite to Finite Conjugate Systems}
In object sided infinite conjugate systems, each direction in object space $y^{\,\prime}_{obj}$ corresponds to a field point, 
emitting a collimated bundle of rays.

\begin{eqnarray}
   y_{im} &=& B y^{\,\prime}_{obj} \\
   A &=& 0
\end{eqnarray}

We call $B = y_{im} / y^{\,\prime}_{obj}$ magnification of the system.
The unit of $B$ is length units per radian.

In case the imaging condition $A=0$ is not achieved, we try to refocus the last surface (see eq. \ref{eq:abcd_refocusing}).
We choose $\Delta z_{im} = - A / C $.
The magnifictaion $\tilde{B}$ after refocusing is
\begin{eqnarray}
 \tilde{B} &=& B - \frac{AD}{C} 
\end{eqnarray}
In systems with classical lens elements only and no immersion, the determinant of the ABCD matrix is 1, and the magnification simplifies to
\begin{eqnarray}
 \tilde{B} &=& - \frac{1}{C} 
\end{eqnarray}


\subsubsection{Finite to Infinite Conjugate Systems}
In image sided infinite conjugate systems, each point in object space $y_{obj}$ emits a cone of rays, 
that is collimated by the optical system.

\begin{eqnarray}
   y^{\,\prime}_{im} &=& C y_{obj} \\
   D &=& 0
\end{eqnarray}

We call $C = y^{\,\prime}_{im} / y_{obj}$ magnification of the system.
The unit of $C$ is radian per length unit.
In case $D$ is nonzero, we try to fulfill the imaging condition by adding an object sided air gap.
\begin{eqnarray}
 \begin{pmatrix}
  \tilde{A} & \tilde{B} \\ \tilde{C} & \tilde{D}
 \end{pmatrix}
 =
 \begin{pmatrix}
  A & B \\ C & D
 \end{pmatrix}
 \cdot
  \begin{pmatrix}
  1 & \Delta z_{obj} \\ 0 & 1
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  A\qquad & A \Delta z_{obj} + B \\
  C\qquad & C \Delta z_{obj} + D 
 \end{pmatrix}
\end{eqnarray}
We choose $\Delta z_{obj} = - D / C$.
The magnifictaion $\tilde{C}$ after shifting the object distance is
\begin{eqnarray}
 \tilde{C} &=& C 
\end{eqnarray}


\subsubsection{Infinite Conjugate Systems}
In both sided infinite conjugate systems, imaging is achieved if collimated ray bundles are transfered into collimated ray bundles.

\begin{eqnarray}
   y^{\,\prime}_{im} &=& D y^{\,\prime}_{obj} \\
   C &=& 0
\end{eqnarray}

We call $D = y_{im} / y^{\,\prime}_{obj}$ angular magnification of the system.
$D$ is unitless.

An infinite to infinite system cannot be refocused by adding a finite air distance on either object or image side.

\section{Parabasal Optics} \label{sec:ParabasalOptics}

\subsection{Motivation}

The ABCD ansatz allows for very fast calculations and is invaluable in the pre-design stage.
Its simplicity, however, comes with the restriction to meridional rays in centro-symmetric systems and the need for an optical axis.

In systems like Offner systems or off-axis parabolic mirrors, the center-of-field chief ray is no more aligned with the axis of rotational symmetry of the surfaces.
In these systems, it is no longer sufficient to obtain first order properties from the central curvature on the axis of symmetry of each surface.
In other systems, like freeshape Schiefspiegler telescopes, there is no axis of symmetry at all. 
Anamorphotic systems, on the other hand, often have an optical axis, but do not have the same effective surface curvature in all meridional planes.

In this section, we develop a description for the first order properties of optical systems 
and describe rotationally symmetric and non-symmetric systems with a single formalism.
It is a formalism for rays close to the center-of-field chief ray, which we call \emph{pilot ray} in the following.
This pilot ray takes the role of the optical axis in rotationally symmetric systems. 
By choosing the term pilot ray, we want to avoid confusions with mechanical symmetry axes of sub-systems.
In many systems, the intial pilot ray direction is perpendicular to the object plane. 
An exception is found, for example, in Scheimpflug systems.

\subsection{Operator Ansatz}
Our ansatz is to perform a real ray trace of the pilot ray and describe a small area around it by a Taylor expansion around the real ray intersection point.
From this Taylor expansion, we derive first order properties, like focal length, magnification, aperture size, pupils, and image position.
The concept is a parabasal approximation around a non-paraxial pilot ray.
It is a generalization of the ABCD formalism. 
We describe the vectorial deviation from the pilot ray position and direction.
We consider near-pilot rays, that have an intersection point and a wavevector close to the pilot ray.

\begin{tabular}{ l | l | l }
		    & \text{pilot ray} & \text{near-pilot ray} \\
& & \\ \hline & & \\
intersection point  & $\Vector{r}_{\pilot}$ & ${\Vector{r}} = \Vector{r}_{\pilot} + \Delta\Vector{r}$ \\
wavevector  & $\Wavevector_{\pilot}$ & ${\Wavevector} = \Wavevector_{\pilot} + \Delta\Wavevector$ \\
ray direction  & $\Vector{d}_{\pilot}$ & ${\Vector{d}} = \Vector{d}_{\pilot} + \Delta\Vector{d}$ \\
surface normal      & $\Vector{n}_{\pilot} = \Vector{n}(\Vector{r}_{\pilot})$ & ${\Vector{n}} = \Vector{n}({\Vector{r}}) = \Vector{n}_{\pilot} + \Delta\Vector{n}$ \\
\end{tabular}\\[2ex]
We represent the propagation of these deviations through the optical system by a propagation operator $\hat{G}$
\begin{eqnarray}
 \begin{pmatrix}
  \Delta \Vector{r}_\im \\ \Delta \Wavevector_\im
 \end{pmatrix}
 &=&
 \hat{G}
 \begin{pmatrix}
  \Delta \Vector{r}_\obj \\ \Delta \Wavevector_\obj
 \end{pmatrix}
\end{eqnarray}
We are interested in rays close to the pilot ray, $\Delta \Vector{r}_\obj, \Delta \Wavevector_\obj \rightarrow 0$,
so we approximate the operators by a Taylor expansion around the pilot ray
\begin{eqnarray}
 \begin{pmatrix}
  \Delta \Vector{r}_\im \\ \Delta \Wavevector_\im
 \end{pmatrix}_i
 &=&
   G^{00}_i
 + G^{10}_{ij} \Delta r_j
 + G^{01}_{ij} \Delta k_j
 + G^{11}_{ijm} \Delta r_j \Delta k_m
 + G^{20}_{ijm} \Delta r_j \Delta r_m
 + G^{02}_{ijm} \Delta k_j \Delta k_m
 + ...\nonumber\\
\end{eqnarray}
The two upper indices denote the order in $\Delta \Vector{r}$ and $\Delta \Vector{k}$, respectively.
By definition, the propagator $\hat{G}$ projects the object sided pilot ray onto the image sided pilot ray,
that is $\hat{G}(\Vector{0}) = \Vector{0}$ or $\hat{G}^{00} = \hat{0}$. 
In analogy to the ABCD formalism, we neglect terms quadratic or higher in the change of direction or position, 
$\orderof{\Delta\Wavevector^2}$ and $\orderof{\Delta\Vector{r}^2}$.
\begin{eqnarray}
 \begin{pmatrix}
  \Delta \Vector{r}_\im \\ \Delta \Wavevector_\im
 \end{pmatrix}_i
 &\approx&
   G^{10}_{ij} \Delta r_j
 + G^{01}_{ij} \Delta k_j
 + G^{11}_{ijm} \Delta r_j \Delta k_m
\end{eqnarray}
In contrast to the ABCD formalism, we do not drop the bilinear $\hat{G}^{11}$ term right away.
\remark{todo: write a more elegant explanation why all quadratic forms but the bilinear one are dropped.}
In the following, we discuss the representation of the operators by matrices, 
the rank of the matrices and the base of $\Delta \Vector{r}$ and $\Delta \Wavevector$.

\subsection{Near-Pilot Base Systems}

The deviations may not be chosen freely, but we need to choose
$\Delta\Vector{r}$, $\Delta\Wavevector$ and $\Delta\Vector{d}$ 
in a way so that both pilot and near-pilot rays
have valid properties.
Intersection points must lay on the surface,
wavevectors must obey the dispersion relation 
and ray direction vectors must be of unit length.
This limits the degrees of freedom for the deviations.

\subsubsection{Intersection points}

We demand that near-pilot intersection points are on the surface.
In parabasal approximation, we assume each surface planar in a small area around the pilot ray intersection point.
That is, we neglect surface curvature increasing quadratically with the deviation. 
We represent the ray height in this plane by
\begin{eqnarray}
 \Delta\Vector{r} = X \Vector{e}_{X} + Y \Vector{e}_{Y}
 \label{eq:deltaR_equals_XY}
\end{eqnarray}
where $\Vector{e}_{X}$ and $\Vector{e}_{Y}$ are in the tangential surface plane.
$\Vector{e}_{X,Y}$ shall be real valued unit vectors and orthogonal on each other.

\subsubsection{Wavevectors}
Both pilot and near-pilot wavevector must fulfill the dispersion relation. 
In contrast to the real valued ray directions, wavevectors may be complex valued.
Using \eqref{eq:perturbed_wavevector}, we determine the directions 
along which wavevectors may be changed, still obeying the dispersion relation.
We represent the change of the wavevector $\Wavevector$ as
\begin{eqnarray}
 \Delta \Wavevector &=& U \Vector{e}_U + V \Vector{e}_V
\end{eqnarray}
where $U,V$ are complex valued prefactors.
The complex valued unit vectors $\Vector{e}_{U,V}$ shall be orthogonal on each other.

\section{6D XYUV Matrices}
We choose the object sided base vectors 
$\Vector{e}_{X,Y,U,V\,obj}$ 
in a way that both pilot and near-pilot rays start in the object plane and obey the dispersion relation, 
as described in the previous section.
We trace the pilot ray to the final surface 
and define the near-pilot base vectors in the final plane
$\Vector{e}_{X,Y,U,V\,fin}$.
We split up the $\hat{G}$ operators into separate operators for location and direction.
\begin{eqnarray}
 \Delta r_{\im,\,i}  &=& A_{ij} \Delta r_{\obj,\,j} + B_{ij} \Delta k_{\obj,\,j} + M_{ijm} \Delta r_{\obj,\,j} \Delta k_{\obj,\,m} \\ 
 \Delta \wavenumber_{\im,\,i} &=& C_{ij} \Delta r_{\obj,\,j} + D_{ij} \Delta k_{\obj,\,j} + N_{ijm} \Delta r_{\obj,\,j} \Delta k_{\obj,\,m}
\end{eqnarray}
We name the linear operators $\hat{A}, \hat{B}, \hat{C}, \hat{D}$ in analogy to the ABCD formalism.
We name the bilinear operators $\hat{M}$ and $\hat{N}$.

We abbreviate $(X,Y)$ as a vector of location deviation $\Vector{R}$
and $(U,V)$ as a vector of wavevector deviation $\Vector{K}$.
We split up $U$ and $V$ in its real and imaginary part.
\begin{subequations}
\label{eq:definition_of_parabasal_R_and_K_vectors}
\begin{eqnarray}
\Vector{R} &=&
 \begin{pmatrix}
  X \\ Y
 \end{pmatrix}
 \\
 \Vector{K} &=&
 \begin{pmatrix}
  \Re U \\ \Re V \\ \Im U \\ \Im V 
 \end{pmatrix}
\end{eqnarray}
\end{subequations}
The propagator equation becomes
\begin{subequations}
\label{eq:parabasal_imaging_equation}
\begin{eqnarray}
 \Vector{R}_\im &=& \hat{A} \cdot \Vector{R}_\obj + \hat{B} \cdot \Vector{K}_\obj + \hat{M} \cdot \Vector{R}_\obj \cdot \Vector{K}_\obj\label{eq:xyuv_imaging_equation}\\
 \Vector{K}_\im &=& \hat{C} \cdot \Vector{R}_\obj + \hat{D} \cdot \Vector{K}_\obj + \hat{N} \cdot \Vector{R}_\obj \cdot \Vector{K}_\obj
\end{eqnarray}
\end{subequations}
the operators $\hat{A},\hat{B},\hat{C},\hat{D},\hat{M},\hat{N}$ are represented by the Jacobi matrices
\begin{align}
 A_{ij} &=
   \left.
     \frac{\partial R_{i\,im}}{\partial R_{j\,obj}} 
   \right|_{\Vector{K_\obj}=0}
   & (2\times2 \,\textrm{matrix})
 \\
 B_{ij} &=
   \left.
     \frac{\partial R_{i\,im}}{\partial K_{j\,obj}} 
   \right|_{\Vector{R_\obj}=0}
   & (2\times4 \,\textrm{matrix})
 \\
 C_{ij} &=
   \left.
     \frac{\partial K_{i\,im}}{\partial R_{j\,obj}} 
   \right|_{\Vector{K_\obj}=0}
   & (4\times2 \,\textrm{matrix})
 \\
 D_{ij} &=
   \left.
     \frac{\partial K_{i\,im}}{\partial K_{j\,obj}} 
   \right|_{\Vector{R_\obj}=0}
   & (4\times4 \,\textrm{matrix})
 \\
 M_{ijl} &=
     \frac{\partial^2 R_{i\,im}}{\partial R_{j\,obj}\partial K_{l\,obj}} 
   & (2\times2\times4 \,\textrm{matrix})
 \\
 N_{ijl} &=
     \frac{\partial^2 K_{i\,im}}{\partial R_{j\,obj}\partial K_{l\,obj}} 
   & (4\times2\times4 \,\textrm{matrix})
\end{align}


To analytically obtain matrices of the total propagation from object to image, 
it is easiest to concatenate the matrices of all atomic propagation, refraction, reflection, and coordinate transformation operations,
using \eqref{eq:xyuv_total_propagation}.
To obtain these atomic matrices, we perform Taylor expansions around the pilot ray.

For systems where an explicit calculation is not possible
-- or the operator suffers from laziness --
it can be approximated by differential quotients of real ray traces of rays with small but finite differences.
While this numerical approach is easy to implement, it may introduce additional inaccuracies or instabilities.

\subsection{Sequence of Propagators}
In case the path from object to image is built up from subsystems that are subsequently passed, 
and we know the propagator of each subsystem $\hat{G}_i$,
we can write
\begin{eqnarray}
 \begin{pmatrix}
  \Delta \Vector{r}_\im \\ \Delta \Wavevector_\im
 \end{pmatrix}
 &=&
 \hat{G}_N \cdot \hat{G}_{N-1} \cdot ... \cdot \hat{G}_3 \cdot \hat{G}_2 \cdot \hat{G}_1 \cdot \hat{G}_0 \cdot
 \begin{pmatrix}
  \Delta \Vector{r}_\obj \\ \Delta \Wavevector_\obj
 \end{pmatrix}
\end{eqnarray}
In general, the operators do not commutate. $\hat{G}_0$ is the propagator representing the subsystem adjacent to the object.
In the following, we consider the most simple case: the case of two subsystems.
\begin{eqnarray}
 \Delta \Vector{r}_2  &=& \hat{A}_1 \Delta \Vector{r}_1 + \hat{B}_1 \Delta \Vector{k}_1 + \hat{M}_1 \Delta \Vector{r}_1 \Delta \Vector{k}_1 \\ 
 \Delta \Wavevector_2 &=& \hat{C}_1 \Delta \Vector{r}_1 + \hat{D}_1 \Delta \Vector{k}_1 + \hat{N}_1 \Delta \Vector{r}_1 \Delta \Vector{k}_1 \\
 \Delta \Vector{r}_1  &=& \hat{A}_0 \Delta \Vector{r}_0 + \hat{B}_0 \Delta \Vector{k}_0 + \hat{M}_0 \Delta \Vector{r}_0 \Delta \Vector{k}_0 \\ 
 \Delta \Wavevector_1 &=& \hat{C}_0 \Delta \Vector{r}_0 + \hat{D}_0 \Delta \Vector{k}_0 + \hat{N}_0 \Delta \Vector{r}_0 \Delta \Vector{k}_0
\end{eqnarray}
We neglect all quadratic or higher order terms except for the bilinear term and obtain the total operators, 
propagating from surface $0$ to surface $2$:
\begin{subequations}
\begin{eqnarray}
 \Delta \Vector{r}_2  &=& \hat{A}_\tot \Delta \Vector{r}_0 + \hat{B}_\tot \Delta \Vector{k}_0 + \hat{M}_\tot \Delta \Vector{r}_0 \Delta \Vector{k}_0 \\ 
 \Delta \Wavevector_2 &=& \hat{C}_\tot \Delta \Vector{r}_0 + \hat{D}_\tot \Delta \Vector{k}_0 + \hat{N}_\tot \Delta \Vector{r}_0 \Delta \Vector{k}_0
\end{eqnarray}
\end{subequations}
with
\begin{subequations}\label{eq:xyuv_total_propagation}
\begin{eqnarray}
 \hat{A}_\tot &=& \hat{A}_1 \hat{A}_0 + \hat{B}_1 \hat{C}_0 \\
 \hat{B}_\tot &=& \hat{A}_1 \hat{B}_0 + \hat{B}_1 \hat{D}_0 \\
 \hat{C}_\tot &=& \hat{C}_1 \hat{A}_0 + \hat{D}_1 \hat{C}_0\\
 \hat{D}_\tot &=& \hat{C}_1 \hat{B}_0 + \hat{D}_1 \hat{D}_0 \\
 \hat{M}_\tot &=& \hat{A}_1 \hat{M}_0 + \hat{B}_1 \hat{N}_0 + \hat{M}_1 \hat{A}_0 \hat{D}_0 + \hat{M}_1 \hat{B}_0 \hat{C}_0 \\
 \hat{N}_\tot &=& \hat{C}_1 \hat{M}_0 + \hat{D}_1 \hat{N}_0 + \hat{N}_1 \hat{A}_0 \hat{D}_0 + \hat{N}_1 \hat{B}_0 \hat{C}_0
\end{eqnarray}
 \end{subequations}
 
\remark{todo: double check}
\remark{todo: explicit, component wise formula}

\subsection{Inverse Propagation}
Often, we know the propagation operator from plane 0 to plane 1, and we want to know the inverse operator,
propagating from plane 1 back to plane 0.
\begin{eqnarray}
 \begin{pmatrix}
  \Delta \Vector{r}_{0} \\ \Delta \Wavevector_{0}
 \end{pmatrix}
 &=&
 \hat{G}_{\text{inv}}
 \begin{pmatrix}
  \Delta \Vector{r}_{1} \\ \Delta \Wavevector_{1}
 \end{pmatrix}
\end{eqnarray}
To construct the inverse propagation from the forward propagator,
we consider a sequence of forward and backward propagation.
After applying both, we should end up where we started.
\begin{eqnarray}
 \begin{pmatrix}
  \Delta \Vector{r}_{0} \\ \Delta \Wavevector_{0}
 \end{pmatrix}
 &=&
 \hat{G}_{\text{inv}}
 \hat{G}
 \begin{pmatrix}
  \Delta \Vector{r}_{0} \\ \Delta \Wavevector_{0}
 \end{pmatrix}
 =  
 \hat{G}_{tot}
  \begin{pmatrix}
  \Delta \Vector{r}_{0} \\ \Delta \Wavevector_{0}
 \end{pmatrix}
\end{eqnarray}
We represent the operators $\hat{G}, \hat{G}_{\text{inv}}$ and $\hat{G}_{tot}$ by matrices $\hat{A},\hat{B},\hat{C},\hat{D},\hat{M},\hat{N}$.
The matrices representing the \emph{inverse propagator} are marked with an index $_\text{inv}$.
In contrast, an upper $^{-1}$ denotes the \emph{inverse matrix}.
We apply the propagation concatenation equation \eqref{eq:xyuv_total_propagation} on our sequence of forward and inverse propagation and yield:
\begin{subequations}
\begin{eqnarray}
 \hat{A}_\tot &= \unittensor =& \hat{A}_{\text{inv}} \hat{A} + \hat{B}_{\text{inv}} \hat{C} \\
 \hat{B}_\tot &= 0           =& \hat{A}_{\text{inv}} \hat{B} + \hat{B}_{\text{inv}} \hat{D} \\
 \hat{C}_\tot &= 0           =& \hat{C}_{\text{inv}} \hat{A} + \hat{D}_{\text{inv}} \hat{C}\\
 \hat{D}_\tot &= \unittensor =& \hat{C}_{\text{inv}} \hat{B} + \hat{D}_{\text{inv}} \hat{D} \\
 \hat{M}_\tot &= 0           =& \hat{A}_{\text{inv}} \hat{M} + \hat{B}_{\text{inv}} \hat{N} + \hat{M}_{\text{inv}} \hat{A} \hat{D} + \hat{M}_{\text{inv}} \hat{B} \hat{C} \\
 \hat{N}_\tot &= 0           =& \hat{C}_{\text{inv}} \hat{M} + \hat{D}_{\text{inv}} \hat{N} + \hat{N}_{\text{inv}} \hat{A} \hat{D} + \hat{N}_{\text{inv}} \hat{B} \hat{C}
\end{eqnarray}
\end{subequations}
We consider the subsystem of the first four equations and solve it for the inverse propagation matrices.
\begin{eqnarray}
 \begin{pmatrix}
  \hat{A}_{\text{inv}} & \hat{B}_{\text{inv}} \\ \hat{C}_{\text{inv}} & \hat{D}_{\text{inv}}
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  \hat{A} & \hat{B} \\ \hat{C} & \hat{D}
 \end{pmatrix}^{-1}
\end{eqnarray}
or, explicitly,
\begin{eqnarray}
 \begin{pmatrix}
  \hat{A}_{\text{inv}} & \hat{B}_{\text{inv}} \\ \hat{C}_{\text{inv}} & \hat{D}_{\text{inv}}
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  A_{11\,\text{inv}} & A_{12\,\text{inv}} & B_{11\,\text{inv}} & B_{12\,\text{inv}} & B_{13\,\text{inv}} & B_{14\,\text{inv}} \\
  A_{21\,\text{inv}} & A_{22\,\text{inv}} & B_{21\,\text{inv}} & B_{22\,\text{inv}} & B_{23\,\text{inv}} & B_{24\,\text{inv}} \\
  C_{11\,\text{inv}} & C_{12\,\text{inv}} & D_{11\,\text{inv}} & D_{12\,\text{inv}} & D_{13\,\text{inv}} & D_{14\,\text{inv}} \\
  C_{21\,\text{inv}} & C_{22\,\text{inv}} & D_{21\,\text{inv}} & D_{22\,\text{inv}} & D_{23\,\text{inv}} & D_{24\,\text{inv}} \\
  C_{31\,\text{inv}} & C_{32\,\text{inv}} & D_{31\,\text{inv}} & D_{32\,\text{inv}} & D_{33\,\text{inv}} & D_{34\,\text{inv}} \\
  C_{41\,\text{inv}} & C_{42\,\text{inv}} & D_{41\,\text{inv}} & D_{42\,\text{inv}} & D_{43\,\text{inv}} & D_{44\,\text{inv}}
 \end{pmatrix}
 \\
 &=&
 \begin{pmatrix}
  A_{11} & A_{12} & B_{11} & B_{12} & B_{13} & B_{14} \\
  A_{21} & A_{22} & B_{21} & B_{22} & B_{23} & B_{24} \\
  C_{11} & C_{12} & D_{11} & D_{12} & D_{13} & D_{14} \\
  C_{21} & C_{22} & D_{21} & D_{22} & D_{23} & D_{24} \\
  C_{31} & C_{32} & D_{31} & D_{32} & D_{33} & D_{34} \\
  C_{41} & C_{42} & D_{41} & D_{42} & D_{43} & D_{44}
 \end{pmatrix}^{-1}
\end{eqnarray}
The inverse bilinear matrices read
\begin{subequations}
\begin{eqnarray}
 \hat{M}_{\text{inv}} &=& - (\hat{A}_{\text{inv}} \hat{M} + \hat{B}_{\text{inv}} \hat{N}) \cdot \left( ( \hat{A} \hat{D} + \hat{B} \hat{C} )^{-1} \right)\\
 \hat{N}_{\text{inv}} &=& - (\hat{C}_{\text{inv}} \hat{M} + \hat{D}_{\text{inv}} \hat{N}) \cdot \left( ( \hat{A} \hat{D} + \hat{B} \hat{C} )^{-1} \right)
\end{eqnarray}
\end{subequations}

\remark{todo: explicit, component wise formula}

\subsection{Translation in Homogeneous Media}
We consider the propagation between two planes in a homogeneous medium.
In the homogeneous medium, rays are straight lines and the wavevector of each ray is the same in both planes.
We assume the coordinate system to describe wavevector changes is the same in both plane 0 and plane 1.
\begin{eqnarray}
C_{ij} &=& 0 \\
D_{ij} &=& \delta_{ij} \\
N_{ij\ell} &=& 0 \\
\text{for}\qquad \Vector{e}_{U,V\,1} &=& \Vector{e}_{U,V\,0} \nonumber
\end{eqnarray}
The task to determine $\hat{A},\hat{B}, \hat{M}$ remains. 
We consider the ray position in both planes without any Taylor approximation
\begin{align}
 \text{plane 0:} && \Location_0 &= \Location_{0\,\pilot} + X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0} \\
 \text{plane 1:} && \Location_1 &= \Location_{1\,\pilot} + X_1 \Vector{e}_{X1} + Y_1 \Vector{e}_{Y1} \\
 \text{ray :} && \Location_1 &= \Location_{0} + s \cdot \Vector{d}
\end{align}
where $s$ is the geometric path length, and $\Vector{d}$ is the direction unit vector of the ray.
\begin{eqnarray}
\Location_{1\,\pilot} + X_1 \Vector{e}_{X1} + Y_1 \Vector{e}_{Y1} &=& \Location_{0\,\pilot} + X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0}  + s \cdot \Vector{d}
\end{eqnarray}

\begin{eqnarray}
  X_1 \Vector{e}_{X1} + Y_1 \Vector{e}_{Y1} 
  &=& 
  \Location_{0\,\pilot} - \Location_{1\,\pilot} + X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0}  + (s_{\pilot} + \Delta s) ( \Vector{d}_{\pilot} + \Delta \Vector{d} )
\\
  &=& 
  \Location_{0\,\pilot} - \Location_{1\,\pilot} + X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0}  
  + s_{\pilot} \Vector{d}_{\pilot} 
  + s_{\pilot} \Delta \Vector{d} 
  + \Delta s \Vector{d}_{\pilot}
  + \Delta s \Delta \Vector{d}
\\
  &=& 
  X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0}  
  + s_{\pilot} \Delta \Vector{d} 
  + \Delta s \Vector{d}_{\pilot}
  + \Delta s \Delta \Vector{d}
\end{eqnarray}
We build a cartesian coordinate system from $\Vector{e}_{X1}, \Vector{e}_{Y1}$ and $\Vector{e}_{Z1} = \Vector{e}_{X1} \times \Vector{e}_{Y1}$.
The unit vector $\Vector{e}_{Z1}$ points out of plane 1. We represent all vectors in this base

\begin{eqnarray}
  X_1 \Vector{e}_{X1} + Y_1 \Vector{e}_{Y1} 
  =&& 
      X_0 ( (\Vector{e}_{X0} \Vector{e}_{X1}) \Vector{e}_{X1} + (\Vector{e}_{X0} \Vector{e}_{Y1}) \Vector{e}_{Y1} + (\Vector{e}_{X0} \Vector{e}_{Z1} ) \Vector{e}_{Z1}) \nonumber \\
  &+& Y_0 ( (\Vector{e}_{Y0} \Vector{e}_{X1}) \Vector{e}_{X1} + (\Vector{e}_{Y0} \Vector{e}_{Y1}) \Vector{e}_{Y1} + (\Vector{e}_{Y0} \Vector{e}_{Z1} ) \Vector{e}_{Z1}) \nonumber \\  
  &+& (s_{\pilot}+ \Delta s )( (\Delta \Vector{d} \Vector{e}_{X1}) \Vector{e}_{X1} + (\Delta \Vector{d} \Vector{e}_{Y1}) \Vector{e}_{Y1} + (\Delta \Vector{d} \Vector{e}_{Z1} ) \Vector{e}_{Z1}) \nonumber \\  
  &+& \Delta s ( (\Vector{d}_{\pilot} \Vector{e}_{X1}) \Vector{e}_{X1} + (\Vector{d}_{\pilot} \Vector{e}_{Y1}) \Vector{e}_{Y1} + (\Vector{d}_{\pilot} \Vector{e}_{Z1} ) \Vector{e}_{Z1})  
\end{eqnarray}
and compare each coordinate
\begin{eqnarray}
  X_1 &=& X_0 (\Vector{e}_{X0} \Vector{e}_{X1}) + Y_0 (\Vector{e}_{Y0} \Vector{e}_{X1}) + (s_{\pilot}+ \Delta s )(\Delta \Vector{d} \Vector{e}_{X1}) + \Delta s (\Vector{d}_{\pilot} \Vector{e}_{X1}) \\
  Y_1 &=& X_0 (\Vector{e}_{X0} \Vector{e}_{Y1}) + Y_0 (\Vector{e}_{Y0} \Vector{e}_{Y1}) + (s_{\pilot}+ \Delta s )(\Delta \Vector{d} \Vector{e}_{Y1}) + \Delta s (\Vector{d}_{\pilot} \Vector{e}_{Y1}) \\
  0   &=& X_0 (\Vector{e}_{X0} \Vector{e}_{Z1}) + Y_0 (\Vector{e}_{Y0} \Vector{e}_{Z1}) + (s_{\pilot}+ \Delta s )(\Delta \Vector{d} \Vector{e}_{Z1}) + \Delta s (\Vector{d}_{\pilot} \Vector{e}_{Z1} )
\end{eqnarray}
The result is
\begin{subequations}\label{eq:propagation_between_planes_exact_formula}
\begin{eqnarray}
  X_1      &=& \left( X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0} + s_{\pilot}\Delta \Vector{d} + \Delta s \Delta \Vector{d} + \Delta s \Vector{d}_{\pilot} \right) \Vector{e}_{X1} 
  \\
  Y_1      &=& \left( X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0} + s_{\pilot}\Delta \Vector{d} + \Delta s \Delta \Vector{d} + \Delta s \Vector{d}_{\pilot} \right) \Vector{e}_{Y1} 
\end{eqnarray}
\end{subequations}
with
\begin{eqnarray}
  \Delta s &=& -\frac{ \left( X_0 \Vector{e}_{X0} + Y_0 \Vector{e}_{Y0} + s_{\pilot} \Delta \Vector{d} \right) \Vector{e}_{Z1}}
                     { \left( \Vector{d}_{\pilot} + \Delta \Vector{d} \right)\Vector{e}_{Z1}  }
\end{eqnarray}
This is the exact equation for propagation between planes without any approximations.
To fit this result to the XYUV formalism, we approximate in first order
\begin{eqnarray}
  \Delta s &\approx& - \frac{ X_0 e_{X0\,i}e_{Z1\,i} + Y_0 e_{Y0\,i}e_{Z1\,i} + s_{\pilot} \Delta d_i e_{Z1\,i}  }
                            {d_{\pilot\,j} e_{Z1\,j}}
                            \cdot
                            \left(
                            1 - \frac{ \Delta d_{\ell} e_{Z1\,\ell}}{d_{\pilot\,j} e_{Z1\,j}}
                            \right)
\end{eqnarray}
and further
\begin{eqnarray}
  \Delta s \approx &-& \frac{  e_{X0\,i}e_{Z1\,i} }{d_{\pilot\,j} e_{Z1\,j}} X_0 \nonumber\\
                   &-& \frac{  e_{Y0\,i}e_{Z1\,i} }{d_{\pilot\,j} e_{Z1\,j}} Y_0 \nonumber\\
                   &-& \frac{ s_{\pilot}   }{d_{\pilot\,j} e_{Z1\,j}}e_{Z1\,i} \Delta d_i \nonumber\\
                   &+& \frac{ e_{X0\,i}e_{Z1\,i} }{ (d_{\pilot\,j} e_{Z1\,j} )^2 }
                             e_{Z1\,\ell} \Delta d_{\ell} X_0  \nonumber\\
                   &+& \frac{ e_{Y0\,i}e_{Z1\,i} }{ (d_{\pilot\,j} e_{Z1\,j} )^2 }
                             e_{Z1\,\ell} \Delta d_{\ell} Y_0 
\end{eqnarray}
We model the ray direction change in first order as
\begin{eqnarray}
 \Delta \Vector{d} &\approx& \frac{\totald \Vector{d}}{\totald K_i} \cdot K_i
\end{eqnarray}
with $\Vector{K} = (\Re U, \Re V, \Im U, \Im V)$. 
Its explicit form is found in equation \eqref{eq:ray_direction_perturbation}.
Now we can directly read the XYUV matrices from \eqref{eq:propagation_between_planes_exact_formula}.
Additionally, we copy the matrices $\hat{C},\hat{D},\hat{N}$ from above.
\begin{subequations} \label{eq:xyuv_translation_matrices}
\begin{eqnarray}
 \hat{A} &=& a_{j\ell}
 \begin{pmatrix}
  e_{X0j} e_{X1\ell} & e_{Y0j} e_{X1\ell} \\
  e_{X0j} e_{Y1\ell} & e_{Y0j} e_{Y1\ell}
 \end{pmatrix}
\\
 \hat{B} &=& a_{j\ell} s_{\pilot} 
 \begin{pmatrix}
 \frac{\totald d_j}{\totald (\Re U)} e_{X1\ell} & \frac{\totald d_j}{\totald (\Re V)} e_{X1\ell} & \frac{\totald d_j}{\totald (\Im U)} e_{X1\ell} & \frac{\totald d_j}{\totald (\Im V)} e_{X1\ell} \\
 \frac{\totald d_j}{\totald (\Re U)} e_{Y1\ell} & \frac{\totald d_j}{\totald (\Re V)} e_{Y1\ell} & \frac{\totald d_j}{\totald (\Im U)} e_{Y1\ell} & \frac{\totald d_j}{\totald (\Im V)} e_{Y1\ell}
 \end{pmatrix}
\\
\hat{C} &=& 0 \\
\hat{D} &=& \unittensor \\
M_{R_{im}, R_{obj}, K} &=& - a_{j\ell} \frac{ e_{Z1\,i} }{d_{\pilot\,m} e_{Z1\,m}} \frac{\totald d_{j}}{\totald K} e_{R_{obj}\,i} e_{R_{im}\,\ell}  \\
        &=& - \frac{ e_{Z1\,i} e_{R_{obj}\,i} }{d_{\pilot\,m} e_{Z1\,m}} \cdot \frac{B_{R_{im}, K}}{s_{\pilot}}\\
M_{111} &=& - a_{j\ell} \frac{ e_{Z1\,i} }{d_{\pilot\,m} e_{Z1\,m}} \frac{\totald d_{j}}{\totald (\Re U)} e_{X0\,i} e_{X1\ell}  \\
\hat{N} &=& 0
\end{eqnarray}
with
\begin{eqnarray}
 \Vector{e}_{U,V,W,Q\,1} &=& \Vector{e}_{U,V,W,Q\,0} 
 \\
 a_{j\ell} &=& \delta_{j\ell} -  \frac{e_{Z1j} d_{\pilot\ell} }{e_{Z1i} d_{\pilot i}}
\end{eqnarray}
\end{subequations}
\remark{todo: simplification: eZ = npilot}

\subsection{Translation Between Parallel Planes}
We consider the special case of a propagation operator in a homogeneous medium between parallel planes.
Without loss of generality, we choose the same base in both planes $\Vector{e}_{X1} = \Vector{e}_{X0}$ and $\Vector{e}_{Y1} = \Vector{e}_{Y0}$.
The $X$ and $Y$ unit vectors shall be orthogonal on each other, $\Vector{e}_i \Vector{e}_j = \delta_{ij}$.
The propagation matrices \eqref{eq:xyuv_translation_matrices} simplify to

\begin{subequations} \label{eq:xyuv_parallel_translation_matrices}
\begin{eqnarray}
 \hat{A} &=& \unittensor \\
 \hat{B} &=& s_{\pilot} a_{j\ell}
 \begin{pmatrix}
 \frac{\totald d_j}{\totald U} e_{X1\ell} & \frac{\totald d_j}{\totald V} e_{X1\ell} & \frac{\totald d_j}{\totald W} e_{X1\ell} & \frac{\totald d_j}{\totald Q} e_{X1\ell} \\
 \frac{\totald d_j}{\totald U} e_{Y1\ell} & \frac{\totald d_j}{\totald V} e_{Y1\ell} & \frac{\totald d_j}{\totald W} e_{Y1\ell} & \frac{\totald d_j}{\totald Q} e_{Y1\ell}
 \end{pmatrix}
\\
\hat{C} &=& 0 \\
\hat{D} &=& \unittensor \\
\hat{M} &=& 0 \\
\hat{N} &=& 0
\end{eqnarray}
\end{subequations}


\subsection{Translation Sequence}
Hypothesis:
Every concatenation of translation operators can be represented by a single translation operator.
\remark{TODO: proof and explicit formula}


\subsection{Translation Split-Up}
Hypothesis:
Every translation operator can be split up to a set of translations between parallel planes and tilt-only operators (without pilot translation, B=0).
\remark{TODO: proof and explicit formula}


\subsection{Refraction}
We assume two parallel planes 1,2 just in front of and behind a refracting surface.
The planes shall be tangential to the surface at the position of the pilot ray intersection
and shall have identical bases $\Vector{e}_{X,Y}$.
The infinitessimal propagation length through the surface does not change the ray height
\begin{eqnarray}
 \hat{A} &=& \unittensor \\
 \hat{B} &=& 0 \\
 \hat{M} &=& 0
\end{eqnarray}
Deviations from the tangential plane (sag differences due to curvature) 
are an effect quadratic in ray height and are neglected in this linear formalism.

To determine the remaining matrices, we consider the in-plane wavevector.
We represent the wavevector in the cartesian coordinate system
$(\Vector{e}_{\tilde{X}}, \Vector{e}_{\tilde{Y}}, \Vector{n})$,
where $\tilde{X}$ and $\tilde{Y}$ are the in-plane components, 
and $\Vector{n}$ is the normal at the location of the near-pilot ray intersection.
At the location of the pilot ray intersection, this coordinate system is identical to
$(\Vector{e}_{X}, \Vector{e}_{Y}, \Vector{n}_{\pilot})$.
If the surface is curved and the ray height is nonzero, both may deviate infinitessimaly.
The in-plane wavevector is
\begin{eqnarray}
 \wavenumber_{\parallel2i} &=& (\wavenumber_{2j} e_{\tilde{X}j}) e_{\tilde{X}i} + (\wavenumber_{2j} e_{\tilde{Y}j}) e_{\tilde{Y}i} + 0 \cdot n_i
 \\
 &=& \wavenumber_{\tilde{X}} e_{\tilde{X}i} + \wavenumber_{\tilde{Y}} e_{\tilde{Y}i}
\end{eqnarray}
with
\begin{eqnarray}
 \wavenumber_{\tilde{X}} &=& \wavenumber_{\pilot 2 j} e_{\tilde{X}j} + U_2 e_{U2j} e_{\tilde{X}j} + V_2 e_{V2j} e_{\tilde{X}j}
 \\
 \wavenumber_{\tilde{Y}} &=& \wavenumber_{\pilot 2 j} e_{\tilde{Y}j} + U_2 e_{U2j} e_{\tilde{Y}j} + V_2 e_{V2j} e_{\tilde{Y}j}
\end{eqnarray}
The in-plane wavevector is conserved $\Wavevector_{\parallel1} = \Wavevector_{\parallel2}$, 
so we find for medium 1
\begin{eqnarray}
 \wavenumber_{\tilde{X}} &=& \wavenumber_{\pilot 1 j} e_{\tilde{X}j} + U_1 e_{U1j} e_{\tilde{X}j} + V_1 e_{V1j} e_{\tilde{X}j}
 \\
 \wavenumber_{\tilde{Y}} &=& \wavenumber_{\pilot 1 j} e_{\tilde{Y}j} + U_1 e_{U1j} e_{\tilde{Y}j} + V_1 e_{V1j} e_{\tilde{Y}j}
\end{eqnarray}
We substitute $\Wavevector_{\tilde{X}}$, $\Wavevector_{\tilde{Y}}$ and yield
\begin{eqnarray}
 \begin{pmatrix}
  e_{U2j} e_{\tilde{X}j}  &  e_{V2j} e_{\tilde{X}j}
 \\
  e_{U2j} e_{\tilde{Y}j}  &  e_{V2j} e_{\tilde{Y}j}
 \end{pmatrix}
 \cdot
 \begin{pmatrix}  
   U_2 \\ V_2  
 \end{pmatrix}
 &=&
 \begin{pmatrix}
  \wavenumber_{\pilot 1 j} e_{\tilde{X}j} - \wavenumber_{\pilot 2 j} e_{\tilde{X}j} 
 \\
  \wavenumber_{\pilot 1 j} e_{\tilde{Y}j} - \wavenumber_{\pilot 2 j} e_{\tilde{Y}j}
 \end{pmatrix}
 + 
  \begin{pmatrix}
  e_{U1j} e_{\tilde{X}j}  &  e_{V1j} e_{\tilde{X}j}
 \\
  e_{U1j} e_{\tilde{Y}j}  &  e_{V1j} e_{\tilde{Y}j}
 \end{pmatrix}
 \cdot
 \begin{pmatrix}  
   U_1 \\ V_1  
 \end{pmatrix}
\nonumber\\\label{eq:xyuv_refraction_with_implicit_XY_dependence_in_tilde_base}
\end{eqnarray}
This equation allows us to identify terms independent of the wavevector change in medium 1, 
which we associate with the $\hat{C}$ matrix, and terms linear in the wavevector change,
which we associate with $\hat{D}$ and $\hat{N}$.
The dependence on ray height $(X,Y)$ is still implicit in $\Vector{e}_{\tilde{X}}$ and $\Vector{e}_{\tilde{Y}}$
and not linearised to first order.

So let's have a look at the base $\Vector{e}_{\tilde{X}}$ and $\Vector{e}_{\tilde{Y}}, \Vector{n}$.
From \eqref{eq:derivative_of_surface_normal_in_XY_coordinates},
we conclude the normal is in first order approximation
\begin{eqnarray}
 n_j &=& n_{\pilot j} + \frac{\partial n_j}{\partial X} \cdot X + \frac{\partial n_j}{\partial Y} \cdot Y
\end{eqnarray}
The two in-plane base vectors are approximated by the in-plane vectors of the pilot tangential plane, plus terms linear in $(X,Y)$.
We demand the base vectors to be real, of unit length, and orthogonal to the near-pilot normal $\Vector{n}$.
The in-plane coordinates are now fixed up to a roll degree of freedom, and we choose arbitrarily $e_{\tilde{X}j} e_{Yj} = 0$.
\remark{Todo: the inline equation looks ugly}
In first order approximation, we yield
\begin{eqnarray}
 e_{\tilde{X}j} &\approx& e_{Xj} - \left( \frac{\partial n_\ell}{\partial X} e_{X\ell} X + \frac{\partial n_\ell}{\partial Y} e_{X\ell} Y\right) n_{\pilot j}
\\
 e_{\tilde{Y}j} &\approx& e_{Yj} - \left( \frac{\partial n_\ell}{\partial X} e_{Y\ell} X + \frac{\partial n_\ell}{\partial Y} e_{Y\ell} Y\right) n_{\pilot j}
\end{eqnarray}
With this intermediate result, 
we approximate the matrices and vectors in \eqref{eq:xyuv_refraction_with_implicit_XY_dependence_in_tilde_base}
\begin{eqnarray}
 \begin{pmatrix}
  e_{U2j} e_{\tilde{X}j}  &  e_{V2j} e_{\tilde{X}j}
   \\
  e_{U2j} e_{\tilde{Y}j}  &  e_{V2j} e_{\tilde{Y}j}
 \end{pmatrix}
 \approx&&
 \begin{pmatrix}
  e_{U2j} e_{Xj} &  e_{V2j} e_{Xj}
   \\
  e_{U2j} e_{Yj} &  e_{V2j} e_{Yj}
 \end{pmatrix} + 
\nonumber\\&-&
 \begin{pmatrix}
  e_{U2j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell} &  e_{V2j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell}
   \\
  e_{U2j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell} &  e_{V2j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell}
 \end{pmatrix} X + 
\nonumber\\&-&
 \begin{pmatrix}
  e_{U2j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell} &  e_{V2j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell}
   \\
  e_{U2j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell} &  e_{V2j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
 \end{pmatrix} Y 
\\
 \begin{pmatrix}
  e_{U1j} e_{\tilde{X}j}  &  e_{V1j} e_{\tilde{X}j}
 \\
  e_{U1j} e_{\tilde{Y}j}  &  e_{V1j} e_{\tilde{Y}j}
 \end{pmatrix}
 \approx&&
 \begin{pmatrix}
  e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
   \\
  e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
 \end{pmatrix} + 
\nonumber\\&-&
 \begin{pmatrix}
  e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell}
   \\
  e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell}
 \end{pmatrix} X + 
\nonumber\\&-&
 \begin{pmatrix}
  e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell}
   \\
  e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
 \end{pmatrix} Y \qquad\qquad
 \\
 \begin{pmatrix}
  \wavenumber_{\pilot 1 j} e_{\tilde{X}j} - \wavenumber_{\pilot 2 j} e_{\tilde{X}j} 
 \\
  \wavenumber_{\pilot 1 j} e_{\tilde{Y}j} - \wavenumber_{\pilot 2 j} e_{\tilde{Y}j}
 \end{pmatrix}
 \approx&&
  (\wavenumber_{\pilot 2 j} - \wavenumber_{\pilot 1 j}) n_{\pilot j}
  \begin{pmatrix}
   \frac{\partial n_\ell}{\partial X} e_{X\ell}    \\    \frac{\partial n_\ell}{\partial X} e_{Y\ell}
  \end{pmatrix} X + 
\nonumber\\&+&
  (\wavenumber_{\pilot 2 j} - \wavenumber_{\pilot 1 j}) n_{\pilot j}
  \begin{pmatrix}
   \frac{\partial n_\ell}{\partial Y} e_{X\ell}    \\    \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
  \end{pmatrix} Y  
\end{eqnarray}
We invert the first matrix
\begin{eqnarray}
 \begin{pmatrix}
  e_{U2j} e_{\tilde{X}j}  &  e_{V2j} e_{\tilde{X}j}
   \\
  e_{U2j} e_{\tilde{Y}j}  &  e_{V2j} e_{\tilde{Y}j}
 \end{pmatrix}^{-1}
 &\approx&
 \frac{1}{a}
 \cdot
 \begin{pmatrix}
   e_{V2j} e_{Yj} & -e_{V2j} e_{Xj}
   \\
  -e_{U2j} e_{Yj}  & e_{U2j} e_{Xj}
 \end{pmatrix}
 +
 \frac{1}{a^2}
 \cdot
 \hat{F}_X X
 +
 \frac{1}{a^2}
 \cdot
 \hat{F}_Y Y
 \nonumber\\
\end{eqnarray}
with
\begin{eqnarray}
 a =&& e_{U2i} e_{Xi}e_{V2j} e_{Yj}-e_{V2i} e_{Xi}e_{U2j} e_{Yj}
 \\
 \hat{F}_X =&&
 \begin{pmatrix}
   e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
   \\
  -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
 \end{pmatrix}
 \cdot
 \nonumber\\
 &\cdot&
 \begin{pmatrix}
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell})
   \\
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell})
 \end{pmatrix}
 \cdot
 \nonumber\\
 &\cdot&
 \begin{pmatrix}
   e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
   \\
  -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
 \end{pmatrix} 
\\
\hat{F}_Y =&&
 \begin{pmatrix}
   e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
   \\
  -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
 \end{pmatrix} 
 \cdot
 \nonumber\\
 &\cdot&
 \begin{pmatrix}
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell})
   \\
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell})
 \end{pmatrix}
 \cdot
 \nonumber\\
 &\cdot&
 \begin{pmatrix}
   e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
   \\
  -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
 \end{pmatrix} 
\end{eqnarray}
We insert all intermediate results in \eqref{eq:xyuv_refraction_with_implicit_XY_dependence_in_tilde_base} and obtain
\begin{eqnarray}
 \begin{pmatrix}  
   U_2 \\ V_2  
 \end{pmatrix}
 &=&
    \hat{\tilde{C}}
  \begin{pmatrix}
     X \\ Y    
  \end{pmatrix}  
  +
  \hat{\tilde{D}}
  \begin{pmatrix}
   U_1 \\ V_1
  \end{pmatrix}
  +
  \hat{\tilde{N}}_X X
  \begin{pmatrix}
   U_1 \\ V_1
  \end{pmatrix}
  +
  \hat{\tilde{N}}_Y Y
  \begin{pmatrix}
   U_1 \\ V_1
  \end{pmatrix}
  \\
  \hat{\tilde{C}} 
  &=&
     \frac{  (\wavenumber_{\pilot 2 j} - \wavenumber_{\pilot 1 j}) n_{\pilot j}}{ a }
     \cdot
     \begin{pmatrix}
       e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
       \\
      -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
     \end{pmatrix}
     \begin{pmatrix}
       \frac{\partial n_\ell}{\partial X} e_{X\ell} & \frac{\partial n_\ell}{\partial Y} e_{X\ell} 
       \\    
       \frac{\partial n_\ell}{\partial X} e_{Y\ell} & \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
     \end{pmatrix} 
  \\
  \hat{\tilde{D}}
  &=&
     \frac{ 1 }{ a }
     \cdot
     \begin{pmatrix}
       e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
       \\
      -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
     \end{pmatrix}
     \begin{pmatrix}
       e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
       \\
       e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
     \end{pmatrix}
  \\
  \hat{\tilde{N}}_X
  &=&
     \frac{ -1 }{ a }
     \cdot
     \begin{pmatrix}
       e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
       \\
      -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
     \end{pmatrix}
     \begin{pmatrix}
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell}
       \\
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell}
     \end{pmatrix} +
  \nonumber\\
  &&+
  \frac{1}{a^2}
  \hat{F}_X
   \begin{pmatrix}
  e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
   \\
  e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
 \end{pmatrix}
  \\
  \hat{\tilde{N}}_Y
  &=&
     \frac{ -1 }{ a }
     \cdot
     \begin{pmatrix}
       e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
       \\
      -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
     \end{pmatrix}
     \begin{pmatrix}
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell}
       \\
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
     \end{pmatrix} +
  \nonumber\\
  &&+
  \frac{1}{a^2}
  \hat{F}_Y
   \begin{pmatrix}
  e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
   \\
  e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
 \end{pmatrix}
\end{eqnarray}
which we simplify to
\begin{eqnarray}
 \begin{pmatrix} U_2 \\ V_2 \end{pmatrix}
 &=&
    \hat{\tilde{C}}     \begin{pmatrix} X   \\ Y   \end{pmatrix}  
  + \hat{\tilde{D}}     \begin{pmatrix} U_1 \\ V_1 \end{pmatrix}
  + \hat{\tilde{N}}_X X \begin{pmatrix} U_1 \\ V_1 \end{pmatrix}
  + \hat{\tilde{N}}_Y Y \begin{pmatrix} U_1 \\ V_1 \end{pmatrix}
  \\
  \hat{\tilde{C}} 
  &=&
     (\wavenumber_{\pilot 2 j} - \wavenumber_{\pilot 1 j}) n_{\pilot j}
     \cdot \hat{F}_0 \cdot
     \begin{pmatrix}
       \frac{\partial n_\ell}{\partial X} e_{X\ell} & \frac{\partial n_\ell}{\partial Y} e_{X\ell} 
       \\    
       \frac{\partial n_\ell}{\partial X} e_{Y\ell} & \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
     \end{pmatrix} 
  \\
  \hat{\tilde{D}}
  &=&
     \hat{F}_0 \cdot
     \begin{pmatrix}
       e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
       \\
       e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
     \end{pmatrix}
  \\
  \hat{\tilde{N}}_X
  &=& - \hat{F}_0\cdot
     \begin{pmatrix}
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{X\ell}
       \\
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial X} e_{Y\ell}
     \end{pmatrix} +
  \nonumber\\
  &&+\hat{F}_0 \cdot
   \begin{pmatrix}
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell})
   \\
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell})
 \end{pmatrix}
 \cdot \hat{F}_0 \cdot
 \begin{pmatrix}
  e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
   \\
  e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
 \end{pmatrix}
  \\
  \hat{\tilde{N}}_Y
  &=&
     - \hat{F}_0 \cdot
     \begin{pmatrix}
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{X\ell}
       \\
       e_{U1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell} &  e_{V1j} n_{\pilot j} \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
     \end{pmatrix} +
  \nonumber\\
  &&+
  \hat{F}_0 \cdot
   \begin{pmatrix}
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell})
   \\
  (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell})
 \end{pmatrix}
 \cdot \hat{F}_0 \cdot
 \begin{pmatrix}
  e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
   \\
  e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
 \end{pmatrix}
 \\
 \hat{F}_0 &=&
     \frac{1}{a}
     \begin{pmatrix}
       e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
       \\
      -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
     \end{pmatrix}
\end{eqnarray}
which we fullsimplify to
\begin{eqnarray}
 \begin{pmatrix} U_2 \\ V_2 \end{pmatrix}
 &=&
    \hat{\tilde{C}}     \begin{pmatrix} X   \\ Y   \end{pmatrix}  
  + \hat{\tilde{D}}     \begin{pmatrix} U_1 \\ V_1 \end{pmatrix}
  + \hat{\tilde{N}}_X X \begin{pmatrix} U_1 \\ V_1 \end{pmatrix}
  + \hat{\tilde{N}}_Y Y \begin{pmatrix} U_1 \\ V_1 \end{pmatrix}
  \\
  \hat{\tilde{C}} 
  &=&
     (\wavenumber_{\pilot 2 j} - \wavenumber_{\pilot 1 j}) n_{\pilot j}
     \cdot \hat{F}_0 \cdot
     \begin{pmatrix}
       \frac{\partial n_\ell}{\partial X} e_{X\ell} & \frac{\partial n_\ell}{\partial Y} e_{X\ell} 
       \\    
       \frac{\partial n_\ell}{\partial X} e_{Y\ell} & \frac{\partial n_\ell}{\partial Y} e_{Y\ell}
     \end{pmatrix} 
  \\
  \hat{\tilde{D}}
  &=&
     \hat{F}_0 \cdot
     \begin{pmatrix}
       e_{U1j} e_{Xj} &  e_{V1j} e_{Xj}
       \\
       e_{U1j} e_{Yj} &  e_{V1j} e_{Yj}
     \end{pmatrix}
  \\
  \hat{\tilde{N}}_X
  &=& - \hat{F}_0\cdot
     \begin{pmatrix}
       (e_{U1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell}) &  (e_{V1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell}) \\
       (e_{U1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell}) &  (e_{V1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell})
     \end{pmatrix} +
  \nonumber\\
  &&+ \hat{F}_0 \cdot
     \begin{pmatrix}
       (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{X\ell}) \\
       (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial X} e_{Y\ell})
     \end{pmatrix}
     \cdot \hat{\tilde{D}}
  \\
  \hat{\tilde{N}}_Y
  &=&
     - \hat{F}_0 \cdot
     \begin{pmatrix}
       (e_{U1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell}) &  (e_{V1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell}) \\
       (e_{U1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell}) &  (e_{V1j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell})
     \end{pmatrix} +
  \nonumber\\
  &&+ \hat{F}_0 \cdot
     \begin{pmatrix}
       (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{X\ell}) \\
       (e_{U2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell}) &  (e_{V2j} n_{\pilot j}) (\frac{\partial n_\ell}{\partial Y} e_{Y\ell})
     \end{pmatrix}
     \cdot \hat{\tilde{D}}
 \\
 \hat{F}_0 &=&
     \frac{1}{ (e_{U2i} e_{Xi}) (e_{V2j} e_{Yj}) - (e_{V2i} e_{Xi}) (e_{U2j} e_{Yj}) }
     \begin{pmatrix}
       e_{V2i} e_{Yi} & -e_{V2i} e_{Xi}
       \\
      -e_{U2i} e_{Yi}  & e_{U2i} e_{Xi}
     \end{pmatrix}
\end{eqnarray}
We compare to the parabasal equation of propagation
\eqref{eq:parabasal_imaging_equation}
with the $XYUV$ vectors \eqref{eq:definition_of_parabasal_R_and_K_vectors}
and yield the propagator matrices for a refraction operation
\begin{eqnarray}
 \hat{A} &=& \unittensor \\
 \hat{B} &=& 0 \\
 \hat{C} &=&
   \begin{pmatrix}
    \Re \tilde{C}_{11} & \Re \tilde{C}_{12} \\
    \Re \tilde{C}_{21} & \Re \tilde{C}_{22} \\
    \Im \tilde{C}_{11} & \Im \tilde{C}_{12} \\
    \Im \tilde{C}_{21} & \Im \tilde{C}_{22}
   \end{pmatrix}
 \\
 \hat{D} &=&
   \begin{pmatrix}
     \Re \tilde{D}_{11} & \Re \tilde{D}_{12} & - \Im \tilde{D}_{11} & - \Im \tilde{D}_{12} \\
     \Re \tilde{D}_{21} & \Re \tilde{D}_{22} & - \Im \tilde{D}_{21} & - \Im \tilde{D}_{22} \\
     \Im \tilde{D}_{11} & \Im \tilde{D}_{12} &   \Re \tilde{D}_{11} &   \Re \tilde{D}_{12} \\
     \Im \tilde{D}_{21} & \Im \tilde{D}_{22} &   \Re \tilde{D}_{21} &   \Re \tilde{D}_{22} \\
   \end{pmatrix}
 \\
 \hat{M} &=& 0 \\
 \hat{N} &=& N_{[K_{im}, R, K_{obj}]} \\
 \hat{N}_{[:,X,:]} &=&
   \begin{pmatrix}
     \Re \tilde{N}_{X\,11} & \Re \tilde{N}_{X\,12} & - \Im \tilde{N}_{X\,11} & - \Im \tilde{N}_{X\,12} \\
     \Re \tilde{N}_{X\,21} & \Re \tilde{N}_{X\,22} & - \Im \tilde{N}_{X\,21} & - \Im \tilde{N}_{X\,22} \\
     \Im \tilde{N}_{X\,11} & \Im \tilde{N}_{X\,12} &   \Re \tilde{N}_{X\,11} &   \Re \tilde{N}_{X\,12} \\
     \Im \tilde{N}_{X\,21} & \Im \tilde{N}_{X\,22} &   \Re \tilde{N}_{X\,21} &   \Re \tilde{N}_{X\,22} \\
   \end{pmatrix}
 \\
  \hat{N}_{[:,Y,:]} &=&
   \begin{pmatrix}
     \Re \tilde{N}_{Y\,11} & \Re \tilde{N}_{Y\,12} & - \Im \tilde{N}_{Y\,11} & - \Im \tilde{N}_{Y\,12} \\
     \Re \tilde{N}_{Y\,21} & \Re \tilde{N}_{Y\,22} & - \Im \tilde{N}_{Y\,21} & - \Im \tilde{N}_{Y\,22} \\
     \Im \tilde{N}_{Y\,11} & \Im \tilde{N}_{Y\,12} &   \Re \tilde{N}_{Y\,11} &   \Re \tilde{N}_{Y\,12} \\
     \Im \tilde{N}_{Y\,21} & \Im \tilde{N}_{Y\,22} &   \Re \tilde{N}_{Y\,21} &   \Re \tilde{N}_{Y\,22} \\
   \end{pmatrix}
\end{eqnarray}

TODO: double check


\subsection{Image Plane Tilt Compensation}
Hypothesis:
In the 6-dimensional XYUV formalism, 
there are not enough degrees of freedom that a 2D or 3D rotation of the coordinate system could compensate a (2x2x4) image plane tilt matrix.
\remark{TODO: proof and explicit formula}


\section{4D XYUV Matrices}
In many cases, we do not need four degrees of freedom for the wavevector deviation, but two suffice.
Together with the two degrees of freedom for the image height, we have a four-dimensional state Vector ($\Vector{R}, \Vector{K}$).
Coming from the 6-dimensional XYUV formalism, we restrict the wavevectors in the following way:
\begin{itemize}
 \item If all materials are lossless, we restrict ourselves to real valued wavevectors.
       In lossless materials, all permeabilities are real valued, and wavevectors in isotropic materials are either real or purely imaginary.
       We choose the wavevector deviation base $( \Vector{e}_U, \Vector{e}_V)$ real valued and allow only real $(U,V)$.
 \item If one or more materials are lossy, we start in the object plane by choosing two directions.
       We choose the initial directions $( \Vector{e}_{U\,obj}, \Vector{e}_{V\,obj})$ in a way that the
       wavevector difference between pilot and perturbed wavevector is real.
       We achieve this by rotating the wavevector deviation unit vectors in the complex plane.
       Choosing these deviations, we find that any interference between pilot and perturbed wave
       creates a pattern in the image plane which is translationally invariant.
       The interference pattern does not change in modulation over space.
       Next, we perturb one wave purely in direction $\Vector{e}_{U\,obj}$ and one wave purely in $\Vector{e}_{V\,obj}$.
       We propagate these two waves to the next surface, calculate the difference to the pilot wavevector in the new medium,
       and create a new plane from the two difference vectors.
       The new wavevector deviation unit vectors $( \Vector{e}_{U\,surf\,i}, \Vector{e}_{V\,surf\,i})$ shall be normalized and orthogonal on each other.
\end{itemize}
In the reduced unit system with only two real wavevector deviations $(\Re U, \Re V)$,
it may in some cases not be possible to convert old wavevectors in the new unit system.
This may occur, for example, for the evanescent waves of the transmission path after a total internal reflection.
These rays must be deleted by time-consuming if-statements in C, or numpy index slicing in python.
We can easily convert all formulas from the 6-dimensional XYUV formalism by inserting
$\Vector{R} = (X,Y)$ and $\Vector{K} = (\Re U, \Re V, 0, 0)$.
The size of the propagator matrices can be reduced.
\begin{subequations}
\begin{align}
 A_{ij}  && (2\times2 \,\textrm{matrix}) \\
 B_{ij}  && (2\times2 \,\textrm{matrix}) \\
 C_{ij}  && (2\times2 \,\textrm{matrix}) \\
 D_{ij}  && (2\times2 \,\textrm{matrix}) \\
 M_{ijl} && (2\times2\times2 \,\textrm{matrix}) \\
 N_{ijl} && (2\times2\times2 \,\textrm{matrix})
\end{align}
\end{subequations}
The benefit we gain, apart from small matrices, is a better disambiguous invertability of matrices.


\chapter{Surface Intersections}\label{subsec:intersectionformulas}
This section discusses how to calculate the intersection of a ray with a surface.


\section{Analytically Solvable}
\subsection{Biconic}
The word ``conic" is short for conic section. 
This refers to intersections of a plane with a cone.
A biconic describes a surface with two perpendicular sections of conic shape. 
These surfaces have two symmetry planes.
The explicit surface sag formula is given by
\begin{align}
 z &= \frac{\rho_x x^2 + \rho_y y^2}{1 + \sqrt{1 - (1+c_x) \rho_x^2 x^2 - (1+c_y) \rho_y^2 y^2}} \label{eq:biconic}\,.
\end{align}
The variables are $\rho_x = 1/R_x$ the central $x$ curvature, and $\rho_y = 1/R_y$ the central $y$ curvature,.
The curavtures $\rho$ are the inverse of the radii $R$.
$c_x$ is the conic constant in $x$ direction,
and $c_y$ the conic constant in $y$ direction, respectively. 

Depending on the conic constant, the biconic $x$ and $y$ cross sections are a
\begin{eqnarray*}
     c < -1 && \textrm{hyperbola} \\
     c = -1 && \textrm{parabola} \\
-1 < c < 0 && \textrm{prolate ellipse} \\
     c = 0 && \textrm{sphere} \\
 0 < c < 1 && \textrm{oblate ellipse}
\end{eqnarray*}


An invariant or implicit form of the biconic sag equation \eqref{eq:biconic} is given by
\begin{align}
 (a(x,y) - 1) z^2 + (z - b(x,y))^2 &= 0\,,\label{eq:biconicImplicitSag}
\end{align}
where $a(x,y) = (1 + c_x) \rho_x^2 x^2 + (1 + c_y) \rho_y^2 y^2$ and $b(x,y) = \rho_x x^2 + \rho_y y^2$. 

We assume a homogeneous medium and describe the ray as a straight line
\begin{eqnarray}
 \Location &=& \Location_0 + \Vector{d} t \label{eq:ray}
\end{eqnarray}
where $\Location_0$ is the ray start point, 
$\Vector{d}$ the ray direction unit vector and $t$ the free parameter of the straight.
The goal is to find a value for $t$ for which the ray intersects the surface.

Solving the straight equation \eqref{eq:ray} leads to a polynomial of fourth order in $t$.
The fourth order equation can be solved either analytically or numerically.
The one physically valid solution must be real valued.

\remark{todo: surface normal equation for all surface shapes}

\subsection{Simplified Biconic}
We assume a Biconic sag equation \eqref{eq:biconic} in which not all parameters are independent, but the x and y conic constants are linked via
\begin{eqnarray}
 \kappa := (1 + c_x) \rho_x = (1 + c_y) \rho_y
\end{eqnarray}
The coeffcients $a$ and $b$ in the implicit form of the sag equation \ref{eq:biconicImplicitSag} are no longer independent.
\begin{eqnarray}
 a(x,y) &=& \kappa b(x,y) 
\end{eqnarray}

We factor out the invariant sag equation \ref{eq:biconicImplicitSag}

\begin{eqnarray}
 %(a(x,y) - 1) z^2 + (z - b(x,y))^2 &=& 0 \\
 %(a - 1) z^2 + (z - b)^2 &=& 0 \\ 
 %a z^2 - z^2 + z^2 - 2 z b + b^2 &=& 0 \\ 
 (\kappa b) z^2 - 2 z b + b^2 &=& 0 
\end{eqnarray}
and divide this equation by $b$. Care has to be taken for the special case $b=0$. The division reduces the equation from a fourth to second order equation in $(x,y,z)$.
\begin{eqnarray}
 \kappa z^2 - 2 z + b &=& 0
\end{eqnarray}
Inserting the straight equation yields
\begin{eqnarray}
 %(1 + c_x) \rho_x z^2 - 2 z + \rho_x x^2 + \rho_y y^2 &=& 0 \\
 %\kappa z^2 - 2 z + \rho_x x^2 + \rho_y y^2 &=& 0 \\
 %\kappa (z_0+d_z t)^2 - 2 (z_0+d_z t) + \rho_x (x_0+d_x t)^2 + \rho_y (y_0+d_y t)^2 &=& 0 \\
 %\kappa ( z_0^2 + 2 z_0 d_z t + d_z^2 t^2 ) - 2 z_0 - 2 d_z t + \rho_x (x_0^2 +2 x_0 d_x t + d_x^2 t^2) + \rho_y (y_0^2 + 2 y_0 d_y t + d_y^2 t^2) &=& 0 \\
 %\kappa z_0^2 + 2 \kappa z_0 d_z t + \kappa d_z^2 t^2 - 2 z_0 - 2 d_z t + \rho_x x_0^2 + 2 \rho_x x_0 d_x t + \rho_x d_x^2 t^2 + \rho_y y_0^2 + 2 \rho_y y_0 d_y t + \rho_y d_y^2 t^2 &=& 0 \\
 %\left(   \kappa d_z^2 + \rho_x d_x^2 + \rho_y d_y^2   \right) t^2
 %  + 2 \left(  \kappa z_0 d_z - d_z  + \rho_x x_0 d_x + \rho_y y_0 d_y \right) t
 %  + \left( \kappa z_0^2 - 2 z_0 + \rho_x x_0^2 + \rho_y y_0^2 \right) 
 %  &=& 0 \\
 %\left(   \rho_x d_x^2 + \rho_y d_y^2 + \kappa d_z^2   \right) &t^2& \nonumber \\
 %  + 2 \left(  \rho_x x_0 d_x + \rho_y y_0 d_y + ( \kappa z_0 - 1 ) d_z  \right) &t& \nonumber \\
 %  + \left( \rho_x x_0^2 + \rho_y y_0^2 + \kappa z_0^2 - 2 z_0  \right) &&
 %= 0 \\
 H t^2 + 2 F t - G &&
 = 0
\end{eqnarray}
with
\begin{subequations}
\begin{eqnarray}
   F &=& d_z - \left(  \rho_x x_0 d_x + \rho_y y_0 d_y + \kappa z_0 d_z  \right)\,, \\
   G &=& \rho_x x_0^2 + \rho_y y_0^2 + \kappa z_0^2 - 2 z_0 \,, \\
   H &=& - \left(   \rho_x d_x^2 + \rho_y d_y^2 + \kappa d_z^2   \right)
\end{eqnarray}
\end{subequations}

The solution is easily found as
\begin{eqnarray}
  t &=& - \frac{F}{H} + \sqrt{\frac{F^2}{H^2} + \frac{G}{H}}
\end{eqnarray}
The solution in its present form is numerically instable for plane and weakly curved surfaces $\lim H \rightarrow 0$.
We multiply the solution with 1
\begin{eqnarray}
  t &=&  \left( \sqrt{\frac{F^2}{H^2} + \frac{G}{H}} - \frac{F}{H} \right) \frac{\sqrt{\frac{F^2}{H^2} + \frac{G}{H}} + \frac{F}{H}}{\sqrt{\frac{F^2}{H^2} + \frac{G}{H}} + \frac{F}{H}} \\
  t &=&  \frac{ \bigg( \sqrt{\frac{F^2}{H^2} + \frac{G}{H}} \bigg)^2 - \bigg( \frac{F}{H} \bigg)^2 }{\sqrt{\frac{F^2}{H^2} + \frac{G}{H}} + \frac{F}{H}} \\
  t &=& \frac{G}{ F + \sqrt{F^2 + H G} }
\end{eqnarray}

This formulation of the solution is stable for weakly bent surfaces $\rho_x, \rho_y \rightarrow 0$ and also for $b \rightarrow 0$.

The solution exists for positive terms under the square root only, $F^2 + H G > 0$. 
Otherwise, the ray misses the surface.


\subsection{Quadratic Form}
\remark{The quadratic form section is not double checked yet.}

A quadratic form is the lowest order polynomial with curvatures.
It plays an important role for the parabasal approximation.

\begin{eqnarray}
 z(x,y) &=& \frac{1}{2} \rho_{xx} x^2 + \rho_{xy} x y + \frac{1}{2} \rho_{yy} y^2 + m_x x + m_y y + n
 \label{eq:quadratic_form_sag}
\end{eqnarray}
The parameters $\rho_{xx},\rho_{xy},\rho_{yy}$ represent the surface curvature. 
$m_x$ and $m_y$ describe the tilt of the tangential plane in the $xy$ origin, 
and $n$ is an absolute sag offset.
A nonzero $\rho_{xy}$ parameter denotes a nonzero rotation of the principal axes of the paraboloid with respect to the $x$ and $y$ axes.
The solution of the intersection with the straight equation is
\begin{eqnarray}
 F &=& d_z - \left( \rho_{xx} x_0 d_x + \rho_{xy} \left( x_0 d_y + y_0 d_x \right)  + \rho_{yy} y_0 d_y + m_x d_x + m_y d_y \right)   \\
 G &=& - 2 z_0 + \rho_{xx} x_0^2 + 2 \rho_{xy} x_0 y_0 + \rho_{yy} y_0^2 + 2 m_x x_0 + 2 m_y y_0 + 2 n\\
 H &=& - \left( \rho_{xx} d_x^2 +  2 \rho_{xy} d_x d_y + \rho_{yy} d_y^2 \right) \\
 t &=& \frac{G}{ F + \sqrt{F^2 + H G} }
 \label{eq:quadratic_form_t}
\end{eqnarray}

\subsubsection{Surface Normal}
The surface normal of a quadratic form surface is (see \eqref{eq:freeshape_normal})
\begin{eqnarray}
 \Vector{n} &=& \gamma
 \begin{pmatrix}
  - \rho_{xx} x - \rho_{xy} y - m_x
  \\
  - \rho_{xy} x - \rho_{yy} y - m_y
  \\
  1
  \end{pmatrix}
  \\
  \frac{1}{\gamma} &=& \sqrt{ 1 + \left( \rho_{xx} x + \rho_{xy} y + m_x \right)^2 + \left( \rho_{xy} x + \rho_{yy} y + m_y \right)^2}
\end{eqnarray}
and its derivates are
\begin{eqnarray}
 \frac{\partial \Vector{n}}{\partial x} =&&
  \left(
     (\rho_{xx} x + \rho_{xy} y + m_x) \rho_{xx}
   + (\rho_{xy} x + \rho_{yy} y + m_y) \rho_{xy}
  \right)
  \gamma^2 \Vector{n}
  \nonumber\\
  &+&
  \rho_{xx} \gamma \Vector{e}_x
  +
  \rho_{xy} \gamma \Vector{e}_y
\\
 \frac{\partial \Vector{n}}{\partial y} =&&
  \left(
     (\rho_{xx} x + \rho_{xy} y + m_x) \rho_{xy}
   + (\rho_{xy} x + \rho_{yy} y + m_y) \rho_{yy}
  \right)
  \gamma^2 \Vector{n}
  \nonumber\\
  &+&
  \rho_{xy} \gamma \Vector{e}_x
  +
  \rho_{yy} \gamma \Vector{e}_y
\end{eqnarray}
we rewrite this result in the cartesian coordinate system $(\Vector{e}_X, \Vector{e}_Y, \Vector{n})$,
representing vectors by their components in the tangential plane and normal to it, respectively.
The two in-plane unit vectors may be chosen independently 
from the cartesian coordinate system $(\Vector{e}_x, \Vector{e}_y, \Vector{e}_z)$
used to describe the surface sag.
\begin{eqnarray}
 \frac{\partial n_i}{\partial X} = &\gamma \Bigg(&
     \frac{\partial^2 z}{\partial x^2} 
     (e_{xj} e_{Xj})^2
   +2\frac{\partial^2 z}{\partial x \partial y}
     (e_{xj} e_{Xj})(e_{y\ell}e_{X\ell})
   + \frac{\partial^2 z}{\partial y^2}
     (e_{yj}e_{Xj})^2
 \Bigg) e_{Xi} +
\nonumber\\
 &+ \gamma \Bigg(&
     \frac{\partial^2 z}{\partial x^2}
     (e_{xj} e_{Xj})(e_{x\ell}e_{Y\ell})
   + \frac{\partial^2 z}{\partial x \partial y}
     \left( (e_{xj} e_{Xj})(e_{y\ell}e_{Y\ell}) + (e_{xj} e_{Yj})(e_{y\ell}e_{X\ell}) \right) + 
 \nonumber\\
  &&
   + \frac{\partial^2 z}{\partial y^2}
     (e_{yj}e_{Xj})(e_{y\ell}e_{Y\ell})
 \Bigg) e_{Yi}
 \label{eq:derivative_of_surface_normal_in_XY_coordinates}
\end{eqnarray}


\subsection{Conics}
Conics are the rotationally symmetric special case of a biconic $\rho_x = \rho_y$, $c_x = c_y$ .
In the vertex form their surface sag $z$ can be described by
\begin{eqnarray}
 z =  \frac
 { \rho ( x^2 + y^2 ) }
 { 1 + \sqrt{1 - (1+c) \rho^2  (x^2 + y^2)} }\,,
\end{eqnarray}
where $c$ is the conic constant. 
For an explicit solution of the intersection parameter $t$,
one can use the implicit form of the surface equation
\begin{align}
 \rho (1 + c) z^2 - 2 z + \rho (x^2 + y^2) &=0\,.
\end{align}
After insertion of \eqref{eq:ray}, the solution is given by
\begin{subequations}
\label{eq:intersectionconicsection}
\begin{eqnarray}
   F &=& d_z - \rho \left( d_x x_0 + d_y y_0 + d_z z_0 (1+c) \right)\,, \\
   G &=& \rho (x_0^2 + y_0^2 + z_0^2 (1+c)) - 2 z_0\,, \\
   H &=& - \rho ( 1 + c \, d_z^2 )\,, \\
   t &=& \frac{G}{ F + \sqrt{F^2 + H G} }\,.
\end{eqnarray}
\end{subequations}

The unit surface normal of such a conic section pointing in forward (positive $z$) direction is
\begin{eqnarray}
\Vector{n} &=& - \frac{1}{\sqrt{ 1 - \rho^2 c (x^2 + y^2)}} 
  \begin{pmatrix}
   \rho x \\
   \rho y \\
   \rho ( 1 + c ) z - 1
  \end{pmatrix}
\end{eqnarray}




\subsection{Spheres}
\label{subsection:spheres}

We consider a ray and a Sphere that intersects the optical axis in the origin
\begin{eqnarray}
 \left| \Location - \begin{pmatrix} 0 \\ 0 \\ R \end{pmatrix} \right|^2 &=& R^2\,, \label{eq:sphereeq}
\end{eqnarray}
The sphere is a special case of a conic.
\begin{subequations}
\label{eq:spheresolution}
\begin{eqnarray}
   F &=& d_z - \rho \scpm{\Vector{d}}{\Location_0}\,, \\
   G &=& \rho |\Location_0|^2 - 2 z_0\,, \\
   H &=& - \rho\,, \\
   t &=& \frac{G}{ F + \sqrt{F^2 + H G} }\,, \label{eq:tsolsphere}
\end{eqnarray}
\end{subequations}
where $\rho = 1 / R$ is the surface curvature. 

\subsection{Conical Acylinder}
A conical acylinder is the special case $\rho_x=0$ of a biconic. It contains cylindric and simple acylindric lenses like elliptical, parabolic and hyperbolic acylindric lenses.
Without loss of generality, we choose our coordinate system so that the curvature in x-direction vanishes.
This effectively reduces the problem of an intersection in three-dimensional space to a two-dimensional one.

\begin{align}
 z &= \frac{ \rho y^2}{1 + \sqrt{1 - (1+c) \rho^2 y^2}}
\end{align}
The solution is
\begin{eqnarray}
   F &=& d_z - \rho \left(  d_y y_0 + d_z z_0 (1+c) \right) \\
   G &=& \rho ( y_0^2 + z_0^2 (1+c)) - 2 z_0 \\
   H &=& - \rho ( 1 + c \, d_z^2 ) \\
   t &=& \frac{G}{ F + \sqrt{F^2 + H G} }
\end{eqnarray}


\subsection{Cylindric}
A cylindric surface is the special case $c = 0$ of a conical acylinder.
\begin{align}
 z &= \frac{ \rho y^2}{1 + \sqrt{1 - \rho^2 y^2}}
\end{align}
The solution further simplifies to
\begin{eqnarray}
   F &=& d_z - \rho \left(  d_y y_0 + d_z z_0  \right) \\
   G &=& \rho ( y_0^2 + z_0^2 ) - 2 z_0 \\
   H &=& - \rho \\
   t &=& \frac{G}{ F + \sqrt{F^2 + H G} }
\end{eqnarray}


\section{Numerically Solvable}
\subsection{Free Shape with Explicit Sag Formula}
The free shape is the most general case of a surface.
We describe the surface by its explicit sag formula
\begin{eqnarray}
 z = f(x,y)
\end{eqnarray}
the sag $z$ being a function of $x$ and $y$.
In many cases, the sag equation is represented by the sum of an analytically solveable term, and a small perturbation.
Numerical solvers typically first calculate the intersection with the unperturbed surface analytically,
and then iteratively converge to the full solution.

The normal of a general free shape is
\begin{eqnarray}
 \Vector{n} &=& \frac{1}{\sqrt{ 1 + \left( \frac{\partial z}{\partial x} \right)^2 + \left( \frac{\partial z}{\partial y} \right)^2}}
 \begin{pmatrix}
  - \frac{\partial z}{\partial x}
  \\
  - \frac{\partial z}{\partial y}
  \\
  1
  \end{pmatrix} \label{eq:freeshape_normal}
\end{eqnarray}
The derivative of the normal with respect to $x$ and $y$ is
\begin{eqnarray}
 \frac{\partial \Vector{n}}{\partial x} &=&
  \left(
     \frac{\partial z}{\partial x} \frac{\partial^2 z}{\partial x^2}
   + \frac{\partial z}{\partial y} \frac{\partial^2 z}{\partial x \partial y}
  \right)
  \gamma^2 \Vector{n}
  +
  \frac{\partial^2 z}{\partial x^2} \gamma \Vector{e}_x
  +
  \frac{\partial^2 z}{\partial x \partial y} \gamma \Vector{e}_y
\\
 \frac{\partial \Vector{n}}{\partial y} &=&
  \left(
     \frac{\partial z}{\partial x} \frac{\partial^2 z}{\partial x \partial y}
   + \frac{\partial z}{\partial y} \frac{\partial^2 z}{\partial y^2}
  \right)
  \gamma^2 \Vector{n}
  +
  \frac{\partial^2 z}{\partial x \partial y} \gamma \Vector{e}_x
  +
  \frac{\partial^2 z}{\partial y^2} \gamma \Vector{e}_y
\\
  \gamma &=& \frac{1}{\sqrt{ 1 + \left( \frac{\partial z}{\partial x} \right)^2 + \left( \frac{\partial z}{\partial y} \right)^2}}
\end{eqnarray}
\remark{todo:check}


\subsection{Free Shape with Implicit Sag Formula}
\begin{eqnarray}
 f(x,y,z) &=& 0
\end{eqnarray}
todo

\subsection{Polynomial Even Asphere}

For a polynomial asphere the general form is
\begin{align}
  z &=  \frac
 { \rho ( x^2 + y^2 ) }
 { 1 + \sqrt{1 - (1+c) \rho^2  (x^2 + y^2)} } + A(x^2 + y^2)\,,
\end{align}
where $A$ is a polynomial of the ray height squared.
The appropriate equation to find the intersection point is given by [completing the square and so on]\remark{check!}
\begin{align}
 \left(z - A(x^2 + y^2) - \frac{1}{\rho(1+c)}\right)^2 - \frac{1}{\rho^2 (1+c)^2} \left(1 -(1+c)\rho^2 (x^2 + y^2) \right) &= 0\,.
\end{align}
In general, a solution can only be found numerically. 
Typical approaches in optical ray tracing use iterative algorithms.

\subsection{Strong Forbes Asphere}
todo
\subsection{Mild Forbes Asphere}
todo
\subsection{Acylindric}
todo


\subsection{Linear Combinations}
todo



\chapter{Wave Aberrations}
Despite its name suggests this representation of aberrations would be based on wave optics, its calculation is purely geometrical.
Wave aberrations are strongly related to the optical path difference.

\subsection{Optical path difference}
In a perfect lens (made of isotropic, lossless materials), all rays from one object point to an image point have the same optical path length, according to the law of Fermat. 
In systems with aberrations, the optical path length from object to image is different for rays passing different pupil positions.

The optical path difference $OPD$ is the optical path length minus the optical path length of the chief ray.
\begin{eqnarray}
 OPD(p_x,p_y) &=& L(p_x,p_y) - L(0,0)
\end{eqnarray}
For a certain fixed object field point, the optical path difference is often displayed as a function of pupil coordinates $p_x,p_y$.

For anisotropic or lossy materials, the Fermat law no longer holds, and a finite optical path difference from object to image is no more synonomous to aberrations.
In this case, the interpretation becomes more complex.

\subsection{Wave Aberrations}
To obtain the so called wave aberration, one first calculates the optical path difference from an object point to the image plane.
Then, a reference surface is constructed. 
Each point of the reference surface shall have the same optical path length to the chief ray image point.
For isotropic media, the reference surface becomes a sphere.
The radius of the sphere is chosen so that the surface intersects the optical axis at the exit pupil position, together with the chief ray.

All rays are then propagated backwards from the image to the reference surface.
The back-propagation is performed with the dispersion of the last material before the image, 
for example the image sided immersion liquid or the glass of a field lens glued onto the detector.
If there is an air gap between last lens and detector, the air dispersion is to be used.
In many cases, the back-propagation length is larger than the backfocal length of the system.

The wave aberrations are the optical path differences from object to exit pupil, 
that is the optical difference from object to image minus the path difference of the back-propagation.
By definition, the wave aberration of the chief ray is zero.
Typically, wave aberrations are displayed as a map over the two-dimensional exit pupil coordinates.
For imaging systems, the wave aberrations relative to the chief ray are typically very small, and are often displayed in units of vacuum wavelengths.

Using the Huygens principle, the field in the exit pupil can be interpreted as a set of point sources, radiating in the image direction. 
They form an Eikonal wavefront identical to that of the rays traced from object to image.
In technical optics, at this point often wave and ray optics are intermixed:
From the exit pupil to the image, a Huygens propagation is performed numerically exact in wave optics, resulting in a spot that cannot surpass the diffraction limit. 
The retardation of each point-source, however, is calculated using geometrical optics.
In a system without any aberrations made of isotropic materials, all point-sources are in phase and form a spherical wave segment, converging towards a spot of minimal spatial extent.
All aberrations cause a perturbation of the spherical wave, and an extended spot size.
The accuracy of the result compared to full physical wave-optical calculations of the point-spread function of the whole system is often astonishing. 

To reduce calculation times, the electric field map of the emitters in the curved exit pupil is often assumed planar and equidistant. 
The normalized ray coordinates in entrance and exit pupil are assumed to be identical.
A rectangular raster in the entrance pupil will thus result in a rectangular raster in the exit pupil.
Exit pupil and image are assumed Fourier-conjugate, allowing the use of fast Fourier methods.
The tremendous gain in speed is often worth the sacrifice in accuracy in optimisation tasks to get close to a diffraction limited system.
In the final optimisation step, it may be worth using the more accurate Huygens propagation method.

\begin{figure}
  \centering
   \includegraphics[width=0.5\columnwidth]{waveaberrations}
  \caption{a) In a perfect system, according to the Fermat principle, all rays have the same time of flight from the object to the image. b) In a real system, wave aberrations occur. A line of constant time of flight is displayed in magenta.
  Wave aberrations are the optical path differences corresponding to the difference in time of flight when hitting the exit pupil reference sphere.}
  \label{fig:waveaberrations}
\end{figure}

\subsection{Calculation of wave aberrations}
\remark{this only works for on axis field points}

Assume we know the position $x_{im}, y_{im}$ and direction $\Vector{d}$ of a set of rays in the image plane and their geometric path length from the object to the image.
To obtain the wave aberrations, we intersect the rays with the spherical exit pupil.
The task is similar to the intersections performed throughout the raytracing, see section \ref{subsection:spheres}.
We center our coordinate system around the chief ray image position.

\begin{eqnarray}
 \Location &=& \begin{pmatrix} x_0 \\ y_0 \\ 0 \end{pmatrix} + \Vector{d} t \\
 \Location^2 &=& R^2
\end{eqnarray}
with
 \begin{eqnarray}
 \begin{pmatrix} x_0 \\ y_0 \end{pmatrix} &=& \begin{pmatrix} x_{im} \\ y_{im} \end{pmatrix} - \begin{pmatrix} x_{chief,im} \\ y_{chief,im} \end{pmatrix} \\
 z_{im} &=& 0 \\
 | \Vector{d} | &=& 1
\end{eqnarray}
Here, $R$ is the distance between exit pupil and image, and $t$ is the geometric path length of the back-propagation.

We find
\begin{eqnarray}
 R^2 &=&  t^2 + 2 (d_x x_0 + d_y y_0) t + x_0^2 + y_0^2 \\
 t_{1,2} &=& - (d_x x_0 + d_y y_0) \pm \sqrt{ (d_x x_0 + d_y y_0)^2 - (x_0^2 + y_0^2) + R^2 }
\end{eqnarray}

We assume that the macroscopic distance between image and exit pupil $R^2$ term under the root is much larger than the microscopic aberrations and use a Taylor expansion
\begin{eqnarray}
 t_{1,2} &\approx& R - (d_x x_0 + d_y y_0) \pm 
 \left[ 
   \frac{1}{2R} \delta - \frac{1}{8R^3} \delta^2
 \right]
 \\
 \delta &=& (d_x x_0 + d_y y_0)^2 - x_0^2 - y_0^2
\end{eqnarray}

The geometric path length $t$ is inserted into the material dispersion to obtain the retardation between exit pupil and image. After that, this propagation length is subtracted from the optical path length from object to image.
Another subtraction of the chief ray value normalizes the result.
By didviding with the vacuum wavelength, we obtain the wave aberration in number of waves.


\bibliographystyle{unsrt}
\addcontentsline{toc}{chapter}{Bibliography}
\bibliography{pyrate}



\chapter{Nomenclature}
\begin{tabular}{l|l|l|l}
 Variable & Description & Type or Value & Unit \\
 \hline
 $A$ & element of an ABCD matrix & $\mathbb{R}$ & 1 \\
 $\hat{A}$ & sub-matrix of an XYUV matrix & matrix of $\mathbb{R}$ & 1 \\
 $\hat{A}$ & differential operator of the Helmholtz equation & tensor of $\mathbb{C}$ & $\frac{1}{\meter^2}$\\
 $a$ & polynomial or series coefficients & $\mathbb{R}$ or $\mathbb{C}$ & various\\
 \hline
 $\Bfield$ & magnetic flux density & pseudo-vector of $\mathbb{R}$ or $\mathbb{C}$ & $\tesla = \frac{\volt\second}{\meter^2} $\\
 $B$ & element of an ABCD matrix & $\mathbb{R}$ & \meter \\
 $\hat{B}$ & sub-matrix of an XYUV matrix & matrix of $\mathbb{R}$ & $\meter^2$ \\
 \hline
 $C$ & element of an ABCD matrix & $\mathbb{R}$ & 1/\meter\\
 $\hat{C}$ & sub-matrix of an XYUV matrix & matrix of $\mathbb{R}$ & 1/$\meter^2$\\
 $c_\vacuum$ & vacuum speed of light & 299792458 & \meter /\second \\
 $c$ & conic constant & $\mathbb{R}$ & 1 \\
 $c$ & polynomial or series coefficients & $\mathbb{R}$ or $\mathbb{C}$ & various\\
 \hline
 $\Dfield$ & electric displacement field & vector of $\mathbb{R}$ or $\mathbb{C}$ & $\frac{\ampere \second}{\meter^2}$\\
 $D$ & element of an ABCD matrix & $\mathbb{R}$ & 1\\
 $\hat{D}$ & sub-matrix of an XYUV matrix & matrix of $\mathbb{R}$ & 1\\
 $\Vector{d}$ & unit ray direction & vector of $\mathbb{R}$ or $\mathbb{C}$ & 1\\
 \hline
 $\Efield$ & electric field & vector of $\mathbb{R}$ or $\mathbb{C}$ & \volt /\meter \\
 $\Vector{e}$ & unit vector & vector of $\mathbb{R}$ or $\mathbb{C}$ & 1\\
 \hline
 $f$ & focal length & $\mathbb{R}$ & \meter \\
 $F$ & coefficient of intersection equation & $\mathbb{R}$ & 1\\
 \hline
 $\hat{G}$ & ray propagation operator &&\\
 $G$ & coefficient of intersection equation & $\mathbb{R}$ & \meter\\
 \hline
 $\Hfield$ & magnetic field & pseudo-vector of $\mathbb{R}$ or $\mathbb{C}$ & \ampere /\meter \\
 $H$ & Hamiltonian of geometric optics && \\
 $H$ & coefficient of intersection equation & $\mathbb{R}$ & 1/\meter \\
 \hline
 $I$ & intensity & $\mathbb{R}_{>0}$ & $\frac{\watt}{\meter^2}$ \\
 \hline
 $\currentdensity$ & current density & vector of $\mathbb{R}$ & $\frac{\ampere}{\meter^2}$ \\
 \hline
 $\Vector{K}$ & XYUV wavevector deviation from pilot & 4D-vector of $\mathbb{R}$ & 1/\meter \\
 $\Wavevector$ & wavevector & vector of $\mathbb{C}$ & 1/\meter \\
 \hline
 $L$ & optical path length & $\mathbb{R}$ & \meter \\
 $\mathcal{L}$ & Lagrangian of geometric optics &&\\
\end{tabular}\\
\begin{tabular}{l|l|l|l}
 Variable & Description & Type or Value & Unit \\
 \hline
 $M$ & mode index &\{ r1, r2, t1, t2 \}&\\
 $\hat{M}$ & intermediate matrix for XYUV calculus & matrix of $\mathbb{R}$ or $\mathbb{C}$ & various\\
 \hline
 $N$ & normalization constant for electric field & $\mathbb{C}$ & \volt /\meter \\
 \hline
 $\Vector{n}$ & surface normal unit vector & vector of $\mathbb{R}$ & 1\\
 $n$ & refractive index & $\mathbb{C}$ & 1\\
 \hline
 $R$ & radius of curvature & $\mathbb{R}$ & \meter \\
 $\Vector{R}$ & XYUV field coordinate & 2D-vector of $\mathbb{R}$ & \meter \\ 
 $\Vector{r}$ & location & vector of $\mathbb{R}$ & \meter \\
 \hline
 $\Vector{S}$ & Poynting vector & vector of $\mathbb{R}$ & $\frac{\watt}{\meter^2}$\\
 $s$ & arc length & $\mathbb{R}$ & \meter \\
 \hline
 $t$ & time & $\mathbb{R}$ & \second \\
 $t$ & straight parameter & $\mathbb{R}$ & \meter \\
 \hline
 $U,V$ & wavevector deviation from pilot ray & $\mathbb{C}$ & 1/\meter \\
 \volt & Volt & 1 & $\frac{\textrm{kg\,m}^2}{\textrm{A\,s}^3}$ \\
 \hline
 $x,y,z$ & cartesian coordinates & $\mathbb{R}$ & \meter \\
 $y$ & ABCD ray height & $\mathbb{R}$ & \meter \\
 $y^{\,\prime}$ & ABCD ray inclination& $\mathbb{R}$ & 1\\
 $z$ & surface sag & $\mathbb{R}$ & \meter \\
 \hline
 $X,Y$ & coordinates in tangential plane& $\mathbb{R}$ & \meter \\
 \hline
 $\alpha$ & mode index & $\{ 1, 2 \}$ & \\
 \hline 
 $\beta$ & mode index & $\{ r, t \}$ & \\
 \hline
 $\permittivity$ & electric permittivity & tensor of $\mathbb{R}$ or $\mathbb{C}$ & $\frac{\ampere \second}{\volt \meter}$ \\
 $\vacuumpermittivity$ & electric permittivity of vacuum & $8.8542...\cdot 10^{-12}$ & $\frac{\ampere \second}{\volt \meter}$ \\
 $\relativepermittivity$ & relative permittivity & tensor of $\mathbb{R}$ or $\mathbb{C}$ & 1\\
 \hline
 $\lambda$ & wavelength & $\mathbb{R}_{>0}$ & \meter \\
 \hline
 $\permeability$ & magnetic permeability & tensor of $\mathbb{R}$ & $\frac{\volt \second}{\ampere \meter}$ \\
 $\vacuumpermeability$ & magnetic permeability of vacuum & $4\pi \cdot 10^{-7}$ & $\frac{\volt \second}{\ampere \meter}$ \\
 $\relativepermeability$ & relative permeability & tensor of $\mathbb{R}$ & 1\\
 \hline
 $\chargedensity$ & charge density & $\mathbb{R}$ & $\frac{\ampere \second}{\meter^3}$ \\
 $\rho$ & surface curvature & $\mathbb{R}$ & 1/\meter \\
 \hline
 $\conductivity$ & conductivity & tensor of $\mathbb{R}$ & $\frac{\ampere}{\volt\meter}$\\
 \hline
 $\varsigma$ & sign prefactor & $\pm 1$ & \\
 \hline
 $\theta$ & angle of incidence relative to normal & $\mathbb{R}$ & rad \\
 \hline
 $\xi$ & wavevector normal component & $\mathbb{C}$ & 1/\meter \\
 \hline
 $\omega$ & angular frequency & $\mathbb{R}_{>0}$ & 1/\second
\end{tabular}

\chapter{Some Math Notes}
\section{Rotating Coordinate Systems (Rodrigues Formula)}
We assume two right handed cartesian coordinate systems,
$(\Vector{e}_x,\Vector{e}_y,\Vector{e}_z)$ and 
$(\tilde{\Vector{e}}_x,\tilde{\Vector{e}}_y,\tilde{\Vector{e}}_z)$.
We want to convert the coordinate representation of a vector $\Vector{a}$ from one system to the other.
\begin{eqnarray}
\Vector{a} = x \Vector{e}_x + y \Vector{e}_y + z \Vector{e}_z &=& \tilde{x} \tilde{\Vector{e}}_x + \tilde{y} \tilde{\Vector{e}}_y + \tilde{z} \tilde{\Vector{e}}_z
\\
\begin{pmatrix}  x \\ y \\ z \end{pmatrix}
&=&
\hat{R} \begin{pmatrix}  \tilde{x} \\ \tilde{y} \\ \tilde{z} \end{pmatrix}
\end{eqnarray}
The coordinate transformation matrix $\hat{R}$ was found by Olinde Rodrigues 
and is known as Rodrigues formula [rodrigues:1815].
When rotating around the axis $\Vector{e}_{r}$ by the angle $\vartheta$, the coordinate transform is
\begin{eqnarray}
    \hat{R} &=& 
    \unittensor + \sin(\vartheta)
      \begin{pmatrix}
        0    & -e_{rz} &  e_{ry} \\
        e_{rz} &     0 & -e_{rx} \\
        -e_{ry} &  e_{rx} &    0                                     
      \end{pmatrix}
    + (1 - \cos(\vartheta))
    \left[
      \begin{pmatrix}
        0    & -e_{rz} &  e_{ry} \\
        e_{rz} &     0 & -e_{rx} \\
        -e_{ry} &  e_{rx} &    0                                     
      \end{pmatrix}^2
    \right]\nonumber\\\label{eq:rodgrigues_formula}
\end{eqnarray}
where the axis $\Vector{e}_r$ is a unit vector.
The matrix in the sine term is fully antisymmetric and represents the cross product with $\Vector{e}_r$.
In the cosine term, the same matrix is squared.
From the Rodrigues formula follow some special cases:
\begin{align}
 \text{rotation about $\Vector{e}_x$:} && 
   \hat{R}_x &= 
   \begin{pmatrix}
     1 & 0 & 0 \\
     0 & \cos \vartheta & -\sin \vartheta \\
     0 & \sin \vartheta &  \cos \vartheta
   \end{pmatrix} \label{eq:rodrigues_x}
 \\
 \text{rotation about $\Vector{e}_y$:} && 
   \hat{R}_y &= 
   \begin{pmatrix}
   \cos \vartheta & 0 & \sin \vartheta \\
   0 & 1 & 0 \\
   -\sin \vartheta & 0 & \cos \vartheta
   \end{pmatrix} \label{eq:rodrigues_y}
 \\
 \text{rotation about $\Vector{e}_z$:} && 
   \hat{R}_z &= 
   \begin{pmatrix}
     \cos \vartheta & -\sin \vartheta & 0 \\
     \sin \vartheta & \cos \vartheta & 0 \\
     0 & 0 & 1
   \end{pmatrix} \label{eq:rodrigues_z}
\end{align}
Rodrigues matrices do not commutate.


\section{Determining Orthogonal Vectors} \label{sec:ortho_vectors}
Assume we have a given unit vector $\Vector{e}_0 \in \mathbb{C}^3$
and we want and want to determine vectors orthogonal to it $\Vector{e}_{\perp}$.

We start with an orthogonal, cartesian base $\Vector{e}_x, \Vector{e}_y, \Vector{e}_z$.
Next we search for an unitary matrix $\hat{R}$ that transforms $\Vector{e}_z$ to $\Vector{e}_1$.
\begin{eqnarray}
 \Vector{e}_0 &=& \hat{R} \Vector{e}_z \\
 \hat{R}^\dagger &=& \hat{R}^{-1}
\end{eqnarray}
We build up this transformation $\hat{R}$ from multiple steps.

\subsection{Step 0}
Check whether $\Vector{e}_0$ is a unit vector.
\begin{eqnarray}
 e_{0i} \overline{e}_{0i} &=& 1
\end{eqnarray}
The transformation cannot change the length of a vector.

\subsection{Step i}
Form a vector from the absolute of each component of the target vector $\Vector{e}_0$.
\begin{eqnarray}
 \Vector{a} &=&
 \begin{pmatrix}
  \sqrt{ e_{0x} \overline{e}_{0x} } \\
  \sqrt{ e_{0y} \overline{e}_{0y} } \\
  \sqrt{ e_{0z} \overline{e}_{0z} }
 \end{pmatrix}
\end{eqnarray}
We assume a Rodrigues matrix that rotates around $x$ and apply it on $\Vector{e}_z$.
We call the result $\Vector{b}$.
\begin{eqnarray}
 \begin{pmatrix}
  b_x \\ b_y \\ b_z
 \end{pmatrix}
 &=&
 \hat{R}_x(\vartheta_x) \Vector{e}_z
\end{eqnarray}
We choose the angle of rotation in a way that $b_z = a_z$.
\begin{eqnarray}
 \vartheta_x &=& \arccos(a_z)
\end{eqnarray}
With this, the $z$ component of $\Vector{b}$ has the same absolute as our target vector $\Vector{e}_0$.
To also match the other components, we have to apply further steps:

\subsection{Step ii}
We start from the intermediate result $\Vector{b}$ and rotate it around $z$.
\begin{eqnarray}
  \begin{pmatrix}
  c_x \\ c_y \\ c_z
 \end{pmatrix}
 &=&
 \hat{R}_z(\vartheta_z) 
 \begin{pmatrix}
  b_x \\ b_y \\ a_z
 \end{pmatrix}
\end{eqnarray}
We choose the angle of rotation in a way that $c_x = a_x$.
\begin{eqnarray}
 c_x &=& b_x \cos \vartheta_z - b_y \sin \vartheta_z \\
     &=& 0 \cdot \cos \vartheta_z + \sin \vartheta_x \sin \vartheta_z \\
 \vartheta_z &=& \arcsin\left(\frac{a_x}{\sin \vartheta_x}\right)
\end{eqnarray}
With the $x$ and $z$ component being equal, also the third component of the unit vector $\Vector{c}$ is equal to $\Vector{a}$,
up to a sign prefactor.
\begin{eqnarray}
 \begin{pmatrix}
  c_x \\ c_y \\ c_z
 \end{pmatrix}
 =
 \begin{pmatrix}
  a_x \\ \pm a_y \\ a_z
 \end{pmatrix}
 &=& \hat{R}_z(\vartheta_z) \hat{R}_x(\vartheta_x) \Vector{e}_z
\end{eqnarray}
We have found a transformation that transforms the start vector $\Vector{e}_z$ to a vector 
that has the same absolute of its components like the target vector $\Vector{e}_0$.
To obtain the target vector $\Vector{e}_0$, the sign of each component has to be matched.
For complex valued target vectors, also the complex phase has to be matched.

\subsection{Step iii}
We consider the unitary matrix
\begin{eqnarray}
 \hat{R}_\varphi &=&
 \begin{pmatrix}
  e^{i\varphi_x} & 0 & 0 \\
  0 & e^{i\varphi_y} & 0 \\
  0 & 0 & e^{i\varphi_z} 
 \end{pmatrix} \label{eq:unitary_phase_rot}
\end{eqnarray}
and choose the phase factors $e^{i \varphi_j}$ so that
\begin{eqnarray}
 e^{i \varphi_j} &=& \frac{e_{0j}}{|e_{0j}|} \cdot \text{sign}(c_j)
\end{eqnarray}
We apply all matrices on the start vector and end up with the desired target vector.
\begin{eqnarray}
 \Vector{e}_0 &=& \hat{R}_\varphi \cdot \hat{R}_z \cdot \hat{R}_x \cdot \Vector{e}_z \\[2ex]
 \Vector{e}_0 &=& \hat{R} \Vector{e}_z 
\end{eqnarray}
The individual matrices are defined in \eqref{eq:rodrigues_x}, \eqref{eq:rodrigues_z}, and \eqref{eq:unitary_phase_rot}.
The angles of rotation are defined above in this section.
The product of unitary matrices is again unitary.
The unitarity conserves scalar products, so it conserves orthogonality.
We find $\Vector{e}_0$ and the orthogonal vectors
\begin{eqnarray}
 \Vector{e}_0 &=& \hat{R} \Vector{e}_z \\
 \Vector{e}_{\perp1} &=& \hat{R} \Vector{e}_x \\
 \Vector{e}_{\perp2} &=& \hat{R} \Vector{e}_y
\end{eqnarray}
With $\Vector{e}_\perp$, also $e^{i\phi} \cdot \Vector{e}_\perp$ is orthogonal, in particular with $\phi = \tfrac{\pi}{2}$.




\end{document}
